// ==UserScript==
// @name         冰蛙宝鉴
// @namespace    SMTH
// @version      3.4.12
// @description  随时随地通过API接口看你想看！
// @author       bingri[1523812] kaeru[1769499] htys[1545351] mirrorhye[2564936] tobytorn[1617955] Microdust[2587304] SoftRabbit[2776069]
// @match        https://www.torn.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM.xmlHttpRequest
// @connect      *
// @connect      tornsmth.website
// @require      https://cdn.staticfile.org/xlsx/0.17.5/xlsx.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.2/jquery.min.js
// @require      https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js
// @updateURL    https://raw.githubusercontent.com/zmpress/game_script/refs/heads/main/porn_city/userscript/bingwa.js
// @downloadURL    https://raw.githubusercontent.com/zmpress/game_script/refs/heads/main/porn_city/userscript/bingwa.js
// ==/UserScript==
function bingwaMain(){"use strict";if(window.BINGWA)return;window.BINGWA=!0,console.log("冰蛙启动");const t=window.jQuery;!function(t,e,n,a){var o="tornInputMoney";function i(i,r){var s=i,l=t(i);t.fn[o].defaults={version:"1.0",symbol:"$",showSymbolButton:!0,errorClass:"error",successClass:"success",groupMoneyClass:"input-money-group",symbolMoneyClass:"input-money-symbol",inputMoneyClass:"input-money",inputHiddenMoneyClass:"",buttonElement:t(".torn-btn"),buttonDisabledClass:"disabled",buttonDisabledAttribute:"disabled",moneySourceData:"data-money",title:"Click here to add the maximum amount, or use shortcuts like <br /> 5k, 1.5m, max, half, quarter, 1/2, 1/3, 1/4, 25%",strictMode:!0,ajaxAction:null,disabled:!1,disabledAutoCorrect:!0,allowNegativeNumbers:!1,skipBlurCheck:!1,minValue:"data-minvalue",onInit:function(){},onDestroy:function(){}};var d=(r=t.extend({},t.fn[o].defaults,r)).allowNegativeNumbers?"[-]?":"",c={digit:function(t){var e=new RegExp("^("+d+"[1-9]\\d*)$","i"),n=t||l.val(),a=e.exec(n);return a?a[1]:null},float:function(t){var e=new RegExp("^("+d+"[1-9]\\d*(?:[,]\\d{3})*)(?:[.]\\d{10})?$","i"),n=t||l.val(),a=e.exec(n);return a?a[1]:null},all:function(t){var e=t||l.val(),n=/^(all|max){1}$/i.exec(e),a=l.attr(r.moneySourceData);return n&&a?a:null},thousand:function(t){var e=new RegExp("^("+d+"\\d+[.]?(\\d{1,3})?)k$","i"),n=t||l.val(),a=e.exec(n);return a?Math.round(1e3*a[1]):null},million:function(t){var e=new RegExp("^("+d+"\\d+[.]?(\\d{1,6})?)m$","i"),n=t||l.val(),a=e.exec(n);return a?Math.round(1e6*a[1]):null},billion:function(t){var e=new RegExp("^("+d+"\\d+[.]?(\\d{1,9})?)b$","i"),n=t||l.val(),a=e.exec(n);return a?Math.round(1e9*a[1]):null},quarter:function(t){var e=t||l.val(),n=/^(1\/4|quarter){1}$/i.exec(e),a=l.attr(r.moneySourceData);return n&&a?Math.round(parseInt(a)/4):null},third:function(t){var e=t||l.val(),n=/^(1\/3){1}$/i.exec(e),a=l.attr(r.moneySourceData);return n&&a?Math.round(parseInt(a)/3):null},half:function(t){var e=t||l.val(),n=/^(1\/2|half){1}$/i.exec(e),a=l.attr(r.moneySourceData);return n&&a?Math.round(parseInt(a)/2):null},percent:function(t){var e=t||l.val(),n=/^([1-9][0-9]?|100)%$/i.exec(e),a=l.attr(r.moneySourceData);return n&&a?Math.round(parseInt(a)*n[1]/100):null},firstZero:function(t){var e=t||l.val(),n=/^([0])/i.exec(e),a=l.attr(r.moneySourceData),o=a?parseInt(a.replace(/,/g,"")):null;return n&&0==o?n[1]:null},zero:function(t){var e=t||l.val(),n=/^([0])$/i.exec(e);return n&&!r.strictMode?n[1]:null},fraction:function(t){var e=t||l.val(),n=/^(([1-9])\/([2-9]|10))$/i.exec(e),a=l.attr(r.moneySourceData);return n&&a&&parseInt(n[2])<parseInt(n[3])?Math.round(parseInt(a)*n[2]/n[3]):null}};function p(t){return 65==t.which||17==t.which&&!t.ctrlKey||(91==t.which||224==t.which)&&!t.metaKey}function h(){return r.ajaxAction?t.ajax({method:"POST",url:addRFC(r.ajaxAction),success:function(t){var e=f("onMoneyUpdate",t)||t;l.attr(r.moneySourceData,e),l.next().filter('input[type="hidden"].'+r.inputMoneyClass).attr(r.moneySourceData,e)}}):Promise.resolve()}function f(t,e){var n=e||{};if(r[t]!==a)return r[t].call(s,n)}function u(){var n,a,o,i,s,d=l.val().replace(/,/g,"");if(t.each(c,function(e,a){if(d=t.trim(d),(n=a.call(this,d))||0==n){var o=parseInt(n.toString().replace(/,/g,"")),i=l.attr(r.moneySourceData),s=i?parseInt(i.replace(/,/g,"")):null;return(s||0==s)&&o>=s&&(o=s),d=o.toString().replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g,"$1,"),l.next().val(o),!1}}),l.val()!=d){var p=l.get(0);Object.getOwnPropertyDescriptor(e.HTMLInputElement.prototype,"value").set.call(p,d);try{p.dispatchEvent(new Event("input",{bubbles:!0}))}catch(t){console.error("Couldn't dispatch the event")}i=t.data(l,"selection_length")||0,s=t.data(l,"old_length")-t.data(l,"old_position"),a=(o=l.get(0).value.length-s+i)<0?0:o,l.each(function(t,e){if(e.setSelectionRange)e.setSelectionRange(a,a);else if(e.createTextRange){var n=e.createTextRange();n.collapse(!0),n.moveEnd("character",a),n.moveStart("character",a),n.select()}}),t.data(l,"selection_length",0)}var h=l.closest("."+r.groupMoneyClass).removeClass(r.successClass).removeClass(r.errorClass),f=r.buttonElement,u=l.attr(r.minValue),g=u?parseInt(u.replace(/,/g,"")):null;const b=(g||0==g)&&d<g;!n||0==n&&r.strictMode||b?d.length>0&&(h.addClass(r.errorClass),f&&f.addClass(r.buttonDisabledClass),f&&f.prop(r.buttonDisabledAttribute,!0)):(h.addClass(r.successClass),f&&f.removeClass(r.buttonDisabledClass),f&&f.prop(r.buttonDisabledAttribute,!1))}return l.each(function(){var o=t(this),i=o.attr("disabled")||r.disabled;o.attr("disabled",i),o.attr("data-lpignore",!0),i&&o.attr("readonly",!0),r.disabledAutoCorrect&&(o.attr("autocomplete","off"),o.attr("autocorrect","off"),o.attr("autocapitalize","off"),o.attr("spellcheck","false"));var c=t("<input/>").attr("type","button").addClass("wai-btn").attr("aria-label",r.title),g=t("<span/>").attr("title",r.title).addClass(r.symbolMoneyClass).html(r.symbol).append(c),b=t("<div/>").addClass(r.groupMoneyClass+(i?" disabled":"")),m=o.wrap(b).parent();o.addClass(r.inputMoneyClass);var y=o.clone();y.attr("type","hidden"),o.after(y),y.addClass(r.inputHiddenMoneyClass),o.attr("name",null);var x=o.attr(r.moneySourceData);x?(o.attr(r.moneySourceData,x.replace(/([,\.])/g,"")),r.showSymbolButton&&g.prependTo(m)):m.addClass("no-max-value"),o.on("input",function(t){var e=l.val();if(r.buttonElement&&(l.val()?(r.buttonElement.removeClass(r.buttonDisabledClass),r.buttonElement.prop(r.buttonDisabledAttribute,!1)):(r.buttonElement.addClass(r.buttonDisabledClass),r.buttonElement.attr(r.buttonDisabledAttribute,!0))),function(){var t=l.closest("."+r.groupMoneyClass);l.val()&&t.removeClass(r.errorClass)}(),e){var n=new RegExp("("+d+"[0-9,\\.]*)").exec(e),a=n&&n.input===n[0],o=parseInt(e.replace(/,/g,"")),i=l.attr(r.moneySourceData),s=i?parseInt(i.replace(/,/g,"")):null,c=s&&o>s;a&&!c||c&&h().then(u)}else l.closest("."+r.groupMoneyClass).removeClass(r.successClass),l.closest("."+r.groupMoneyClass).removeClass(r.errorClass);"0"!==e&&""!==e||l.next().val(e),u();var p=l.closest("."+r.groupMoneyClass);f("onAfterChange",{value:l.val(),error:p.hasClass(r.errorClass)}),t.preventDefault()}),o.on("keydown",function(e){p(e)||(t.data(l,"old_position",function(){var t=0,e=l.get(0);if(n.selection){e.focus();var a=n.selection.createRange(),o=n.selection.createRange().text.length;a.moveStart("character",-e.value.length),t=a.text.length-o}else(e.selectionStart||"0"==e.selectionStart)&&(t=e.selectionStart);return t}()),t.data(l,"old_length",l.get(0).value.length))}),o.on("select",function(e){var a,o,i,r,d,c,h;p(e)||t.data(l,"selection_length",(c=0,h=0,"number"==typeof s.selectionStart&&"number"==typeof s.selectionEnd?(c=s.selectionStart,h=s.selectionEnd):(o=n.selection.createRange())&&o.parentElement()==s&&(r=s.value.length,a=s.value.replace(/\r\n/g,"\n"),(i=s.createTextRange()).moveToBookmark(o.getBookmark()),(d=s.createTextRange()).collapse(!1),i.compareEndPoints("StartToEnd",d)>-1?c=h=r:(c=-i.moveStart("character",-r),c+=a.slice(0,c).split("\n").length-1,i.compareEndPoints("EndToEnd",d)>-1?h=r:(h=-i.moveEnd("character",-r),h+=a.slice(0,h).split("\n").length-1))),h-c))}),o.closest("."+r.groupMoneyClass).find("."+r.symbolMoneyClass).on("click",function(t){i||o.attr("readonly")!==a||h().then(function(){o.val("max"),u(),f("onAfterMoneyUpdate")})}),o.val()?u():(r.buttonElement&&r.buttonElement.addClass(r.buttonDisabledClass),r.buttonElement&&r.buttonElement.prop(r.buttonDisabledAttribute,!0)),t(e).focus(function(){}),f("onInit")}),{option:function(t,e){if(!e)return r[t];r[t]=e},destroy:function(){l.each(function(){var e=t(this),n=e.clone(),a=e.parent();n.removeClass(r.inputMoneyClass),a.before(n),e.parent().remove(),f("onDestroy"),e.removeData("plugin_"+o)})},format:u,addRules:function(e,n){var a={};a[e]=n,c=t.extend(c,a)}}}t.fn[o]=function(e){if("string"==typeof arguments[0]){var n,r=arguments[0],s=Array.prototype.slice.call(arguments,1);return this.each(function(){if(!t.data(this,"plugin_"+o)||"function"!=typeof t.data(this,"plugin_"+o)[r])throw new Error("Method "+r+" does not exist on jQuery."+o);n=t.data(this,"plugin_"+o)[r].apply(this,s)}),n!==a?n:this}if("object"==typeof e||!e)return this.each(function(){t.data(this,"plugin_"+o)||t.data(this,"plugin_"+o,new i(this,e))})}}(t,window,document);const e=Object.freeze({GM:"gm",PDA:"pda",OTHER:"other"});let n=e.OTHER;"function"==typeof GM_xmlhttpRequest?n=e.GM:"object"==typeof GM&&"function"==typeof GM.xmlHttpRequest?(n=e.GM,window.GM_xmlhttpRequest=GM.xmlHttpRequest):"function"==typeof PDA_httpGet&&(n=e.PDA);const a=[{name:"foo",title:"阅兵助手",desc:"在部分页面显示阅兵按钮，可以快速获取玩家信息",default:!1},{name:"noAssisting",title:"防打重",desc:"如果已有其他人进入战斗则屏蔽JOIN按钮",default:!1},{name:"mugoo",title:"山贼助手",desc:"在市场列表界面显示用户状态和攻击链接",default:!0},{name:"travelFilter",title:"飞花过滤",desc:"在海外市场页面屏蔽不重要物品",default:!0},{name:"jailView",title:"监狱助手",desc:"在监狱页面屏蔽分数大于10000的目标，本帮人员置顶高亮显示",default:!0},{name:"stockexchange_show_abbr",title:"股票助手",desc:"在股票交易市场页面的股票名称前显示缩写",default:!0},{name:"gym_show_ratio",title:"健身房助手",desc:"在健身房页面显示推荐的属性比例",default:!0},{name:"common_modify_header_links",title:"顶部快捷入口",desc:"在页面顶部添加一些常用页面的链接",default:!0},{name:"hide_cloud_while_flying",title:"飞行无云",desc:"在飞行界面隐藏飞机和云彩",default:!0},{name:"withdrawal_helper",title:"取钱助手",desc:"右下角聊天people框高亮显示帮派可取钱名单",default:!0},{name:"bigger_screen_on_laptop",title:"laptop大屏",desc:"飞行中使用笔记本电脑时可以全屏显示",default:!0},{name:"taking_off_reminder",title:"起飞吃药提醒",desc:"起飞前根据CD提醒吃药和OC",default:!0},{name:"bounty_parade",title:"悬赏阅兵",desc:"报纸-悬赏页面显示目标BS",default:!1},{name:"nurse_suggestion",title:"护士建议",desc:"智能提醒出院吃药",default:!0},{name:"nurse_suggestion_out_of_hospital",title:"远程护士建议",desc:"不在医院内只要血不满就显示护士建议",default:!1},{name:"extra_recent_attacks",title:"更多最近攻击(帮派)",desc:"帮派chain页面显示更多5分钟内攻击记录(减少错过的复仇)",default:!1},{name:"shows_bingwa_icon",title:"显示冰蛙图标",desc:"在侧边栏显示冰蛙图标，可以作为冰蛙的快速入口",default:!0},{name:"wawa_detection_cache",title:"蛙蛙探测缓存",desc:"缓存蛙蛙探测结果30秒",default:!0}];a.forEach(t=>{let e=C("BWM_SETTINGS",t.name);null==e&&M("BWM_SETTINGS",t.name,String(t.default)),window[t.name]="true"==C("BWM_SETTINGS",t.name)});let o=localStorage.getItem("APIKey");const i={20465:"SMTH - Phoenix Nirvana",36134:"SMTH - Silver Hand",10741:"SMTH - Trisolary",16335:"SMTH - November Chopin",16424:"SMTH - HoYoverse",9356:"SMTH - Party Animals",27902:"SMTH - Concord",11796:"SMTH - Bright Summit",14633:"SMTH - Hermit Sage",2095:"SMTH - Healing Pulse"},r={8836:"Vinerri",2095:"Guerrilla Warfare",11356:"-UGK-",31312:"TORNado",8255:"Scream Silence",26312:"The Avengers",28205:"Invictus",10913:"Unbroken Warriors",8510:"Ara Pacis",5113:"ThugLife",13343:"The Defiant",39756:"Abusement Park",38761:"Shadow Healers",42125:"Octogenarian DirtyBombers",35739:"Kingsmen",14820:"Unbroken Legion",10140:"In Memory of the Fallen",9405:"Lake Of Lerna",30085:"Rampage Total Destruction"},s="#adadad",l="#ff7373",d="#8fbc8f",c="#65a5d1",p="#8d6dd7",h="#f39826",f="#83a000",u="#e467b3",g="#F9CDAD";function b(t){(document.getElementById("BINGWA-GLOBAL-STYLE")||function(){const t=document.createElement("style");return t.type="text/css",t.id="BINGWA-GLOBAL-STYLE",document.head.appendChild(t),t}()).sheet.insertRule(t)}function m(t){return Number(t.replace(/,/g,""))}function y(t){return t.toString().indexOf(",")>=0?m(t):Number.isNaN(Number(t))?0:t.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","})}function x(t){return t.toString().indexOf("$")>=0?Number(t.replace(/\$|,/g,"")):Number.isNaN(Number(t))?0:t.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","}).replace(/^[^\$]\S+/,function(t){return"$"+t})}function v(t){return t<0?"-"+v(-t):0==t?"0":t<=1?(100*t).toFixed(2)+"%":t<1e3?""+parseInt(t):t>=1e3&&t<1e6?(t/1e3).toFixed(2)+"k":t>=1e6&&t<1e9?(t/1e6).toFixed(2)+"m":t>=1e9&&t<1e12?(t/1e9).toFixed(2)+"b":t>=1e12&&t<1e15?(t/1e12).toFixed(2)+"t":t>=1e15&&t<1e18?(t/1e15).toFixed(2)+"q":t>=1e18?"MAX":void 0}function w(t){return t<0?"-"+w(-t):0==t?"0":t<=1?parseFloat((100*t).toFixed(2))+"%":t<1e3?""+parseInt(t):t>=1e3&&t<1e6?parseFloat((t/1e3).toFixed(2))+"k":t>=1e6&&t<1e9?parseFloat((t/1e6).toFixed(2))+"m":t>=1e9&&t<1e12?parseFloat((t/1e9).toFixed(2))+"b":t>=1e12&&t<1e15?parseFloat((t/1e12).toFixed(2))+"t":t>=1e15&&t<1e18?parseFloat((t/1e15).toFixed(2))+"q":t>=1e18?"MAX":"error"}function _(t){return"[object Array]"===Object.prototype.toString.call(t)?t:"[object Object]"===Object.prototype.toString.call(t)?Object.values(t):null}function k(t){let e=_(t);if(null==e||e.length<=0)return null;if(function(t){return"[object Array]"===Object.prototype.toString.call(t)&&!(t.length<=1)&&"[object Object]"===Object.prototype.toString.call(t[0])&&Object.keys(t[0]).length>0}(e))return e;for(let t=0;t<e.length;++t){let n=k(e[t]);if(null!=n)return console.log(`在第 ${t} 个节点发现有效数据集`),n}return null}function $(t,e){let n=t[e];if("object"==typeof n){for(let a in n){let o=n[a];"object"==typeof o?I(n):t[a+"_"+e]=o}delete t[e]}}function I(t){for(let e in t)$(t,e)}function S(t){let e=t[0];I(e);let n=Object.keys(e);console.log(`item_keys: ${n}`);for(let e=1;e<t.length;++e){let a=t[e];I(a);let o=Object.keys(a);for(let t=0;t<o.length;t++){let e=o[t];console.log(`add item_key: ${e}`),-1==n.indexOf(e)&&n.push(e)}}let a=n.sort().join(",");for(let e=0;e<t.length;++e){a+="\n";let o=t[e];I(o);for(let t=0;t<n.length;++t){let e=o[n[t]]+"";"object"==typeof e&&(e=JSON.stringify(e)),e='"'+e.replace(/<[^>]+>/g,"").trim().replace(/\"/g,'""')+'"',t>0&&(a+=","),a+=e}}return encodeURIComponent(a)}function D(t){if(void 0!==window.localStorage){if(null===window.localStorage.getItem(t))return null;return JSON.parse(window.localStorage.getItem(t))}}function C(t,e){const n=D(t);return void 0===n?void 0:null===n?null:void 0===n[e]?void 0:n[e]}function A(t,e){void 0!==window.localStorage&&window.localStorage.setItem(t,JSON.stringify(e))}function M(t,e,n){if(void 0!==window.localStorage)if(null===window.localStorage.getItem(t)){let a={};a[e]=n,window.localStorage.setItem(t,JSON.stringify(a))}else{let a=JSON.parse(window.localStorage.getItem(t));a[e]=n,window.localStorage.setItem(t,JSON.stringify(a))}}function T(t,e){if(void 0!==window.localStorage){if(null===window.localStorage.getItem(t))return null;{const n=JSON.parse(window.localStorage.getItem(t));if(void 0===n[e])return;delete n[e],window.localStorage.setItem(t,JSON.stringify(n))}}}function F(e,n){e.click(function(){t(this).siblings().each(function(){const e=t(this).text().replace(/[↑↓]/,"");t(this).text(e),t(this).removeAttr("sort")});const a=t(this).text().replace(/[↑↓]/,"");let o="",i="";"TH"==e[0].tagName?(o=e.parent().siblings(),i=e.parent().parent()):(o=e.parent().next().children(),i=e.parent().next()),"descend"==t(this).attr("sort")?(o.sort(function(t,e){const a=n(t),o=n(e);return isNaN(a)?a.localeCompare(o):a-o}),o.detach().appendTo(i),t(this).attr("sort","ascend").text(a+"↑")):(o.sort(function(t,e){const a=n(t),o=n(e);return isNaN(a)?o.localeCompare(a):o-a}),o.detach().appendTo(i),t(this).attr("sort","descend").text(a+"↓"))})}function O(t,e,n,a,o){return`\n<div style="position:relative; top:0; width:100%; height:${t-4}px; color:${n}; background-color:${a}; padding:2px 0px; text-align:center;">${o}</div>\n<div style="position:relative; top:-${t}px; width:100%; left:${e-100}%; height:${t-4}px; padding:2px 0px; z-index:2; overflow:hidden;">\n<div style="position:absolute; top:0; width:100%; left:${100-e}%; height:${t-4}px; color:${a}; background-color:${n}; padding:2px 0px; text-align:center;">${o}</div>\n</div>`}function E(e,n){return t(e).on("input keydown keyup mousedown mouseup select contextmenu drop focusout",function(t){n(this.value)?this.oldValue=this.value:this.hasOwnProperty("oldValue")?this.value=this.oldValue:this.value=""})}function N(t,e,n){if(wawa_detection_cache){const n=function(t){const e=Math.floor(Date.now()/1e3),n=D("wawa_detection_cache")??{};let a=!1;for(const[t,o]of Object.entries(n))o.ts<=e-30&&(delete n[t],a=!0);return a&&A("wawa_detection_cache",n),n[t]}(t);if(n)return void e(n)}fetch(`https://api.torn.com/user/${t}?selections=profile,crimes,personalstats,bazaar&key=${o}`).then(t=>{if(t.ok)return t.json();n("蛙蛙探测失败，请刷新重试")},t=>{n("蛙蛙探测失败，网络异常，请刷新重试")}).then(a=>{if(null==a)return;if(a.hasOwnProperty("error"))return void n(`蛙蛙探测失败：${JSON.stringify(a,null,4)}`);const o=a.personalstats,i=o.defendslost||0,r=o.defendsstalemated||0,s=o.defendswon||0,l=o.attackswon||0,d=o.attacksdraw||0,c=o.attackslost||0,p=o.cantaken||0,h=o.exttaken||0,f=o.kettaken||0,u=o.lsdtaken||0,g=o.opitaken||0,b=o.pcptaken||0,m=o.shrtaken||0,y=o.spetaken||0,x=o.victaken||0,_=o.xantaken||0,k=o.booksread||0;a.energydrinkused=o.energydrinkused,a.booksread=k;const $=a.age||1,I=o.trainsreceived||0,S=(_/$).toFixed(2);a.average_drugs=S;const C=o.refills||0,M=o.statenhancersused||0,T=o.useractivity||0,F=o.traveltime||0,O=(o.logins,o.dumpsearches||0),E=o.energydrinkused||0,N=o.boostersused||0,P=o.revives||0,R=l+d+c,j=o.daysbeendonator||0,z=Math.min($,parseInt((new Date-new Date("2011/11/22"))/864e5)),B=Math.min(j/z,1);a.donator_percent=B.toFixed(2);const L=480+240*B,W=611255/L,G=a.last_action.timestamp||0;let H=parseInt((new Date).getTime()/1e3)-G,U="";H>86400&&(U+=parseInt(H/86400)+"天",H%=86400),H>3600&&(U+=parseInt(H/3600)+"时",H%=3600),H>60&&(U+=parseInt(H/60)+"分",H%=60),U+=H+"秒",a.last_action_details=U;const q=a.last_action.relative;a.last_action_brief=q.replace(" minute ago","m").replace(" minutes ago","m").replace(" hours ago","h").replace(" hour ago","h").replace(" days ago","d").replace(" day ago","d");let X=0;q.includes("d")&&(X=parseInt(q.replace(/[^0-9|-]/gi,"")));const J=Math.max(1,21*($-X)/24),K=3*(T/86400)+F/86400,Y=(75*p+210*h+52.5*f+425*u+215*g+430*b+209.5*m+301*y+300*x+420*_)/1440,V=a.criminalrecord.hasOwnProperty("vandalism");let Q=5*(2*((V?.1*a.criminalrecord.theft:a.criminalrecord.other)||0)+3*((V?a.criminalrecord.counterfeiting:a.criminalrecord.selling_illegal_products)||0)+5*((V?.65*a.criminalrecord.theft:a.criminalrecord.theft)||0)+8*((V?a.criminalrecord.illicitservices/2:a.criminalrecord.drug_deals)||0)/.8+9*((V?a.criminalrecord.cybercrime:a.criminalrecord.computer_crimes)||0)/.75+10*((V?a.criminalrecord.illicitservices/2:a.criminalrecord.murder)||0)/.75+11*((V?a.criminalrecord.fraud:a.criminalrecord.fraud_crimes)||0)/.95+12*((V?.25*a.criminalrecord.theft:a.criminalrecord.auto_theft)||0)/.7)/1440;if(Q<W){Q*=Math.min(W/Q,3)}const Z=Math.min(J,Math.max(K,Y,Q)).toFixed(2);a.estimate_active_days=Z;const tt=parseInt(75*I+30*Z+70*$);a.estimate_ws=tt;const et=parseInt(L*Z),nt=parseInt(150*C)+(250*_+50*u)+20*E+150*N,at=25*R+25*P+5*O;let ot=et+nt-at;ot<0&&(ot=0),a.total_energy=ot.toFixed(0),a.nature_energy=et.toFixed(0),a.item_energy=nt.toFixed(0),a.expend_energy=at.toFixed(0);let it=40;const rt=[2,2.8,3.2,3.2,3.6,3.8,3.7,4,4.8,4.8,5.2,5.2,5.4,5.8,5.8,6,6.4,6.6,6.8,7,7,7,7,7.3,8],st=[200,500,1e3,2e3,2750,3e3,3500,4e3,6e3,7e3,8e3,11e3,12420,18e3,18100,24140,31260,36610,46640,56520,67775,84535,106305,1e5,Number.MAX_SAFE_INTEGER];let lt=0,dt=ot,ct=st[0];const pt=parseInt((new Date-new Date("2022/08/02"))/864e5),ht=parseInt(ot*(pt-X)/($-X));for(;dt>0;){let t="",e=Math.min(st[lt],dt,ct,1e3),n=0;const a=rt[lt];if(dt>ht&&$>pt)if(it<2e8){t="OLD";const o=250,i=31e-7,r=6828e-8,s=-.0301431777,l=4500;n=1.122*1.02*a*e*((348e-9*Math.log(l+o)+i)*it/4+r*(l+o)+s)}else t="CAP",e=dt-ht,n=u>_&&_<=100?3240*(dt-ht):2510*(dt-ht);else{t="NEW";const e=it>=3e9?it-2e9:it/3,o=e<5e7?e:(e-5e7)/(8.77635*Math.log10(e))+5e7,i=5e3,r=1600,s=2e3;n=5e-6*a*Math.min(st[lt],dt,ct,1e3)*1.165248*(o*Math.round(1+.07*Math.round(Math.log(1+i/250),4),4)+8*Math.pow(i,1.05)+r*(1-Math.pow(i/99999,2))+s)}it+=n,dt-=e,ct-=e,console.log(`[${t}] 最近这次在系数为 ${a} 的健身房锻炼了 ${e} 能量，属性 +${n.toFixed(2)} 变为 ${it.toFixed(2)}，剩余 ${dt} 能量`),dt<=0?console.log("能量已用光"):lt<rt.length-1&&ct<=0&&(console.log("要换健身房了"),++lt,ct=st[lt])}M>0&&(it=.5*it+.25*it*(1+.85*(Math.pow(1.01,.8*M)-1))+.25*it*(1+.85*(Math.pow(1.01,.2*M)-1))),it=Math.floor(it);let ft=w(it);const ut=[2,6,11,26,31,50,71,100],gt=[100,5e3,1e4,2e4,3e4,5e4],bt=[5e6,5e7,5e8,5e9,5e10],mt=[2e3,2e4,2e5,2e6,2e7,2e8],yt=[2500,25e3,25e4,25e5,35e6,25e7],xt={"Absolute beginner":1,Beginner:2,Inexperienced:3,Rookie:4,Novice:5,"Below average":6,Average:7,Reasonable:8,"Above average":9,Competent:10,"Highly competent":11,Veteran:12,Distinguished:13,"Highly distinguished":14,Professional:15,Star:16,Master:17,Outstanding:18,Celebrity:19,Supreme:20,Idolised:21,Champion:22,Heroic:23,Legendary:24,Elite:25,Invincible:26};let vt=0;for(let t in xt)if(0==a.rank.indexOf(t)){vt=xt[t],a.rank_value=vt,a.rank_name=t;break}const wt=a.rank.split(" ");if(a.rank_title=wt[wt.length-1],vt>0&&it<Number.MAX_SAFE_INTEGER){--vt;const t=a.level||0;for(let e=0;e<ut.length;++e)t>=ut[e]&&--vt;const e=a.criminalrecord.total||0;for(let t=0;t<gt.length;++t)e>=gt[t]&&--vt;const n=o.networth||0;for(let t=0;t<bt.length;++t)n>=bt[t]&&--vt;let i=0,r=Number.MAX_SAFE_INTEGER;vt<=0?r=yt[0]:vt>=mt.length?i=mt[mt.length-1]:(i=mt[vt-1],r=yt[vt]),it<i?ft=`${ft} ~ ${v(i)}`:it>r&&(ft=`${v(r)} ~ ${ft}`)}a.estimate_bs=it,a.estimate_bs_display=ft,a.attackWinRatio=l/R,a.defendWinRatio=(s+r)/(s+r+i),wawa_detection_cache&&(a.ts=Math.floor(Date.now()/1e3),function(t,e){const n=D("wawa_detection_cache")??{};for(n[t]=e;JSON.stringify(n).length>256e3;){const t=Object.entries(n).sort(([,t],[,e])=>t.ts-e.ts)[0][0];console.log("Deleting wawa detection cache for",t,"due to size limit"),delete n[t]}A("wawa_detection_cache",n)}(t,a)),e(a)})}async function P(t){switch(console.log(`[cors] get ${t}`),n){case e.GM:return new Promise((e,n)=>{GM_xmlhttpRequest({method:"get",url:t,headers:{"Cache-Control":"no-cache"},timeout:5e3,ontimeout:t=>n("请求超时"),onload:t=>e(t.responseText),onerror:t=>n(`error: ${t}`)})});case e.PDA:return new Promise((e,n)=>{PDA_httpGet(`${t}`).then(t=>{e(t.responseText)}).catch(t=>{n(`error: ${t}`)})});case e.OTHER:default:return new Promise((t,e)=>{e("不支持跨域")})}}async function R(t,e,n,a){let i=`https://api.torn.com/user/?selections=log&key=${o}`;t.length>0&&(i+=`&cat=${t.join(",")}`),e.length>0&&(i+=`&log=${e.join(",")}`),n&&(i+=`&from=${n}`),a&&(i+=`&to=${a}`);let r=3;for(;;){let t,e;if(r>0){const e=new AbortController;t=e.signal,setTimeout(()=>e.abort(),5e3)}try{e=await fetch(i,{signal:t})}catch(t){if("AbortError"===t.name){r--;continue}throw t}if(!e.ok)throw new Error(e.statusText);const n=await e.json();if("error"in n){if(17===n.error.code&&r>0){r--;continue}throw new Error(n.error.error)}return null===n.log?[]:Object.values(n.log).sort((t,e)=>e.timestamp-t.timestamp)}}async function*j(t,e,n,a,o){for(a||(a=Math.floor((new Date).getTime()/1e3));;){o&&o(a);const i=await R(t,e,n,a);if(0===i.length)break;const r=i[i.length-1].timestamp;if(i[0].timestamp==r){for(const t of i)yield t;break}for(const t of i){if(t.timestamp<=r)break;yield t}a=r+1,await new Promise(t=>setTimeout(t,1e3))}}function z(e){t("#api_result_container").val(t("#api_result_container").val()+"\n"+e)}function B(t){const e=t.split("-")[0].trim(),n=t.split("-")[1].replace("TCT","").trim(),a="20"+n.split("/")[2].trim(),o=n.split("/")[1].trim(),i=n.split("/")[0].trim(),r=new Date(a+"/"+o+"/"+i+" "+e);return r.setHours(r.getHours()-(new Date).getTimezoneOffset()/60),parseInt(r.getTime()/1e3)}function L(t){const e=C("CHAT_LAST_MESSAGE",t);if(e){let t="";t=e.indexOf("|||")>=0?e.split("|||")[0]:e;const n=B(t),a=parseInt((new Date).getTime()/1e3)-n;let o="",i="";return a<3600?(o=parseInt(a/60)+"m",i="#5d9525"):a>=3600&&a<86400?(o=parseInt(a/3600)+"h",i="#DAA520"):a>=86400&&a<3024e3?(o=parseInt(a/86400)+"d",i="#c0542f"):a>=2592e3&&(o=parseInt(a/86400/30)+"month",i="#777"),[i,o]}}function W(){return t("script[uid]").attr("uid")}function G(){t(".clouds1___dZ19Y").remove(),t(".clouds2___jQ9yH").remove(),t(".clouds3___nqj6l").remove()}if(b(".bw-hidden { display: none !important }"),b(".bw-chat-withdraw-btn::before {\ncontent: '取';\nheight: fit-content;\nbackground-color: #adadad;\ncolor: white;\ncursor: pointer;\npadding: 2px;\n}"),b(".bw-chat-withdraw-amount .bw-chat-withdraw-btn::before {\nbackground-color: #8fbc8f;\n}"),b(".bw-chat-2 .bw-chat-withdraw-btn {\nmargin-left: auto;\n}"),b(".bw-chat-3 {\nalign-items: center;\n}"),b(".bw-chat-3 .bw-chat-withdraw-btn {\nmargin-left: 10px;\n}"),b(".bw-shared-armory {\nheight: 100%;\nfloat: right;\nmargin-right: 4px;\ndisplay: flex;\nalign-items: center;\n}"),b(".bw-shared-armory > div {\npadding: 4px;\nborder-radius: 4px;\nline-height: 1;\n}"),Date.prototype.format=function(t){var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(let n in e)new RegExp("("+n+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[n]:("00"+e[n]).substr((""+e[n]).length)));return t},function(){function t(){fetch(`https://api.torn.com/torn/?selections=companies&key=${o}`).then(t=>t.json()).then(t=>{const e=new Date;if("companies"in t){let n={};n["last-updated"]=e.toString(),n.companies={};for(let e in t.companies)n.companies[e]={name:t.companies[e].name,positions:t.companies[e].positions};window.localStorage.setItem("APICache_companies",JSON.stringify(n))}else"error"in t&&M("APICache_companies","last-updated",e.toString())}).catch(t=>console.log("fetch error",t))}!function(){const e=C("APICache_companies","last-updated");if(null!=e&&null!=e){const n=new Date;let a=new Date(e);a.setDate(a.getDate()+1),a<n&&t()}else t()}()}(),travelFilter&&function(){const e={186:"绵羊",187:"泰迪熊",215:"猫咪",258:"美洲豹",261:"貂熊",266:"尼斯湖水怪",268:"赤狐",269:"猴子",273:"岩羚羊",274:"大熊猫",281:"狮子",384:"骆驼",618:"黄貂鱼",260:"大丽花",263:"番红花",264:"兰花",267:"帚石楠",271:"木棉花",272:"雪绒花",276:"牡丹花",277:"樱花",282:"非洲堇",385:"蒺藜花",617:"香蕉兰",256:"催泪弹",226:"烟雾弹",222:"闪光弹",616:"鳟鱼"},n=t(".travel-agency-market ul.users-list li"),a=new Set([8,11,20,21,26,31,50,63,99,107,108,110,111,159,175,177,178,229,230,231,232,259,399,409,432,640,612,613,614,615,619,620,621,622,623,624,625,626,196,197,201,205,252,253,262,402,410,413,645,240,241,242,243,265,419,420,421,430,196,197,198,201,203,205,217,218,219,220,221,397,408,411,415,416,418,431,438,439,641,196,198,199,203,204,255,257,270,333,391,407,196,198,199,201,203,204,223,224,361,398,435,436,197,198,200,203,204,205,233,234,235,236,237,238,239,278,279,334,395,427,429,433,434,197,199,200,201,204,244,245,246,247,248,249,250,251,275,400,381,382,383,386,387,388,412,414,440,4,199,200,201,203,225,227,228,280,332,406,651,652,653,654]);if(n.length>0&&"filtered"!=n.attr("filtered")){let o=parseInt(t("div.delimiter div.msg:contains(You have purchased) span.bold").last().text());const i=parseInt(t(t("div.delimiter div.msg:contains(You have purchased) span.bold").get(-2)).text());o-=i,(isNaN(o)||o<=0)&&(o=1),n.each((n,i)=>{const r=parseInt(t(i).find("div.details").attr("itemid"));if(isNaN(r)||!(r>0))return!1;if(a.has(r))t(i).addClass("hide");else{const n=t(i).find("input#item-"+r)[0];if(n.value=o,n.dispatchEvent(new Event("blur")),e[r]){const n=e[r],a=t(i).find("span.name");a.html(a.html()+"<span style='float:right;padding-right:10px;'>"+n+"</span>")}}}),n.attr("filtered","filtered")}t("#show_more").length<1&&(t(".travel-agency-market").after("<div><div id='show_more' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;background-color:#c0542f;text-align:center;'>点击显示全部</div></div>"),t("#show_more").click(function(){t(this).parent().remove(),n.removeClass("hide")}))}(),common_modify_header_links&&function(){const e={YATA:"<a href='https://yata.yt/' target='_blank'>",NGA:"<a href='https://nga.178.com/thread.php?stid=30081562' target='_blank'>","赛车":"<a href='/loader.php?sid=racing'>","啤酒":"<a href='/shops.php?step=bitsnbobs'>","飞行":"<a href='/travelagency.php'>","库存":"<a href='https://yata.yt/bazaar/abroad/' target='_blank'>","市场":"<a href='/page.php?sid=ItemMarket'>","点市":"<a href='/pmarket.php'>","股市":"<a href='/page.php?sid=stocks'>","巴扎":"<a href='/bazaar.php'>"};setInterval(function(){const n=t("ul.menu-items");if("1"!=n.attr("hasdone")){if(n.siblings().length>0)for(let t in e)n.append('<li class="menu-item-link">'+e[t]+t+"</a></li>");else{n.attr("style","width:295px; margin-top:6px; line-height:16px;"),n.children(":last").remove(),n.children(":last").remove();for(let t in e)n.append('<li class="menu-item-link">'+e[t]+t+"</a></li>")}n.attr("hasdone","1")}},1e3)}(),setInterval(function(){t("[class*=chat-box-header__info-btn___]").closest("[class*=chat-box___]").each(function(){const e=t(this).find("[class*=chat-box-header__name___]").text();if(!e)return;let n=null;const a=t(this).find("[class*=chat-box-message__timestamp___]").last(),o=Number(a.find("[data-bw-chat-ts]").attr("data-bw-chat-ts")),i=a.text().trim().match(/^(\d\d):(\d\d)(\([0-9mhd]*\))?$/);if(o)n=new Date(1e3*o);else if(i){const t=i[1];n=new Date,n.setUTCHours(t<=n.getUTCHours()?t:t-24)}if(!n)return;const r=n.getUTCDate().toString().padStart(2,0),s=(n.getUTCMonth()+1).toString().padStart(2,0),l=n.getUTCFullYear().toString().slice(2);M("CHAT_LAST_MESSAGE",e,`${n.getUTCHours()}:${n.getMinutes()}:00 - ${r}/${s}/${l} TCT|||`+t(this).find("[class*=chat-box-message__message___]").toArray().slice(-5).map(e=>`[${t(e).text()}]`).join(""))}),t("#chatRoot .item___ydsFW").each(function(){const e=t(this).find("button.root___WHFbh"),n=e.text();if(""===n||0===e.find('a[href^="/profiles.php?XID="]').length)return;const a=t(this).find(".footer___w6vCd"),o=a.text().trim().match(/^Last message: (\d+) (\w+) ago$/);let i=0;if(o){const t=parseInt(o[1]),e=o[2];if(e.startsWith("minute"))i=60*t;else if(e.startsWith("hour"))i=3600*t;else if(e.startsWith("day"))i=86400*t;else if(e.startsWith("month"))i=86400*t*30;else{if(!e.startsWith("year"))return;i=86400*t*365}}else if(1!==a.length)return;const r=new Date(Date.now()-1e3*i),s=r.getUTCDate().toString().padStart(2,0),l=(r.getUTCMonth()+1).toString().padStart(2,0),d=r.getUTCFullYear().toString().slice(2);M("CHAT_LAST_MESSAGE",n,`${r.getUTCHours()}:${r.getMinutes()}:00 - ${s}/${l}/${d} TCT|||`+t(this).find(".root___Xw4jI").toArray().slice(-5).map(e=>`[${t(e).text()}]`).join(""))})},1e3),function(){setInterval(function(){const r=t("#chatRoot [class*=chat-box___] [class*=chat-box-body___]");e.disconnect(),r.each(function(){t(this).children("div").each(function(){n(this)}),e.observe(this,{childList:!0})}),t("#chatRoot .list___jqmw3 > *").each(function(){!function(e){if(t(e).is(".bw-chat-3"))return;const n=a(t(e).find(".root___xn40j").text());if(void 0===n)return;t(e).addClass("bw-chat-3"),t(e).toggleClass("bw-chat-withdraw-amount",n>0);const r=t(e).find("a").last(),{uid:s,username:l}=o(r);if(""===s)return;t(e).append(i(s,l,n))}(this)})},1e3);const e=new MutationObserver(function(t){for(const e of t)for(const t of e.addedNodes)n(t)});function n(e){if(function(e){const n=t(e).find("[class*=chat-box-message__timestamp___] p");if(0===n.length||n.find(".bw-chat-ts").length>0)return;const a=new Date,o=Math.floor(a.getTime()/1e3),i=n.text().trim(),r=i.match(/^(\d\d):(\d\d)$/),s=i.match(/^([A-Za-z]+) (\d\d):(\d\d)$/),l=i.match(/^(\d\d):(\d\d):\d\d - (\d\d)\/(\d\d)\/(\d\d)$/);if(r){const t=a.getUTCHours(),e=parseInt(r[1]);a.setUTCHours(e<=t?e:e-24),a.setUTCMinutes(parseInt(r[2]))}else if(s){const t={sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6}[s[1].toLowerCase()],e=(a.getUTCDay()+7-t)%7;a.setUTCDate(a.getUTCDate()-(e||0)),a.setUTCHours(parseInt(s[2])),a.setUTCMinutes(parseInt(s[3]))}else l&&(a.setUTCHours(parseInt(l[1])),a.setUTCMinutes(parseInt(l[2])),a.setUTCDate(parseInt(l[3])),a.setUTCMonth(parseInt(l[4])-1),a.setUTCFullYear(parseInt(l[5])+2e3));const d=Math.floor(a.getTime()/1e3),c=o-d;let p="",h="";c>=86400?(p=`(${Math.floor(c/86400)}d)`,h="t-red"):c>=3600?(p=`(${Math.floor(c/3600)}h)`,h="t-yellow"):c>0&&(p=`(${Math.floor(c/60)}m)`,h="t-green"),n.append(`<span class="bw-chat-ts ${h}" data-bw-chat-ts="${d}" style="margin-left: 4px">${p}</span>`)}(e),t(e).is(".bw-chat-2")||0===t(e).find("[class*=chat-box-message__avatar___]").length)return;const n=a(t(e).find("[class*=chat-box-message__message___]").text());if(void 0===n)return;t(e).addClass("bw-chat-2"),t(e).toggleClass("bw-chat-withdraw-amount",n>0);const r=t(e).find("a").last(),{uid:s,username:l}=o(r);""!==s&&t(e).find("div[class*=chat-box-message--public___]").append(i(s,l,n))}function a(t){const e=t.match(/(\bwithdraw|取)(.*)/i);if(!e)return;let n=0;const a=e[2].match(/([\.0-9]+)([k|m|b]?)/i);if(a){const t=a[1].replace(/,/g,""),e=a[2].toLowerCase();let o=1;"k"==e?o=1e3:"m"==e?o=1e6:"b"==e&&(o=1e9),n=parseInt(parseFloat(t)*o)}return n}function o(t){const e=t.text().replace(/[:\s]/g,""),n=t.attr("href")||"";return{uid:n.substr(n.indexOf("XID=")+4),username:e}}function i(e,n,a){const o=t('<div class="bw-chat-withdraw-btn"></div>');return o.click(function(){const t=window.location.pathname,n=window.location.search,o=new URL(`https://www.torn.com/factions.php?step=your#/tab=controls&giveMoneyTo=${e}&money=${a}`);window.location.href=o,"/factions.php"===t&&"?step=your"===n&&location.reload()}),o}}(),setInterval(function(){if(t("#profile-mini-root").children().children("[class^=profile-mini-_userImageWrapper]").length>0&&!t("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").attr("hasdone")){t("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").attr("hasdone","1");const e=t("#profile-mini-root").children().children("[class^=profile-mini-_userImageWrapper]").children("a"),n=e?e.attr("href"):void 0,a=n?n.substr(20):void 0;a&&N(a,function(e){const n=t("#profile-mini-root").children().css("background-color");t("#profile-mini-root").children().children("[class^=profile-mini-_userProfileWrapper]").append(`\n<div id="bingwa-mini-profile" class="border-round" style="overflow: hidden; width:254px; height:26px; position: absolute; right: -6px; top: -2px; z-index: 1; color: #fff ;background-image: linear-gradient(${n},#888 25%,${n}); border: 1px solid #000; margin: 5px; text-align: center;">\n<div id="bingwa-mini-profile-bs" style="float: left; width:112px; height:16px; background-color: ${p}; border: 1px solid #000; margin: 4px 2px 4px 4px; text-align: center;"></div>\n<div id="bingwa-mini-profile-hp" style="float: left; width:104px; height:16px; background-color: #fff; border: 1px solid #000; margin: 4px 2px; text-align: center;"></div>\n<div id="bingwa-mini-profile-attack" style="float: left; width:16px; height:16px; background-color: ${l}; border: 1px solid #000; margin: 4px 4px 4px 2px; text-align: center;"></div>\n</div>`);const o=`/loader.php?sid=attack&user2ID=${a}`;t("#bingwa-mini-profile-attack").html(`<div style="padding: 2px 0px; text-shadow: none;"><a href="${o}" style="color:#fff;text-decoration: none;">打</a></div>`),M("battlestats",a,e.estimate_bs),t("#bingwa-mini-profile-bs").html(`<div style="padding: 2px 0px;">${e.estimate_bs_display}</div>`);let i=parseInt(100*e.life.current/e.life.maximum);i>100&&(i=100);const r=e.life.current+"/"+e.life.maximum+" ("+i+"%)";i<=66?t("#bingwa-mini-profile-hp").html(O(16,i,"#c0542f","#fff",r)):t("#bingwa-mini-profile-hp").html(O(16,i,"#5d9525","#fff",r)),t("#bingwa-mini-profile-last").html(`<div style="padding: 2px 0px;">${e.last_action_details}</div>`)})}},500),withdrawal_helper&&function(){setInterval(async function(){const i=t("#faction-user-list");0===i.length||i.is(".bw-done")||(i.addClass("bw-done"),await async function(){if(void 0===n){n=new Set;try{const t=`https://api.torn.com/faction/?selections=basic,positions&key=${o}`,e=await fetch(t),a=await e.json();if("error"in a)throw new Error(`API error: ${a.error.error}`);if(!("members"in a)||!("positions"in a))return;const i=Object.keys(a.positions).filter(t=>a.positions[t].canGiveMoney);i.push("Leader","Co-leader");for(const t of Object.keys(a.members)){const e=a.members[t].position,o=a.members[t].status.state;i.indexOf(e)>=0&&"Okay"==o&&n.add(t)}}catch(t){console.log("Error in fetching position data:",t)}}}(),await a(),e.disconnect(),e.observe(i[0],{childList:!0,subtree:!0}))},1e3);const e=new MutationObserver(a);let n;async function a(){t("#faction-user-list .actionContainer___J6mCW").each(function(){const e=t(this);if(e.siblings(".bw-chat-position-tag").length>0)return;const a=e.parent().find('a[href^="/profiles.php?XID="]').first(),o=a.is(".online___PmwKA"),i=a.attr("href"),r=i?i.substring(18):"";n.has(r)>=0&&o&&e.before('<span class="bw-chat-position-tag" style="color:white;background-color:Darkseagreen;padding:4px;"><b> 可取钱 在城内</b></span>')})}}(),hide_cloud_while_flying)if(t(".airspaceScene___yGSV_").length>0)G();else{const X=t("#travel-root");if(1===X.length){const J=new MutationObserver(function(){t(".airspaceScene___yGSV_").length>0&&(J.disconnect(),G())});J.observe(X[0],{childList:!0,subtree:!0})}}function H(e,n,a){if(0===e.length||0===n.length)return void console.log("Invalid input for renderWithdrawalButtons:",e.length,n.length);const o="give-money",i="array";C(o,i)||M(o,i,[{button_name:"取1m","button-value":"1,000,000"},{button_name:"取5m","button-value":"5,000,000"},{button_name:"取10m","button-value":"10,000,000"},{button_name:"取25m","button-value":"25,000,000"}]),function r(){const s=C(o,i);e.empty(),s.forEach((t,n)=>{e.append(`<span id="bw-withdraw-${n}" class="deposit-money-btn border-round" style="display:inline-block; cursor:pointer; padding:3px; color:white; background-color:${c};">${t.button_name}</span>`)}),e.append(`<span id="bw-withdraw-add" class="border-round" style="display:inline-block; cursor:pointer; padding:3px; color:white; background-color:${d};">+</span>`),void 0!==a&&e.append(`<span id="bw-withdraw-all" class="border-round" style="display:inline-block; cursor:pointer; padding:3px; color:white; background-color:${c};">全取</span>`),e.append(`<span id="bw-withdraw-remove" class="border-round" style="display:inline-block; cursor:pointer; padding:3px; color:white; background-color:${l};">x</span>`),t("#bw-withdraw-add").click(()=>{t("#bw-withdraw-input").length>0||(t("#bw-withdraw-add").html('<span style="display: inline-block;"><input id="bw-withdraw-input" type="text" class="border-round"></input>'),t("#bw-withdraw-input").tornInputMoney({groupMoneyClass:null}),t("#bw-withdraw-input").focus(),t("#bw-withdraw-input").blur(()=>{const e=t("#bw-withdraw-input").val(),n=x("$"+e);n>0&&(s.push({button_name:`取${w(n)}`,"button-value":e}),M(o,i,s)),r()}))}),t("#bw-withdraw-remove").click(()=>{t("#bw-withdraw-remove").hasClass("bw-withdraw-removing")?(t(".deposit-money-btn").css("background-color",c),t(".deposit-money-btn").removeClass("bw-withdraw-removing"),t("#bw-withdraw-remove").css("background-color",l),t("#bw-withdraw-remove").removeClass("bw-withdraw-removing")):(t(".deposit-money-btn").css("background-color",l),t(".deposit-money-btn").addClass("bw-withdraw-removing"),t("#bw-withdraw-remove").css("background-color",g),t("#bw-withdraw-remove").addClass("bw-withdraw-removing"))}),s.forEach((e,a)=>{t(`#bw-withdraw-${a}`).click(()=>{if(t(`#bw-withdraw-${a}`).hasClass("bw-withdraw-removing")){let t=s;return t.splice(a,1),M(o,i,t),void r()}var l;l=e["button-value"],n.val(l),n[0].dispatchEvent(new Event("input",{bubbles:!0}))})}),t("#bw-withdraw-all").click(()=>{const t=a();void 0!==t&&(n.val(Math.max(t,1)),n[0].dispatchEvent(new Event("input",{bubbles:!0})))})}()}if(bigger_screen_on_laptop&&t(".computer-wrap").length>0&&(t(".computer-navigation").insertBefore(".computer-wrap"),t("#computer-content-wrapper").insertBefore(".computer-wrap"),t(".computer-wrap").css("visibility","hidden"),t(".computer-navigation").attr("style","position: unset; margin-bottom: 10px;"),t("#computer-content-wrapper").removeClass("left"),t("#computer-content-wrapper").css("margin","auto")),window.location.href.indexOf("loader.php?sid=racing"),window.location.href.indexOf("shops.php?step=bitsnbobs")>=0&&t(".buy-flexslider input[name^=buyAmount]").val("100"),window.location.href.indexOf("factions.php?step=your")>=0){class K{constructor(){this.data=null,this.error=null,this.checkedUid=null,this.load()}async load(){try{const t=await P("https://bingwa-api.tornsmth.website/faction-loan/data.json"),e=JSON.parse(t),n=e.expire,a=Math.floor((new Date).getTime()/1e3);!n||n<a?this.error="数据过期":this.data=e.data}catch(t){this.error=t.toString(),console.log("Fail to load loan data:",t)}}}const Y=new K;function V(){return t(".money___aACfM > form")}function Q(t){return t.find('input[name="searchAccount"]').first()}function Z(t){return t.find("input.input-money").first()}function tt(t){const e=Q(t).val().match(/^(.*) \[(\d+)\]$/);return{name:(e??[])[1],uid:(e??[])[2]}}function et(){const e={};return t('.money___aACfM .userListWrap___voEX8 .userInfoWrap___rjWOK a[href^="/profiles.php?XID="]').each(function(){const n=t(this),a=n.attr("href").slice(18);if(!a.match(/^\d+$/))return;const o=n.closest(".userInfoWrap___rjWOK").siblings().text().trim().match(/^\$(-?[\d,]+)$/);if(!o)return;const i=parseInt(o[1].replace(/,/g,""));e[a]=i}),e}function nt(t){return et()[t]}function at(){const e=V();if(0===Z(e).length)return;if(e.siblings(".bw-withdrawal-button-wrap").length>0)return;const n=t('<div class="bw-withdrawal-button-wrap" style="margin: 10px 0 0 10px; display: flex; flex-wrap: wrap; gap: 4px;"></div>');e.before(n);H(n,Z(e),()=>{const{uid:t}=tt(e);if(!t)return void alert("全取请先输入玩家ID");let n=nt(t);if(n<0&&!Y.error&&Y.data){n+=Y.data[t]||0}return Math.max(n,0)})}function ot(){const e=V();if(e.length>0&&t(".rest-money-wrap").length<1){e.after('\n<div class= "rest-money-wrap" style="width:290px; border:4px solid gray; padding:5px 2px; margin:0px 0px 5px 5px; background-image: linear-gradient(rgba(209,73,78,0.2),rgba(209,73,78,0.1));">\n<div style="overflow:hidden; margin:7px; border:1px solid gray;">\n<a id="bw-check-loan" class="t-blue" style="display: inline-block; width: 100%; padding: 3px 0; background-color: var(--default-bg-panel-color); text-align:center;" href="https://bingwa-api.tornsmth.website/faction-loan/view" target="_blank">点这里手工检查贷款</a>\n</div>\n<div style="overflow:hidden; margin:7px; border:1px solid gray;">\n<div id="username-title" style="width:87px; height:22px; float:left; color: var(--default-blue-color); background-color: var(--default-bg-panel-color); text-align:center;"><div style="padding: 3px 0px;">收款人</div></div>\n<div id="username-value" style="width:187px; height:22px; float:left; color: var(--default-bg-panel-color); background-color: var(--default-blue-color); text-align:center;"></div>\n</div>\n<div style="overflow:hidden; margin:7px; border:1px solid gray;">\n<div id="before-title" style="width:137px; height:22px; float:left; color: var(--default-green-color); background-color: var(--default-bg-panel-color); text-align:center;"><div style="padding: 3px 0px;">取款前余额</div></div>\n<div id="before-value" style="width:137px; height:22px; float:left; color: var(--default-bg-panel-color); background-color: var(--default-green-color); text-align:center;"></div>\n</div>\n<div style="overflow:hidden; margin:7px; border:1px solid gray;">\n<div id="after-title" style="width:137px; height:22px; float:left; color: var(--default-green-color); background-color: var(--default-bg-panel-color); text-align:center;"><div style="padding: 3px 0px;">取款后余额</div></div>\n<div id="after-value" style="width:137px; height:22px; float:left; color: var(--default-bg-panel-color); background-color: var(--default-green-color); text-align:center;"><div style="padding: 3px 0px;"></div></div>\n</div>\n<div style="overflow:hidden; margin:7px; border:1px solid gray;">\n<div id="loan-title" style="width:137px; height:22px; float:left; color: var(--default-green-color); background-color: var(--default-bg-panel-color); text-align:center;"><div style="padding: 3px 0px;">贷款额度</div></div>\n<div id="loan-value" style="width:137px; min-height:22px; float:left; color: var(--default-bg-panel-color); background-color: var(--default-green-color); text-align:center;"><div style="padding: 3px 0px;"></div></div>\n</div>\n</div>');t("#bw-check-loan").click(function(){const e=t(this).attr("data-uid");e&&(Y.checkedUid=e)})}}setInterval(it,1e3);function it(){const e=t("#bw-check-loan");if(0===e.length)return;e.parent().hide();const n=V(),{name:a,uid:o}=tt(n);if(void 0===a||void 0===o)return;t("#username-value").html(`<div style="padding: 3px 0px;">${a} [${o}]</div>`);const i=nt(o);i>=0?(t("#before-value").css("background-color","var(--default-green-color)").html(`<div style="padding: 3px 0px;">${x(i)}</div>`),t("#before-title").css("color","var(--default-green-color)")):(t("#before-value").css("background-color","var(--default-red-color)").html(`<div style="padding: 3px 0px;">${x(i)}</div>`),t("#before-title").css("color","var(--default-red-color)"));const r=i-y(Z(n).val());r>=0?(t("#after-value").css("background-color","var(--default-green-color)").html(`<div style="padding: 3px 0px;">${x(r)}</div>`),t("#after-title").css("color","var(--default-green-color)")):(t("#after-value").css("background-color","var(--default-red-color)").html(`<div style="padding: 3px 0px;">${x(r)}</div>`),t("#after-title").css("color","var(--default-red-color)"));let s=r>=0;if(!Y.error&&Y.data){const e=Y.data[o]||0;e>=-r?(s=!0,t("#loan-value").css("background-color","var(--default-green-color)").html(`<div style="padding: 3px 0px;">${x(e)}</div>`),t("#loan-title").css("color","var(--default-green-color)")):(t("#loan-value").css("background-color","var(--default-red-color)").html(`<div style="padding: 3px 0px;">${x(e)}</div>`),t("#loan-title").css("color","var(--default-red-color)"))}else Y.error?(t("#loan-value").css("background-color","var(--default-red-color)").html(`<div style="padding: 3px 0px;">加载失败: ${Y.error}</div>`),t("#loan-title").css("color","var(--default-red-color)")):(t("#loan-value").css("background-color","var(--default-blue-color)").html('<div style="padding: 3px 0px;">正在加载</div>'),t("#loan-title").css("color","var(--default-blue-color)"));n.find("input#add-money-to-balance").prop("checked")&&(s=!0),Y.checkedUid===o&&(s=!0);const l=n.find("button[type=submit]");s?(l.show(),e.parent().hide()):(l.hide(),e.parent().show(),e.attr("data-uid",o))}function rt(){const e=t(".money___aACfM .give-to-user-balance-message").first();if(0===e.length||t("#bw-faction-balance-bars").length>0)return;const n=et();if(0===Object.keys(n).length)return;const a=t(".money___aACfM > .titleContainer___niBSh").text().match(/There is \$([\d,]+) in the vault/i),o=a?parseInt(a[1].replace(/,/g,"")):0,i=Object.values(n).reduce((t,e)=>t+e,0),r=Object.values(n).filter(t=>t>0).reduce((t,e)=>t+e,0),s=Object.values(n).filter(t=>t<0).reduce((t,e)=>t+e,0),l=o-i,d=Math.max(Math.abs(i),o,r,-s,Math.abs(l));if(d<=0)return;const c=t('<div id="bw-faction-balance-bars" style="\nwidth:290px; border:4px solid gray; padding:5px 2px; margin:0px 0px 5px 5px;\nbackground-image: linear-gradient(rgba(209,73,78,0.2),rgba(209,73,78,0.1));\n"></div>');e.after(c),st(c,"帮派余额",o,d),st(c,"所有存款总和",i,d),st(c,"帮派公共资金",l,d),st(c,"正存款总和",r,d),st(c,"负存款总和",s,d),st(c,"准备金率",parseFloat(o/r),d)}function st(t,e,n,a){let o=x(n);if(n>=0){let i=100*n/a;"准备金率"==e&&(i=Math.min(100*n,100),o=(100*n).toFixed(2)+"%"),t.append(`\n<div style="overflow:hidden; margin:7px; border:1px solid gray;">\n<div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${O(22,0,"var(--default-green-color)","var(--default-bg-panel-color)",e)}</div>\n<div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${O(22,i,"var(--default-green-color)","var(--default-bg-panel-color)",o)}</div>\n</div>`)}else{const i=100*n/a+100;t.append(`\n<div style="overflow:hidden; margin:7px; border:1px solid gray;">\n<div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${O(22,i,"var(--default-bg-panel-color)","var(--default-red-color)",e)}</div>\n<div style="width:137px; height:22px; float:left; text-align:center; overflow:hidden;">${O(22,0,"var(--default-red-color)","var(--default-bg-panel-color)",o)}</div>\n</div>`)}}function lt(){const e=V(),n=e.find(".dropdown-content button");if(0===n.length)return;const a=n.filter("[data-bw-text]");if(a.length>0&&a.text()===a.attr("data-bw-text"))return;a.removeAttr("data-bw-text"),n.css("font-weight","");const o=Q(e);if(0===o.length||""!==o.val())return;const i=JSON.parse(t("#websocketConnectionData").text()).userID;n.each(function(){const e=t(this);if(e.text().includes(`[${i}]`)){e.attr("data-bw-text",e.text()),e.css("font-weight","bold");const t=e.parent();return e.detach().prependTo(t),!1}})}new MutationObserver(function(t,e){at(),rt(),ot(),lt();V().find("input#give-money").prop("disabled",!1)}).observe(document.getElementById("faction-controls"),{childList:!0,subtree:!0})}if(window.location.href.indexOf("properties.php")>=0){const dt=new MutationObserver(pt),ct=setInterval(()=>{const e=t("#properties-page-wrap");e.length>0&&(clearInterval(ct),pt(),dt.observe(e[0],{childList:!0,subtree:!0}))},200);function pt(){const e=t(".vault-wrap form.vault-cont.left"),n=e.find("input.input-money").first();if(0===n.length)return;if(e.children(".bw-withdrawal-button-wrap").length>0)return;const a=t('<div class="bw-withdrawal-button-wrap" style="margin: 10px 0 0 10px; display: flex; flex-wrap: wrap; gap: 4px;"></div>');e.append(a),H(a,n,void 0)}}if(window.location.href.indexOf("companies.php")>=0){const ht=new MutationObserver(ut),ft=setInterval(()=>{const e=t(".company-wrap");e.length>0&&(clearInterval(ft),ut(),ht.observe(e[0],{childList:!0,subtree:!0}))},200);function ut(){const e=t(".funds-wrap.withdraw"),n=e.find("input.input-money").first();if(0===n.length)return;if(e.siblings(".bw-withdrawal-button-wrap").length>0)return;const a=t('<div class="bw-withdrawal-button-wrap" style="width: 100%; margin: 0 0 10px 10px; display: flex; flex-wrap: wrap; gap: 4px;"></div>');e.parent().append(a),H(a,n,void 0)}}if(jailView&&window.location.href.indexOf("jailview.php")>=0){const gt="3.0.5",bt="bingwa_bust",mt=60;class yt{constructor(t){this.refresh_callback=t;const e=D(bt);e&&e.version===gt?(this.info=e.info,this.conf=e.conf):(this.info={timestamp:0},this.conf={hidden:!1,prob_min:null,prob_max:null,order:"ASC",friend:"PIN",quick_bust:"ON"}),this.refreshInfo()}getBustSkill(){return this.info.level*(1+this.info.faction_perk/100)*(1+this.info.edu_perk/100)}getBustProb(t){let e=this.info.penalty;return this.info.job_perk&&(e/=2),276.536-(.73643*t+5309.59*e)/this.getBustSkill()}save(){A(bt,{info:this.info,conf:this.conf,version:gt})}refreshInfo(){const t=Math.floor((new Date).getTime()/1e3),e=this.info.error?5:mt;t-this.info.timestamp<e||(this.info={timestamp:t,error:"loading"},this.save(),new Promise(async()=>{await this.fetchInfo(),this.save(),this.refresh_callback&&this.refresh_callback()}))}increasePenalty(){"penalty"in this.info&&(this.info.penalty+=1,this.save()),"today_busts"in this.info&&(this.info.today_busts+=1,this.save())}async fetchInfo(){const t=Math.floor((new Date).getTime()/1e3),e=[fetch(`https://api.torn.com/user/?selections=basic,perks&key=${o}`),fetch(`https://api.torn.com/user/?selections=log&log=5360&to=${t+10}&key=${o}`)],[n,a]=await Promise.all(e);for(const e of[n,a])if(!e.ok)return void(this.info={timestamp:t,error:e.statusText});const i=await n.json(),r=await a.json();for(const e of[i,r])if("error"in e)return void(this.info={timestamp:t,error:e.error.error});this.info={timestamp:t},this.info.level=i.level;const s=i.faction_perks.find(t=>t.match(/bust success chance/i));this.info.faction_perk=s?parseInt(s.match(/\d+/)[0]):0,this.info.job_perk=i.job_perks.indexOf("+ Easier to bust more people at once")>=0;const l=i.education_perks.find(t=>t.match(/Busting skill/i));this.info.edu_perk=l?parseInt(l.match(/\d+/)[0]):0,this.info.penalty=0,this.info.today_busts=0;for(const e of Object.values(r.log))t-e.timestamp<=259200&&(this.info.penalty+=1/(1+(t-e.timestamp)/36e3)),Math.floor(t/24/3600)==Math.floor(e.timestamp/24/3600)&&(this.info.today_busts+=1)}}const xt=new yt(Ct),vt=new MutationObserver(async function(e){let n=!1;for(const a of e)for(const e of a.addedNodes)"LI"===e.tagName?n=It(e)||n:t(e).text().match(/You busted .* out of jail/i)&&(n=!0,xt.increasePenalty());n&&Ct()}),wt=t(".userlist-wrapper");function _t(t){const e=t.find("a.faction").attr("href");return e?e.substring(30):0}function kt(t){const e=t.find("span.level").text().match(/\d+/g);return e?parseInt(e[0]):0}function $t(t){const e=t.find("span.time").text().match(/\d+/g),n=e||[0];return n[1]?60*parseInt(n[0])+parseInt(n[1]):parseInt(n[0])}function It(e){if(t(e).find("b.bust-score").attr("bust-score"))return!1;const n=($t(t(e))+180)*kt(t(e));if(0===n)return!1;const a=`<b class="bust-score t-red" style="margin-left: 0em" bust-score=${n}></b>`;return t(e).find("span.reason").append(a),t(e).removeClass("gray"),!0}function St(){const e=t("ul.user-info-list-wrap").children("li");e.each(function(){if(0===t(this).find("b.bust-score").length)return;const e=parseFloat(t(this).find("b.bust-score").attr("bust-prob"));let n=!1;isNaN(e)||(null!==xt.conf.prob_min&&e<xt.conf.prob_min&&(n=!0),null!==xt.conf.prob_max&&e>xt.conf.prob_max&&(n=!0));const a=_t(t(this))in i;"PIN"===xt.conf.friend&&a&&(n=!1),n?t(this).addClass("bw-hidden"):t(this).removeClass("bw-hidden"),xt.conf.friend&&a?t(this).css("background-color","rgba(110, 160, 55, 0.15)"):t(this).css("background-color","");const o=t(this).children("a.bust");"ON"===xt.conf.quick_bust||"ON_BOTH"===xt.conf.quick_bust?o.attr("href",o.attr("href").replace(/\bstep=breakout\b/,"step=breakout1&")):o.attr("href",o.attr("href").replace(/\bstep=breakout1\b/,"step=breakout"));const r=t(this).children("a.bye");"ON_BAIL"===xt.conf.quick_bust||"ON_BOTH"===xt.conf.quick_bust?r.attr("href",r.attr("href").replace(/\bstep=buy\b/,"step=buy1&")):r.attr("href",r.attr("href").replace(/\bstep=buy1\b/,"step=buy"))}),xt.conf.order&&(e.sort(function(e,n){const a=parseInt(t(e).find("b.bust-score").attr("bust-score")),o=parseInt(t(n).find("b.bust-score").attr("bust-score")),r=_t(t(e))in i,s=_t(t(n))in i;return"PIN"===xt.conf.friend&&r!==s?Number(s)-Number(r):"ASC"===xt.conf.order?a-o:o-a}),e.detach().appendTo("ul.user-info-list-wrap")),Dt()}function Dt(){t("#bw-jail-refresh").remove();const e=new URLSearchParams(window.location.hash.substring(1)),n=parseInt(e.get("start")||"0"),a=t("ul.user-info-list-wrap > li").length,o=0===n?1:a>=50?n+1:Math.max(n-(50-a),0),i=t(`<div id="bw-jail-refresh" style="margin: -20px 0 0 auto; width: fit-content; background: var(--default-bg-panel-color); border-radius: 5px; padding: 5px 10px; box-shadow: 1px 1px 4px #0004;">\n<a href="#start=${o}" class="t-blue" style="display: inline-block; line-height: 1; padding: 5px; border-radius: 5px;">\n显示第 ${o+1} - ${o+50} 人\n</a>\n</div>`);t(".msg-info-wrap").after(i),i.children("a").click(()=>{i.remove()})}function Ct(){const e=xt.info,n=t(".info-msg-cont").first();if(n.css("background","var(--default-bg-panel-color)"),n.css("font-size","12px"),n.html('\n<div id="bust-info" style="display: flex; flex-wrap: wrap; gap: 10px 20px; padding: 10px;"></div>\n<div id="bust-conf" class="small-select-menu-wrap">\n<hr />\n<div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px 20px; padding: 10px;">\n<label style="width: 10em; display: flex; gap: 4px">\n<b style="margin: auto 0">最低成功率</b>\n<input id="bust-conf-prob-min" type="text" inputmode="numeric" maxlength="3" placeholder="-"\nstyle="width: 3em; flex-grow: 1; border: 1px solid #ccc; border-radius: 4px; padding: 2px; text-align: center;">\n</label>\n<label style="width: 10em; display: flex; gap: 4px">\n<b style="margin: auto 0">最高成功率</b>\n<input id="bust-conf-prob-max" type="text" inputmode="numeric" maxlength="3" placeholder="-"\nstyle="width: 3em; flex-grow: 1; border: 1px solid #ccc; border-radius: 4px; padding: 2px; text-align: center;">\n</label>\n<label style="width: 10em; display: flex; gap: 4px">\n<b style="margin: auto 0">排序</b>\n<div class="select-wrap dropdown-new dropdown-default" style="flex-grow: 1">\n<select id="bust-conf-order">\n<option value="ASC">由易到难</option>\n<option value="DESC">由难到易</option>\n<option value="">系统顺序</option>\n</select>\n<div id="bust-conf-order-list" class="select-list dropdown-content"></div>\n</div>\n</label>\n<label style="width: 10em; display: flex; gap: 4px">\n<b style="margin: auto 0">友军</b>\n<div class="select-wrap dropdown-new dropdown-default" style="flex-grow: 1">\n<select id="bust-conf-friend">\n<option value="PIN">高亮置顶</option>\n<option value="HIGHLIGHT">高亮</option>\n<option value="">不高亮</option>\n</select>\n<div id="bust-conf-friend-list" class="select-list dropdown-content"></div>\n</div>\n</label>\n<label style="width: 10em; display: flex; gap: 4px">\n<b style="margin: auto 0">免确认</b>\n<div class="select-wrap dropdown-new dropdown-default" style="flex-grow: 1">\n<select id="bust-conf-quick-bust">\n<option value="ON">Bust</option>\n<option value="ON_BAIL">Bail</option>\n<option value="ON_BOTH">全部</option>\n<option value="">无</option>\n</select>\n<div id="bust-conf-quick-bust-list" class="select-list dropdown-content"></div>\n</div>\n</label>\n</div>\n</div>\n'),null!==xt.conf.prob_min&&t("#bust-conf-prob-min").val(xt.conf.prob_min),null!==xt.conf.prob_max&&t("#bust-conf-prob-max").val(xt.conf.prob_max),t("#bust-conf-order").val(xt.conf.order),t("#bust-conf-friend").val(xt.conf.friend),t("#bust-conf-quick-bust").val(xt.conf.quick_bust),E(t("#bust-conf-prob-min"),t=>/^\d*$/.test(t)),E(t("#bust-conf-prob-max"),t=>/^\d*$/.test(t)),t("#bust-conf input").change(Mt),t("#bust-conf select").change(Mt),"loading"===e.error)t("#bust-info").html("<span>正在读取 Bust 历史，请稍等。若 5 秒内未出结果，请刷新页面重试。</span>");else if("Access level of this key is not high enough"===e.error)t("#bust-info").html('\n<span class="t-red">权限不足，无法读取 Bust 惩罚！</span>\n<a href="/preferences.php#tab=api">请使用 Full Access 类型的 API Key</a>\n');else if(e.error)t("#bust-info").html(`<span class="t-red">出错啦！${e.error}</span>`);else{const n=e.job_perk?"惩罚效果减半":"无";t("#bust-info").html(`\n<span style="width: 10em"><b>Bust 惩罚</b>: ${e.penalty.toFixed(2)}</span>\n<span style="width: 10em" title><b>Bust 技能</b>: ${xt.getBustSkill().toFixed(2)}</span>\n<span style="width: 10em"><b>工作特技</b>: ${n}</span>\n<span style="width: 10em"><b>今日人数</b>: ${e.today_busts}</span>\n`),t("#bust-info").tooltip({tooltipClass:"white-tooltip",content:function(){const t=50===e.faction_perk?"50%":`<span class="t-red">${e.faction_perk}%</span>`,n=65===e.edu_perk?"65%":`<span class="t-red">${e.edu_perk}%</span>`;return`个人等级: ${e.level}<br>帮派加成: ${t}<br>教育加成: ${n}`}})}t("#bust-info").append('<a id="bust-info-toggle-conf" style="margin-left: auto" href="javascript: void">显示选项</a>'),At(xt.conf.hidden),t("#bust-info-toggle-conf").click(function(){xt.conf.hidden=!xt.conf.hidden,xt.save(),At(xt.conf.hidden)}),t("b.bust-score").each(function(){const n=t(this).attr("bust-score");if(!n)return;let a="t-red";if(e.error)t(this).text(` ${n}`),t(this).removeAttr("bust-prob");else{const e=xt.getBustProb(n);a=e>=120?"t-gray-9":e>=100?"t-green":e>=80?"t-yellow":e>=0?"t-red":"t-red bg-red active",t(this).html(` ${n}&nbsp;&nbsp;${e.toFixed(1)}%`),t(this).attr("bust-prob",e.toFixed(1))}t(this).attr("class",`bust-score ${a}`)}),St()}function At(e){e?(t("#bust-info-toggle-conf").text("显示选项"),t("#bust-conf").hide()):(t("#bust-info-toggle-conf").text("隐藏选项"),t("#bust-conf").show())}function Mt(){const e=t("#bust-conf-prob-min").val();xt.conf.prob_min=e?parseInt(e):null;const n=t("#bust-conf-prob-max").val();xt.conf.prob_max=n?parseInt(n):null,xt.conf.order=t("#bust-conf-order").val(),xt.conf.friend=t("#bust-conf-friend").val(),xt.conf.quick_bust=t("#bust-conf-quick-bust").val(),xt.save(),St()}wt.length>0&&vt.observe(wt[0],{childList:!0,characterData:!0,subtree:!0})}if(window.location.href.indexOf("page.php?sid=crimes")>=0){const Tt="BW_CRIME_CHAIN_BONUS",Ft="3.4.12",Ot=60,Et=1e3,Nt=200,Pt=D(Tt),Rt=Pt?.version===Ft?Pt:{bonusFromLog:0,lastLogTimestamp:0,updatedAt:0,bonus:0,version:Ft},jt={success:NaN,fail:NaN,critical:NaN};function zt(){A(Tt,Rt)}async function Bt(){const t=Math.floor(Date.now()/1e3);if(t-Rt.updatedAt<Ot)return;const e=()=>{Gt()};let n,a=0,o=1,i=0;for await(const t of j([136],[],null,null,e)){if(t.timestamp<=Rt.lastLogTimestamp)break;const e=(t.title||"").toLowerCase();if(e.startsWith("crime success"))a+=o;else if(e.startsWith("crime fail"))o/=2;else if(e.startsWith("crime critical fail")){o=0;break}if(n=n??t.timestamp,i++,i>=Et){o=0;break}}Rt.bonusFromLog=Rt.bonusFromLog*o+a,Rt.lastLogTimestamp=n??Rt.lastLogTimestamp,Rt.updatedAt=t,Rt.bonus=Rt.bonusFromLog,Wt(Rt.bonus),zt()}function Lt(){const e=t(".crimes-app .resultCounts___n3YFJ");if(0===e.length)return;let n=e.find("#chain-bonus-display");return 0===n.length&&(n=t('<div id="chain-bonus-display" style="display: flex; align-items: flex-end; gap: 2px;">\n<div style="height: 14px; overflow: visible;">\n<div style=" width: 20px; height: 20px; margin-top: -3px; background: url(/images/v2/faction/skill_tree/upgrade_icons.svg) left top no-repeat; background-position: -177px -278px;"></div>\n</div>\n<span id="chain-bonus-value" style="font-size: 12px;"></span>\n</div>'),e.prepend(n)),n}function Wt(t){const e=Lt();if(!e)return;const n=e.find("#chain-bonus-value");n.text(t.toFixed(2)),n.css("color",t>=Nt?"var(--crimes-stats-successes-color)":"var(--crimes-stats-fails-color)")}function Gt(){const t=Lt();if(!t)return;const e=t.find("#chain-bonus-value"),n={"-":"\\","\\":"|","|":"/","/":"-"}[e.text()]??"-";e.text(n),e.css("color","var(--crimes-stats-fails-color)")}function Ht(t){return parseInt(t.trim().replace(/,/g,""))}function Ut(){const e=t(".crimes-app .resultCounts___n3YFJ"),n=Ht(e.find(".resultCount___fQrld.successes___INKxs").text()),a=Ht(e.find(".resultCount___fQrld.fails___qSMlw").text()),o=Ht(e.find(".resultCount___fQrld.criticalFails___Mw26L").text()),i=n-jt.success,r=a-jt.fail,s=o-jt.critical;jt.success=n,jt.fail=a,jt.critical=o,isNaN(n)||isNaN(a)||isNaN(o)||(isNaN(i)||isNaN(r)||isNaN(s)?Wt(Rt.bonus):i+r+s!==1||i<0||r<0||s<0||(Rt.bonus=s>0?0:(Rt.bonus+i)/2**r,Wt(Rt.bonus),zt()))}async function qt(){await Bt();const e=new MutationObserver(Ut),n=setInterval(()=>{const a=t(".crimes-app");a.length>0&&(e.observe(a[0],{childList:!0,subtree:!0}),clearInterval(n))},200)}qt()}if(gym_show_ratio&&window.location.href.indexOf("gym.php")>=0){const Xt={0:{name:"balanced",description:"平衡比例",str:100,def:100,spd:100,dex:100},1:{name:"hank-str",description:"Hank比例-Str最高",str:100,def:80,spd:28,dex:80},2:{name:"hank-def",description:"Hank比例-Def最高",str:80,def:100,spd:80,dex:28},3:{name:"hank-spd",description:"Hank比例-Spd最高",str:28,def:80,spd:100,dex:80},4:{name:"hank-dex",description:"Hank比例-Dex最高",str:80,def:28,spd:80,dex:100},5:{name:"baldr-str",description:"Baldr比例-Str最高",str:100,def:72,spd:80,dex:72},6:{name:"baldr-def",description:"Baldr比例-Def最高",str:72,def:100,spd:72,dex:80},7:{name:"baldr-spd",description:"Baldr比例-Spd最高",str:80,def:72,spd:100,dex:72},8:{name:"baldr-dex",description:"Baldr比例-Dex最高",str:72,def:80,spd:72,dex:100}},Jt={1:{name:"Premier Fitness",stage:1,cost:10,energy:5,strength:20,speed:20,defense:20,dexterity:20,note:""},2:{name:"Average Joes",stage:1,cost:100,energy:5,strength:24,speed:24,defense:27,dexterity:24,note:""},3:{name:"Woody's Workout Club",stage:1,cost:250,energy:5,strength:27,speed:32,defense:30,dexterity:27,note:""},4:{name:"Beach Bods",stage:1,cost:500,energy:5,strength:32,speed:32,defense:32,dexterity:0,note:""},5:{name:"Silver Gym",stage:1,cost:1e3,energy:5,strength:34,speed:36,defense:34,dexterity:32,note:""},6:{name:"Pour Femme",stage:1,cost:2500,energy:5,strength:34,speed:36,defense:36,dexterity:38,note:""},7:{name:"Davies Den",stage:1,cost:5e3,energy:5,strength:37,speed:0,defense:37,dexterity:37,note:""},8:{name:"Global Gym",stage:1,cost:1e4,energy:5,strength:40,speed:40,defense:40,dexterity:40,note:""},9:{name:"Knuckle Heads",stage:2,cost:5e4,energy:10,strength:48,speed:44,defense:40,dexterity:42,note:""},10:{name:"Pioneer Fitness",stage:2,cost:1e5,energy:10,strength:44,speed:46,defense:48,dexterity:44,note:""},11:{name:"Anabolic Anomalies",stage:2,cost:25e4,energy:10,strength:50,speed:46,defense:52,dexterity:46,note:""},12:{name:"Core",stage:2,cost:5e5,energy:10,strength:50,speed:52,defense:50,dexterity:50,note:""},13:{name:"Racing Fitness",stage:2,cost:1e6,energy:10,strength:50,speed:54,defense:48,dexterity:52,note:""},14:{name:"Complete Cardio",stage:2,cost:2e6,energy:10,strength:55,speed:57,defense:55,dexterity:52,note:""},15:{name:"Legs, Bums and Tums",stage:2,cost:3e6,energy:10,strength:0,speed:55,defense:55,dexterity:57,note:""},16:{name:"Deep Burn",stage:2,cost:5e6,energy:10,strength:60,speed:60,defense:60,dexterity:60,note:""},17:{name:"Apollo Gym",stage:3,cost:75e5,energy:10,strength:60,speed:62,defense:64,dexterity:62,note:""},18:{name:"Gun Shop",stage:3,cost:1e7,energy:10,strength:65,speed:64,defense:62,dexterity:62,note:""},19:{name:"Force Training",stage:3,cost:15e6,energy:10,strength:64,speed:65,defense:64,dexterity:68,note:""},20:{name:"Cha Cha's",stage:3,cost:2e7,energy:10,strength:64,speed:64,defense:68,dexterity:70,note:""},21:{name:"Atlas",stage:3,cost:3e7,energy:10,strength:70,speed:64,defense:64,dexterity:65,note:""},22:{name:"Last Round",stage:3,cost:5e7,energy:10,strength:68,speed:65,defense:70,dexterity:65,note:""},23:{name:"The Edge",stage:3,cost:75e6,energy:10,strength:68,speed:70,defense:70,dexterity:68,note:""},24:{name:"George's",stage:3,cost:1e8,energy:10,strength:73,speed:73,defense:73,dexterity:73,note:""},25:{name:"Balboas Gym",stage:4,cost:5e7,energy:25,strength:0,speed:0,defense:75,dexterity:75,note:"Requirements must be maintained to preserve access to this gym"},26:{name:"Frontline Fitness",stage:4,cost:5e7,energy:25,strength:75,speed:75,defense:0,dexterity:0,note:"Requirements must be maintained to preserve access to this gym"},27:{name:"Gym 3000",stage:4,cost:1e8,energy:50,strength:80,speed:0,defense:0,dexterity:0,note:"Requirements must be maintained to preserve access to this gym"},28:{name:"Mr. Isoyamas",stage:4,cost:1e8,energy:50,strength:0,speed:0,defense:80,dexterity:0,note:"Requirements must be maintained to preserve access to this gym"},29:{name:"Total Rebound",stage:4,cost:1e8,energy:50,strength:0,speed:80,defense:0,dexterity:0,note:"Requirements must be maintained to preserve access to this gym"},30:{name:"Elites",stage:4,cost:1e8,energy:50,strength:0,speed:0,defense:0,dexterity:80,note:"Requirements must be maintained to preserve access to this gym"},31:{name:"The Sports Science Lab",stage:4,cost:5e8,energy:25,strength:90,speed:90,defense:90,dexterity:90,note:"The use of drugs may result in the loss of membership without refunds"},32:{name:"Unknown",stage:4,cost:2147483647,energy:10,strength:100,speed:100,defense:100,dexterity:100,note:"Membership by invite only"},33:{name:"The Jail Gym",stage:0,cost:0,energy:5,strength:34,speed:34,defense:46,dexterity:0,note:""}};t("#gymroot").after('\n<div>\n<div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">锻炼比例推荐\n</div>\n<div class="cont-gray bottom-rounded content" style="overflow:hidden; margin-bottom:10px;">\n<div class="select-wrap" style="margin:5px; float:left">\n<select id="gym-ratio" style="height:24px">\n</select>\n</div>\n<div class="select-wrap" style="margin:5px 1px; float:left">\n<p id="gym-ratio-info" style="height:12px; padding:6px 1px;">\n</p>\n</div>\n</div>\n<div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">按照当前健身房效果一枪25E超过多少钱可以放弃GYM吃SE\n</div>\n<div class="cont-gray bottom-rounded content" style="margin-bottom:10px;padding:4px;">\n<table id="se-table" style="">\n<tr><td>Strength</td><td class="value">$0</td></tr>\n<tr><td>Defense</td><td class="value">$0</td></tr>\n<tr><td>Speed</td><td class="value">$0</td></tr>\n<tr><td>Dexterity</td><td class="value">$0</td></tr>\n</table>\n</div>\n</div>'),t("#se-table").find("td").attr("style","font-size: 18px; border: 4px solid darkgray; padding:6px; text-align:center;");for(let te in Xt)t("#gym-ratio").append(`<option value="${te}">${Xt[te].description}</option>`);function Kt(e,n,a,o){const i=t("[class^='gymContent___']").children("[class^='properties___']").children("li");let r={};t('div[class^="propertyTitle___"]').each(function(){const e=t(this).find('h3[class^="title___"]').text().trim(),n=t(this).find('span[class^="propertyValue___"]').text().trim().split(",").join("");r[e]=n});const s=Math.max(r.Strength/e,r.Defense/n,r.Speed/a,r.Dexterity/o),l=Math.abs(s*e-r.Strength)<=1?r.Strength:parseInt(s*e),d=Math.abs(s*n-r.Defense)<=1?r.Defense:parseInt(s*n),c=Math.abs(s*a-r.Speed)<=1?r.Speed:parseInt(s*a),p=Math.abs(s*o-r.Dexterity)<=1?r.Dexterity:parseInt(s*o),h=[l,d,c,p],f=[l-r.Strength,d-r.Defense,c-r.Speed,p-r.Dexterity];let u=0;t(".gym-goal").remove(),i.each(function(){const e=t(this).children("[class^='propertyContent___']").children("[class^=description___]").children("p:first");0==e.children(".gym-perks").length?e.html(`<span class="t-red gym-goal" title="目标:${y(h[u])}">还差:${v(f[u])} </span>`):e.prepend(`<span class="t-red gym-goal" title="目标:${y(h[u])}">还差:${v(f[u])} </span>`),u++})}setInterval(Yt,2e3);function Yt(){const e=t("[class^='gymContent___']").children("[class^='properties___']").children("li");"1"!=e.first().attr("hasdone")&&e.length>0&&(e.first().attr("hasdone","1"),new Promise((t,e)=>{fetch(`https://api.torn.com/user/?selections=perks&key=${o}`).then(t=>{if(t.ok)return t.json();console.log("---探测失败---")},t=>{console.log("---网络异常---")}).then(n=>{if(null!=n)if("error"in n)e(n.error);else{let e=[{},{},{},{}];for(let t in n){const a=n[t],o=t.split("_")[0];for(let t=0;t<a.length;t++)if(a[t].search(/strength gym gains/i)>=0){const n=parseInt(/\d+%/.exec(a[t])[0].replace("%",""));e[0][o]=e[0].hasOwnProperty(o)?e[0][o]+n:n}else if(a[t].search(/defense gym gains/i)>=0){const n=parseInt(/\d+%/.exec(a[t])[0].replace("%",""));e[1][o]=e[1].hasOwnProperty(o)?e[1][o]+n:n}else if(a[t].search(/speed gym gains/i)>=0){const n=parseInt(/\d+%/.exec(a[t])[0].replace("%",""));e[2][o]=e[2].hasOwnProperty(o)?e[2][o]+n:n}else if(a[t].search(/dexterity gym gains/i)>=0){const n=parseInt(/\d+%/.exec(a[t])[0].replace("%",""));e[3][o]=e[3].hasOwnProperty(o)?e[3][o]+n:n}else if(a[t].search(/gym gains/i)>=0){const n=parseInt(/\d+%/.exec(a[t])[0].replace("%",""));e[0][o]=e[0].hasOwnProperty(o)?e[0][o]+n:n,e[1][o]=e[1].hasOwnProperty(o)?e[1][o]+n:n,e[2][o]=e[2].hasOwnProperty(o)?e[2][o]+n:n,e[3][o]=e[3].hasOwnProperty(o)?e[3][o]+n:n}}for(let t=0;t<e.length;t++){let n=1;for(let a in e[t])n*=(e[t][a]+100)/100;e[t].total=n}t(e),console.log("perks API fetched")}else e()}).catch(t=>e(t))}).then(function(n){const a=Jt[Vt()],o=[(a.strength/10).toFixed(1),(a.defense/10).toFixed(1),(a.speed/10).toFixed(1),(a.dexterity/10).toFixed(1)];let i=0;e.each(function(){const e=(100*(n[i].total-1)).toFixed(2),a=(n[i].total*o[i]).toFixed(3);let r="<strong>健身房系数:</strong> +"+o[i];r+="<br><strong>系数外总加成:</strong> +"+e+"%";for(let t in n[i])"total"!=t&&(r+="<br><strong>"+t+":</strong> +"+n[i][t]+"%");t(this).children("[class^='propertyContent___']").children("[class^=description___]").children("p:first").append(`<span class="t-green gym-perks" title="${r}">实际系数: ${a} </span>`);const s=Qt(t(this).children("[class^='propertyTitle___']").children("[class^='propertyValue___']").text().split(",").join(""),45e7,a,5025,25);t("#se-table").children().children(":eq("+i+")").children(".value").text(x(parseInt(s))),i++})}).catch(t=>console.log("getGymPerks "+t)))}function Vt(){const e=t("[class^='gymButton___'],[class*=' gymButton___']").filter("[class^='active___'],[class*=' active___']").find("[class^='gymIcon___'],[class*=' gymIcon___']");if(0===e.length)return"33";for(const t of e[0].classList){const e=t.match(/^gym-(\d+)___/);if(e)return e[1]}return"33"}function Qt(t,e,n,a,o){let i=5e7;t<5e7&&(i=t);return e/(.01*t)*(n*o*((3.480061091e-7*Math.log(a+250)+3091619094e-15)*i+682775184551527e-19*(a+250)-.0301431777))}const Zt=C("gym-ratio","ratio_number");if(null!=Zt){t("#gym-ratio").children("[value="+Zt+"]").attr("selected","true"),t("#gym-ratio-info").text(`Str : Def : Spd : Dex = ${Xt[Zt].str} : ${Xt[Zt].def} : ${Xt[Zt].spd} : ${Xt[Zt].dex}`);setInterval(()=>{t("[class^='gymContent___']").length>0&&Kt(Xt[Zt].str,Xt[Zt].def,Xt[Zt].spd,Xt[Zt].dex)},2e3)}t("#gym-ratio").change(function(){console.log("ratio changed");const e=t("#gym-ratio").val();M("gym-ratio","ratio_number",e),t("#gym-ratio-info").text(`Str : Def : Spd : Dex = ${Xt[e].str} : ${Xt[e].def} : ${Xt[e].spd} : ${Xt[e].dex}`),Kt(Xt[e].str,Xt[e].def,Xt[e].spd,Xt[e].dex)})}if(noAssisting&&window.location.href.indexOf("loader.php?sid=attack&user2ID")>=0){let ee=Math.floor(30*Math.random()+1),ne=300;const ae=setInterval(ie,100),oe=setInterval(re,100);function ie(){const e=t("[class^='btn_']");e.text().includes("Start fight")&&(e.prop("hidden",!0),e.parent().parent().children(":first").text("Wait ("+(ee/10).toFixed(1)+")s To Start fight"),0==ee&&(clearInterval(ae),e.parent().parent().children(":first").text(""),e.removeAttr("hidden")),ee--)}function re(){const e=t("[class^='btn_']");e.text().includes("Join fight")&&(e.prop("hidden",!0),e.parent().parent().children(":first").text("Wait ("+(ne/10).toFixed(1)+")s To Join fight 已有其他人进入此战斗"),0==ne&&(clearInterval(oe),e.parent().parent().children(":first").text(""),e.removeAttr("hidden")),ne--)}}if(window.location.href.indexOf("loader.php?sid=attack&user2ID")>=0){let se=100;setInterval(le,500);function le(){if(t("[class^=level]").length>0&&t("#log-header").length>0){const e=t("[class^=level]").attr("style").replace("height: ","").replace("%",""),n=parseFloat(e);if(n>se)return;se=n;const a=n>=66?"green":"red",o=n>=66?"高":"低";t("#stealth-value").remove();const i=t("#log-header").children(":first").attr("class");t("#log-header").children(":first").after(`\n<span id="stealth-value" class="${i}">隐身几率:&nbsp;\n<span class="t-${a}">${o}</span>\n&nbsp;Stealth:&nbsp;\n<span class="t-${a}">${n}%</span>\n</span>`)}}}if(window.location.href.indexOf("loader.php?sid=attack&user2ID")>=0){const de=setInterval(ce,1e3);function ce(){const e=t("#defender_Primary").siblings().last(),n=t("#defender_Secondary").siblings().last(),a=t("#defender_Melee").siblings().last();e.length>0&&(clearInterval(de),pe(e,0),pe(n,100),pe(a,200))}function pe(e,n){e.children().children().each(function(){const a=t(this).attr("title");a.length>0&&e.parent().parent().parent().parent().append(`\n<div style="position: absolute; z-index: 1; top: ${n}px; right: -420px; width: 400px; height: 42px; margin: 2px; border: 2px solid #000; background-color: ${p}; color: #eee; text-align: center;line-height: 20px;">${a}</div>`),n+=50})}}if(window.location.href.indexOf("loader.php?sid=attack&user2ID")>=0){const he=setInterval(fe,1e3);setInterval(ue,1e3);function fe(){const e=t("[class^='playersModelWrap___']").find("[class^='topWrap___']");2==e.length&&(clearInterval(he),e.each(function(){t(this).children(":first").after('<span class="bw-hp-percent"></span>')}))}function ue(){const e=t(".bw-hp-percent");2==e.length&&e.each(function(){const e=t(this).siblings("span[class^='userName___']").text(),n=t(this).siblings("div[class^='textEntries___']").find("[id^='player-health-value_']").text(),a=(n.split("/")[0].replace(",","").trim()/n.split("/")[1].replace(",","").trim()*100).toFixed(2);e&&a&&t(this).text(` (${a}%)`)})}}if(window.location.href.indexOf("loader.php?sid=attack&user2ID")>=0){const ge=setInterval(be,500);function be(){t("[class^=playerWindow___]").length>0&&t("#lower-layer").length<1&&(me(t("[class^=playerWindow___]"),"lower-layer"),clearInterval(ge))}function me(e,n){const a=window.location.href.substring(51),o=t("[class^=modal___]").css("background-color");e.last().append(`\n<div id="${n}" class="border-round" style="overflow: hidden; width:228px; height:26px; position: absolute; right: 0px; top: -2px; z-index: 9; color: #fff ;background-image: linear-gradient(${o},#888 25%,${o}); border: 1px solid #000; margin: 5px; text-align: center;">\n<div id="${n}-online" style="float: left; width:44px; height:16px; background-color: ${c}; border: 1px solid #000; margin: 4px 2px 4px 4px; text-align: center;"><div style="padding: 2px 0px">检测中</div></div>\n<div id="${n}-last" style="float: left; width:126px; height:16px; background-color: ${c}; border: 1px solid #000; margin: 4px 2px; text-align: center;"><div style="padding: 2px 0px">检测中</div></div>\n<div id="${n}-refresh-btn" style="cursor: pointer; float: left; width:36px; height:16px; background-color: ${l}; border: 1px solid #000; margin: 4px 4px 4px 2px; text-align: center;"><div style="padding: 2px 0px">刷新</div></div>\n</div>`),t("#"+n+"-refresh-btn").click(()=>{location.reload()}),N(a,function(e){if(null!=e&&"last_action"in e){const a=e.last_action.status;if("Online"==a?t("#"+n+"-online").css("background-color",d):"Idle"==a?t("#"+n+"-online").css("background-color",h):t("#"+n+"-online").css("background-color",s),t("#"+n+"-online").children().text(a),t("#"+n+"-last").children().text(e.last_action_details),e.faction.faction_id.toString()in i){const e=t("[class^=playerWindow___] .dialogButtons___nX4Bz");e.parent().css("border","5px solid red"),e.after('<div style="color: red; font-size: 20px; font-weight: bolder">这是友军</div>')}}else"error"in e&&t("#"+n+"-last").children().text("API读取失败")},function(e){t("#"+n+"-last").children().text("蛙蛙探测 "+a+" 失败 "+e)})}}function U(e){if(t("#nurse").length<1){function n(){let e=!1;t("li[class^=icon15__]").length>0&&(e=!0);fetch(`https://api.torn.com/user/?selections=profile,cooldowns,perks&key=${o}`).then(e=>{if(e.ok)return e.json();console.log("--- 小护士探测失败 ---"),t("#nurse-cd").text("--- 小护士探测失败 ---"),t("#nurse-container").show()},e=>{console.log("--- 小护士网络异常 ---"),t("#nurse-cd").text("--- 小护士网络异常 ---"),t("#nurse-container").show()}).then(a=>{if((e||a.life.current<a.life.maximum&&nurse_suggestion_out_of_hospital)&&null!=a)if("error"in a)t("#nurse-cd").text(`--- API错误 --- code: ${a.error.code} error: ${a.error.error}`);else if("basicicons"in a&&"icon15"in a.basicicons||a.life.current<a.life.maximum&&nurse_suggestion_out_of_hospital){function o(t){let e=parseInt(t/3600);e=e<10?"0"+e:e;let n=parseInt(t/60)%60;n=n<10?"0"+n:n;let a=t%60;return a=a<10?"0"+a:a,e+":"+n+":"+a}t("#nurse-container").show();let i=0,r=0,s=0,l=0;e&&(s=a.states.hospital_timestamp,l=s?s-parseInt((new Date).getTime()/1e3):0,i=o(l),r=Math.ceil(l/60));const d=100-(a.life.current||0)/(a.life.maximum||7500)*100,c=o(a.cooldowns.medical||0);let p=!1,h=0,f=0,u=0;if("education_perks"in a){const L=a.education_perks;L.indexOf("+ Withdraw and deliver blood")>=0&&(p=!0),L.indexOf("+ 20% medical item effectiveness")>=0&&(h=20),L.indexOf("+ 10% medical item effectiveness")>=0&&(h=10)}if("faction_perks"in a){a.faction_perks.forEach(function(t){t.indexOf("medical item effectiveness")>=0&&(f=t?parseInt(t.match(/\d+/)[0]):0),t.indexOf("minutes of maximum medical cooldown")>=0&&(u=t?parseInt(t.match(/\d+/)[0]):0)})}let g=6+parseInt(u/60);g=g<10?"0"+g:g;let b=u%60;b=b<10?"0"+b:b;const m=g+":"+b+":00",y=parseInt(h)+parseInt(f)+100;console.log(y);let x=0,v=0,w=0,_=0,k=0,$=0,I=0,S=0,D=0,C=0;e&&(console.log(r),C=z(r),console.log(C),x=0==$?"":"大血包*"+$,v=0==I?"":"吗啡*"+I,w=0==S?"":"小蓝包*"+S,_=0==D?"":"小红包*"+D,k=30*$+20*I+15*S+10*D);let A=0,M=0,T=0,F=0;const O=B(d);console.log(O);const E=0==A?"":"大血包*"+A,N=0==M?"":"吗啡*"+M,P=0==T?"":"小蓝包*"+T,R=0==F?"":"小红包*"+F,j=30*A+20*M+15*T+10*F;function z(t){return p&&t>.7*y?($+=1,z(t-1.2*y)):t>.4*y?(I+=1,z(t-.7*y)):t>.2*y?(S+=1,z(t-.4*y)):t>0?(D+=1,z(t-.2*y)):t}function B(t){return p&&t>.15*y?(A+=1,B(t-.3*y)):t>.1*y?(M+=1,B(t-.15*y)):t>.05*y?(T+=1,B(t-.1*y)):t>0?(F+=1,B(t-.05*y)):t}e?(t("#nurse-cd").text(`住院时间 ${i} 医疗冷却 ${c}/${m}`),t("#nurse-suggestion").text(`【出院模式】 ${x} ${v} ${w} ${_} (冷却 +${k}分钟)`)):(t("#nurse-cd").text(`医疗冷却 ${c}/${m}`),t("#nurse-suggestion").text("")),t("#nurse-eff").text(`抽血: ${p} 教育加成: +${h}% 帮派加成: +${f}%`),t("#nurse-item").text(`大血包: -${parseInt(1.2*y)}分钟 吗啡: -${parseInt(.7*y)}分钟 小蓝包: -${parseInt(.4*y)}分钟 小红包: -${parseInt(.2*y)}分钟`),t("#nurse-item-life").text(`大血包: 回血+${parseInt(.3*y)}% 吗啡: 回血+${parseInt(.15*y)}% 小蓝包: 回血+${parseInt(.1*y)}% 小红包: 回血+${parseInt(.05*y)}%`),t("#nurse-suggestion-life").text(`【满血模式】 ${E} ${N} ${P} ${R} (冷却 +${j}分钟)`),t("#nurse-cd").append('\n<button id="nurse-recalc" type="button" class="torn-btn">\n重新计算\n</button>\n'),t("#nurse-recalc").click(function(){n()})}}).catch(e=>{console.log("护士建议错误："+e),t("#nurse-cd").text(e),t("#nurse-container").show()})}t(e).before("\n<div style=\"margin-bottom:5px; display:none\" id=\"nurse-container\">\n<div id='nurse' style='color:#333;width:inherit;margin:auto;padding:10px;border:5px solid gray;background-color:#ccc;text-align:center;'>\n<div id='nurse-eff' style='font-size:12px;padding:2px;'></div>\n<div id='nurse-cd' style='font-size:24px;padding:2px;'>小护士竭诚为你服务</div>\n<div id='nurse-item' style='font-size:12px;padding:2px;'></div>\n<div id='nurse-suggestion' style='font-size:24px;padding:2px;'></div>\n<div id='nurse-item-life' style='font-size:12px;padding:2px;'></div>\n<div id='nurse-suggestion-life' style='font-size:24px;padding:2px;'></div>\n</div>\n</div>"),n()}}function q(e){if(null!==e.sharedData){const n=t("#faction-armoury-tabs div.armoury-tabs:visible ul.item-list > li");if(0===n.length)return;const a=Math.floor(Date.now()/1e3);n.each(function(){const n=t(this).find("[data-armoryid]").first().attr("data-armoryid"),o=e.sharedData[n];if(!o||!o.shared)return;if(t(this).find(".bw-shared-armory").length>0)return;const i=t('<div class="bw-shared-armory"><div></div></div>');o.factionId===e.factionId?(i.children().text(o.text??"公"),i.children().css("color",o.color??"white"),i.children().css("background",o.background??"#5d9525")):(i.children().text("外"),i.children().css("color","white"),i.children().css("background","#5d9525")),t(this).children(".name").append(i);const r=t(this).find('.loaned a[href^="/profiles.php?XID="]').first(),s=r.attr("href"),l=s?s.substr(18):void 0,d=e.lastActions[l];if(d){const t=a-d;let e="",n="";t<3600?(e=`${(t/60).toFixed(0)}m`,n="#5d9525"):t<86400?(e=`${(t/3600).toFixed(0)}h`,n="#DAA520"):(e=`${(t/86400).toFixed(0)}d`,n="#c0542f"),r.after(`<span style="color:white;background-color:${n};padding:4px;margin-left:4px;border-radius:4px">${e}</span>`)}})}else e.error}if(nurse_suggestion&&window.location.href.indexOf("item.php")>=0&&U(".tutorial-cont"),window.location.href.indexOf("factions.php?step=your")>=0){class ye{constructor(){this.sharedData=null,this.lastActions=null,this.factionId=null,this.error=null,this.load().then(()=>{q(this)})}async load(){try{const t=await P("https://bingwa-api.tornsmth.website/faction-armory/armory.json"),e=await(await fetch(`https://api.torn.com/faction/?selections=basic&key=${o}`)).json(),n=JSON.parse(t),a=n.expire,i=Math.floor((new Date).getTime()/1e3);!a||a<i?this.error="数据过期":this.sharedData=n.armory,this.lastActions={};for(const[t,n]of Object.entries(e.members))this.lastActions[t]=n.last_action.timestamp;this.factionId=e.ID}catch(t){this.sharedData=null,this.lastActions=null,this.error=t.toString(),console.log("Fail to load faction armory data:",t)}}}const xe=new ye;new MutationObserver(function(t,e){console.log("changed"),nurse_suggestion&&U("#faction-armoury-tabs"),q(xe)}).observe(document.getElementById("faction-armoury"),{childList:!0,subtree:!0})}if(taking_off_reminder&&window.location.href.indexOf("/page.php?sid=travel")>=0){function ve(){let e=t();t("li[class^=icon86__]").length>0&&(e=t("<div><div id='oc-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;\nbackground-color:NavajoWhite;text-align:center;'>OC准备就绪 点击前往执行</div></div>"),e.find("#oc-btn").click(function(){t(this).text("蛙蛙正在前往……"),window.location.href="https://www.torn.com/factions.php?step=your#/tab=crimes"})),e=t("li[class^=icon49__]").length>0?t("<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;\nbackground-color:#c0542f;text-align:center;'>DRUG CD 小于10分钟 先不要飞了哦</div></div>"):t("li[class^=icon50__]").length>0?t("<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;\nbackground-color:#DAA520;text-align:center;'>DRUG CD 不足1小时 先不要飞了哦</div></div>"):t("li[class^=icon51__]").length>0?t("<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;\nbackground-color:#5d9525;text-align:center;'>DRUG CD 为1-2小时之间 可尽情飞翔</div></div>"):t("li[class^=icon52__]").length>0?t("<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;\nbackground-color:#5d9525;text-align:center;'>DRUG CD 为2-5小时之间 可尽情飞翔</div></div>"):t("li[class^=icon53__]").length>0?t("<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;\nbackground-color:#5d9525;text-align:center;'>DRUG CD 大于5小时 可尽情飞翔</div></div>"):t("<div><div id='drug-btn' type='button' style='cursor:pointer;width:inherit;font-size:24px;margin:auto;padding:10px;border:5px solid gray;\nbackground-color:#5d9525;text-align:center;'>DRUG CD 为零 是不是忘吃药了</div></div>"),t("#travel-root").after(e)}const we=".destinationPanel___LsJ4v,.destinationList___fx7Gb";if(t(we).length>0)ve();else{const Se=t("#travel-root");if(1===Se.length){const De=new MutationObserver(function(){t(we).length>0&&(De.disconnect(),setTimeout(ve,100))});De.observe(Se[0],{childList:!0,subtree:!0})}}function _e(t){const e={day:86400,hour:3600,minute:60,second:1};let n=0;for(const a of Object.keys(e)){const o=t.match(new RegExp(`(\\d+) *${a}`,"i"));o&&(n+=parseInt(o[1])*e[a])}return n}function ke(){if(this.dataset.confirm){if(!confirm(this.dataset.msg))return}else alert(this.dataset.msg);t(this).hide(),t(this).siblings(".torn-btn").show()}function $e(e,n){if(e.hasClass("bw-oc-reminder-btn"))return;let a=e.closest(".flightDetailsGrid___uAttX").text().match(/flight time.*(\d\d):(\d\d)/i)??e.closest(".destination___kRlg6").text().match(/flight time.*(\d\d):(\d\d)/i);if(!a)return;const o=3600*parseInt(a[1])+60*parseInt(a[2]);if(e.attr("data-bw-flight")===o.toString())return;e.attr("data-bw-flight",o.toString()),e.show(),t(".bw-oc-reminder-btn").remove();const i=n-2*o;if(i>=7200)return;const r=t(`<button class="bw-oc-reminder-btn torn-btn btn-dark-bg"\nstyle="border: solid red" data-msg="${i>0?"OC 即将结束，请注意飞行时间，及时返程":n>0?"OC 即将结束，现在起飞将无法及时返程。还要坚持起飞吗？":"OC 已经结束，建议与队友沟通并在城中等待 OC 完成。即使耽误 OC 也要坚持起飞吗？"}">注意 OC</button>`);i<=0&&r.attr("data-confirm",!0),e.hide(),r.insertBefore(e).click(ke)}async function Ie(){try{const e=await(await fetch(`https://api.torn.com/user/?selections=icons&key=${o}`)).json(),n=e.icons.icon85||e.icons.icon86;if(!n)return;const[a,i,r]=n.split("-").map(t=>t.trim());if(i.match(/Blackmail|Kidnapping|Bomb Threat/i))return;const s=_e(r);new MutationObserver(function(){t("#travel-root .torn-btn").each(function(){$e(t(this),s)})}).observe(t("#travel-root")[0],{childList:!0,subtree:!0})}catch(t){console.log("Error in rendering OC reminder",t)}}Ie()}if(window.location.href.indexOf("factions.php?step=")>=0){setInterval(Me,3e3);class Ce{constructor(){this.wawa_cache=D("battlestats")||{};const t=D("BINGWA_TARGET")||[];this.bw_target_cache=Object.assign({},...t.map(t=>({[parseInt(t.ID)]:t.TOTAL})))}get(t){return this.bw_target_cache[t]||this.wawa_cache[t]}}const Ae=new Ce;function Me(){t("div.title").children("div.id").text("BS");const e=t("li.enemy,li.your").children("div.id");e.length>0&&e.each(function(e,n){const a=t(this).siblings("span").children("div.member").children("a.user.name"),o=a?a.attr("href"):void 0,i=o?o.substr(18):void 0;if(i){const e=Ae.get(i);e?t(this).text(Oe(e)):t(this).text("nil")}});const n=t(".faction-war li[class^='enemy']").parent(),a=t(".faction-war li[class^='enemy']").children("div.attack").children();if(a.length>0&&a.each(function(){if("1"!=t(this).attr("detected")){const e=t(this).closest("li[class^='enemy']").find('div.member a[href^="/profiles.php?XID="]'),n=e?e.attr("href"):void 0,a=n?n.substr(18):void 0;if(console.log(a),a){const e=Ae.get(a);e?(t(this).text(Oe(e)),t(this).attr("bs",e)):t(this).attr("bs",0)}}t(this).attr("detected","1")}),n.length>0&&"1"!=n.attr("hasdone")){n.attr("hasdone","1");Fe(n.siblings().children("div[class^='attack left attack___']"),Te)}}function Te(e){return t(e).find("[bs]").attr("bs")}function Fe(e,n){const a=e.parent().siblings(),o=e.parent().siblings().children();e.click(function(){"decend"==t(this).attr("sort")?(o.sort(function(t,e){return n(t)-n(e)}),o.detach().appendTo(a),t(this).attr("sort","ascend")):(o.sort(function(t,e){return n(e)-n(t)}),o.detach().appendTo(a),t(this).attr("sort","decend"))})}function Oe(t){return t>=1e15?"max":t>=1e13?parseInt(t/1e12)+"t":t>=1e12?(t/1e12).toFixed(1)+"t":t>=1e10?parseInt(t/1e9)+"b":t>=1e9?(t/1e9).toFixed(1)+"b":t>=1e7?parseInt(t/1e6)+"m":t>=1e6?(t/1e6).toFixed(1)+"m":t>=1e4?parseInt(t/1e3)+"k":t>=1e3?(t/1e3).toFixed(1)+"k":t}let Ee=setInterval(Pe,3e3),Ne=(setInterval(je,1e3),0);function Pe(){const e=t("[class^='status-wrap territoryBoxWp___']");if(e.length>0){console.log("war page detected"),clearInterval(Ee),Ne=setInterval(Re,3e3);const n=e.width()-6;e.each(function(){t(this).find(".timer").css("margin-left","-14px").css("margin-right","-14px").append('<span class="ttwar-end" style="width: auto; margin-left: 4px"></span>'),t(this).parent("[class~='red']").length>0?t(this).append(`<div class="ttwar-time border-round" style="width:${n}px; line-height:0.8; position: relative; left: 2px; top: -10px; z-index: 1;\ncolor: #fff ;background-image: linear-gradient(#ff7373,#fda8a8 25%,#ff7373); border: 1px solid #000; overflow: hidden;"></div>`):t(this).append(`<div class="ttwar-time border-round" style="width:${n}px; line-height:0.8; position: relative; left: 2px; top: -10px; z-index: 1;\ncolor: #fff ;background-image: linear-gradient(#83a000,#abc170 25%,#83a000); border: 1px solid #000; overflow: hidden;"></div>`)})}}function Re(){0===t("[class^='status-wrap territoryBoxWp___']").length&&(console.log("war page closed"),clearInterval(Ne),Ee=setInterval(Pe,3e3))}function je(){const e=t("[class^='status-wrap territoryBoxWp___']"),n=e.children(".ttwar-time");e.length>0&&n.length>0&&e.each(function(){const e=t(this).find(".timer").text().split("(")[0],n=parseInt(t(this).find(".swords-icon").parent().text()),a=parseInt(t(this).find(".shield-icon").parent().text()),o=t(this).find(".score").text(),i=m(o.split("/")[0]),r=m(o.split("/")[1]),s=r/5e4,l=parseInt((new Date).getTime()/1e3),d=ze(e),c=l+d,p=Math.abs(n-a);let h="",f="";if(n>=a){const t=Math.ceil((r-i)/s);if(t<=d){f=`最快: ${new Date(1e3*(l+t)).format("dd日hh:mm")}`;const e=Math.ceil((r-i)/p);h=e<=d?`攻: ${Be(e)} (${new Date(1e3*(l+e)).format("dd日hh:mm")})`:"当前进攻速度不足"}else h="防守成功"}else{let t=Math.ceil((i+d*s-r)/(p+s));const e=Math.ceil(i/p);t>e&&(t=d-5e4),t>0?(h=`守: ${Be(t)} (${new Date(1e3*(l+t)).format("dd日hh:mm")})`,e>0&&e<=d&&(f=`${Be(e)} 后清零`)):h="防守成功"}t(this).children(".ttwar-time").html(`\n<div style="float: left; padding: 4px 0px; margin-left: 4px;">${h}</div>\n<div style="float: right; padding: 4px 0px; margin-right: 4px;">${f}</div>\n`),t(this).find(".ttwar-end").text(`(${new Date(1e3*c).format("dd日hh:mm")})`)})}function ze(t){return 86400*parseInt(t.split(":")[0])+3600*parseInt(t.split(":")[1])+60*parseInt(t.split(":")[2])+parseInt(t.split(":")[3])}function Be(t){const e=parseInt(t/86400),n=e?e+"天":"",a=parseInt(t%86400/3600),o=parseInt(t%3600/60),i=t%60;return n+Le(a,2)+":"+Le(o,2)+":"+Le(i,2)}function Le(t,e){return t.toString().length>=e?t.toString():Le(t="0"+t,e)}}if(extra_recent_attacks&&window.location.href.indexOf("factions.php?step=")>=0){function We(t,e){const n=t.split(" ");let a=0;return"s"==n[1]?a=e-parseInt(n[0]):"m"==n[1]?a=e-parseInt(60*n[0]):"h"==n[1]&&(a=e-parseInt(3600*n[0])),a}function Ge(t,e){const n=e-t;let a="";return a=n<60?n+" s*":n<3600?parseInt(n/60)+" m*":n<86400?parseInt(n/3600)+" h*":"Inf",a}let He=[],Ue=[];setInterval(qe,6e3);function qe(){const e=t(".recent-attacks"),n=parseInt((new Date).getTime()/1e3);if(e.length>0){const a=Array.from(e.children("li")).slice(0,10);let o=[];for(let t=9;t>=0;t--)He.indexOf(a[t])<0&&o.push(a[t]);o.forEach(function(e,a){const o=t(e).children(".time").text();if(o.indexOf("s")>0||"1 m"==o||"2 m"==o||"3 m"==o||"4 m"==o){const t=We(o,n);Ue.push(t),He.push(e)}});let i=0;Ue.forEach(function(t,e){n-t>300&&(i=e+1)}),Ue=Ue.slice(i,Ue.length),He=He.slice(i,He.length),t(".extra-attacks").remove();for(let o=He.length-1;o>=0;o--)if(a.indexOf(He[o])<0){t(He[o]).addClass("extra-attacks");const a=Ge(Ue[o],n);t(He[o]).children(".time").text(a),e.append(He[o])}}else He=[],Ue=[]}}if(window.location.href.indexOf("page.php?sid=log")>=0){const Xe=setInterval(Je,1e3);function Je(){const e=t(".panel > div[class^=title]");0!==e.length&&(clearInterval(Xe),e.prepend('<button id="log-export-btn" class="torn-btn" style="margin:5px;">导出所选日志</button>'),t("#log-export-btn").click(async function(){const e=new Proxy(new URLSearchParams(window.location.search),{get:(t,e)=>t.get(e)}),n=e.cat?e.cat.split(","):[],a=e.log&&0===n.length?e.log.split(","):[];if(0===n.length&&0===a.length)return void alert("请选择日志类型");let i="注意：\n";i+="* 请勿同时使用其他频繁请求 API 的功能（例如：冰蛙目标、阅兵、犯罪经验）\n",i+="* 导出需要很长时间，请耐心等待\n",i+="* 若要取消，请刷新或关闭页面\n",alert("注意：\n* 请勿同时使用其他频繁请求 API 的功能（例如：冰蛙目标、阅兵、犯罪经验）\n* 导出需要很长时间，请耐心等待\n* 若要取消，请刷新或关闭页面\n");try{t(this).prop("disabled",!0),t(this).text("正在导出，请耐心等待");const i=await(await fetch(`https://api.torn.com/user/?selections=basic&key=${o}`)).json();if("error"in i)throw new Error(i.error.error);const r=Math.max(Math.ceil(a.length/10),1),s=[];for(let o=0;o<r;o++){const i=e=>{t(this).text(`正在导出，请耐心等待 (第 ${o+1}/${r} 批 ${new Date(1e3*e).format("yyyy-MM-dd")})`)},l=a.slice(10*o,10*(o+1));for await(const t of j(n,l,e.from,e.to,i))s.push(t)}s.sort((t,e)=>e.timestamp-t.timestamp);const l={user_id:i.player_id,user_name:i.name,timestamp:Math.floor((new Date).getTime()/1e3),categories:n,types:a,logs:s},d=`data:application/json;charset=utf-8,${encodeURIComponent(JSON.stringify(l))}`;t(this).replaceWith(`<a download="torn-log-${l.user_id}-${l.timestamp}.json" href="${d}"\nclass="torn-btn" style="color: #333; margin:5px; display:inline-block;">导出完毕，点击保存</a>`)}catch(e){console.trace(e),"Access level of this key is not high enough"===e.message?t(this).replaceWith('<a href="/preferences.php#tab=api">权限不足！请使用 Full Access 类型的 API Key</a>'):(t(this).text("出错啦！请刷新重试"),alert(`出错啦！${e}`))}}))}}if(window.location.href.indexOf("preferences.php")>=0){let Ke=setInterval(Qe,2e3),Ye=0;function Ve(){const e=t("[class^=api___]"),n=t("#name").attr("aria-expanded"),a=t("#name").attr("aria-hidden");e.length>0&&"false"==n&&"false"==a?console.log("apikey node heartbeat"):(console.log("apikey node closed"),clearInterval(Ye),t("#bingwa-apikey-setting").remove(),Ke=setInterval(Qe,2e3))}function Qe(){const e=t("[class^=api___]"),n=t("#name").attr("aria-expanded"),a=t("#name").attr("aria-hidden");if(e.length>0&&"false"==n&&"false"==a){console.log("apikey node detected"),clearInterval(Ke),Ye=setInterval(Ve,2e3),t(".content-title").after(`\n<div id="bingwa-apikey-setting">\n<div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">冰蛙APIKey设置</div>\n<div id="bingwa-apikey-setting-wrapper" class="cont-gray bottom-rounded content" style="overflow:hidden; margin-bottom:10px;">\n<div style="margin:5px;padding:5px;">你拥有的APIKey个数为 <span id="apikey-number" style="padding:3px;color:${f};font-size:18px;"></span> 个</div>\n<div style="margin:5px;padding:5px;">冰蛙当前使用的APIKey为 <span id="apikey-current" style="padding:3px;color:${f};font-size:18px;"></span></div>\n<div id= "apikey-wrapper"style="margin:5px;padding:5px;text-align:center;"></div>\n</div>\n</div>`);const e=t("[class^=keyRow]");t("#apikey-number").text(`${e.length}`),t("#apikey-current").text(`${window.localStorage.getItem("APIKey")}`),e.length>0?(e.each(function(){const e=t(this).children("[class^=key]").val(),n=t(this).children("[class^=blockTablet]").children("[class^=type]").val();t("#apikey-wrapper").append(`\n<div id="${e}" style="overflow:hidden;color:white;margin-top:5px;">\n<button class="key-btn torn-btn" style="float: left; line-height: 22px;">未使用</button>\n<div class="key-level border-round" style="float: left; width: 50px; height: 30px; margin: 0px 5px; background-color: #333; border: 1px solid #fff"></div>\n<div class="key-value border-round" style="float: left; width: 180px; height: 30px; background-color: #333; border: 1px solid #fff"></div>\n</div>\n`),e==window.localStorage.getItem("APIKey")?(t("#"+e).children("button").text("已使用").attr("disabled","true"),t("#"+e).children(".key-level").html(`<div style="padding: 3px 0px;">${n}</div>`).css("background-color",l),t("#"+e).children(".key-value").html(`<div style="padding: 6px 0px; font-size: 18px;">${e}</div>`).css("background-color",l)):(t("#"+e).children(".key-level").html(`<div style="padding: 3px;">${n}</div>`),t("#"+e).children(".key-value").html(`<div style="padding: 6px; font-size: 18px;">${e}</div>`))}),t(".key-btn").click(function(){t(".key-btn").each(function(){t(this).text("未使用").removeAttr("disabled"),t(this).siblings().css("background-color","#333")}),window.localStorage.setItem("APIKey",t(this).parent().attr("id")),t(this).text("已使用").attr("disabled","true"),t(this).siblings().css("background-color",l),t("#apikey-current").text(`${window.localStorage.getItem("APIKey")}`)})):t("#apikey-wrapper").text("没有已存在的APIKEY，请先创建一个然后刷新页面")}else console.log("apikey node heartbeat")}}else if(null==o||""==o)t("body").prepend('<div style="position: relative; z-index: 999; font-size: 16px; line-height: 1.6; padding: 10px; text-align: center; background: lightyellow;">\n<a href="/preferences.php#tab=api">宝鉴需要一个有效的 APIKey<br/>点击前往设置页面进行选择</a>\n</div>');else{const Ze=t("#sidebarroot").find("[class^='status-icons___']"),tn=t("#top-page-links-list").children("a");if(tn.length>0||Ze.length>0){console.log("当前页面有按钮，可以宝鉴");let Ln={user:["ammo","attacks","attacksfull","bars","basic","battlestats","bazaar","cooldowns","crimes","criminalrecord","discord","display","education","equipment","events","gym","hof","honors","icons","inventory","jobpoints","log","medals","merits","messages","missions","money","networth","newevents","newmessages","notifications","perks","personalstats","profile","properties","refills","reports","revives","revivesfull","skills","stocks","timestamp","travel","weaponexp","workstats"],property:["property","timestamp"],faction:["applications","armor","armorynews","attacknews","attacks","attacksfull","basic","boosters","caches","cesium","chain","chainreport","chains","checkPermissions","contributors","crimeexp","crimenews","crimes","currency","donations","drugs","fundsnews","mainnews","medical","membershipnews","positions","rankedwars","reports","revives","revivesfull","stats","temporary","territory","territorynews","timestamp","upgrades","weapons"],company:["applications","companies","detailed","employees","news","profile","stock","timestamp"],market:["bazaar","itemmarket","pointsmarket","timestamp"],torn:["bank","cards","chainreport","cityshops","companies","competition","dirtybombs","education","factiontree","getCards","getDirtyBombs","gyms","honors","itemdetails","items","itemstats","logcategories","logtypes","medals","organisedcrimes","pawnshop","pokertables","properties","rackets","raidreport","raids","rankedwarreport","rankedwars","rockpaperscissors","searchforcash","shoplifting","stats","stocks","territory","territorynames","territorywarreport","territorywars","timestamp"],key:["info"]},Wn="",Gn="",Hn="";if(shows_bingwa_icon){const qn='<li class="a_click_view_api_info icon6___XChW2" title="冰蛙宝鉴 呱" style="cursor: pointer; background-image:url(/images/v2/editor/emoticons.svg); background-position: -470px -42px;"></li>';Ze.prepend(qn)}const Un='<a role="button" style="cursor: pointer" aria-labelledby="events" class="a_click_view_api_info events t-clear h c-pointer  m-icon line-h24 right last"><span class="icon-wrap svg-icon-wrap"><span class="link-icon-svg events "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 17"><defs><style>.cls-1{opacity:0.35;}.cls-2{fill:#fff;}.cls-3{fill:#777;}</style></defs><g id="Ð¡Ð»Ð¾Ð¹_2" data-name="Ð¡Ð»Ð¾Ð¹ 2"><g id="icons"><g class="cls-1"><path class="cls-2" d="M8,1a8,8,0,1,0,8,8A8,8,0,0,0,8,1ZM6.47,3.87H9.53l-.77,7.18H7.24ZM8,14.55A1.15,1.15,0,1,1,9.15,13.4,1.14,1.14,0,0,1,8,14.55Z"></path></g><path class="cls-3" d="M8,0a8,8,0,1,0,8,8A8,8,0,0,0,8,0ZM6.47,2.87H9.53l-.77,7.18H7.24ZM8,13.55A1.15,1.15,0,1,1,9.15,12.4,1.14,1.14,0,0,1,8,13.55Z"></path></g></g></svg></span></span><span id="a_click_view_api_info_text">宝鉴</span></a>';tn.last().after(Un),t(".a_click_view_api_info").click(function(){if(t("#bwm").length<1){const e=t("#mainContainer")[0].clientWidth;let n=985;e<985&&(n=e);const i=`\n<div id="bwm" style="width:${n}px; margin: auto;">\n<div id="bwm-nav">\n<ul style="list-style-type: none;margin: 10px 0px;padding: 0;overflow: hidden;background-color: #333;">\n<li style="float: left">\n<a id="bwm-version" role="button" style="cursor: pointer;display: block;color: black;background-color: #4CAF50;text-align: center;padding: 14px 16px;text-decoration: none;" >版本记录</a>\n</li>\n<li style="float: left">\n<a id="bwm-api" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >查看API</a>\n</li>\n<li style="float: left">\n<a id="bwm-company" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >我的公司</a>\n</li>\n<li style="float: left">\n<a id="bwm-faction" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >帮派详情</a>\n</li>\n<li style="float: left">\n<a id="bwm-target" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >冰蛙目标</a>\n</li>\n<li style="float: left">\n<a id="bwm-chatlog" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >聊天记录</a>\n</li>\n<li style="float: left">\n<a id="bwm-addiction" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >毒瘾</a>\n</li>\n<li style="float: left">\n<a id="bwm-settings" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >设置</a>\n</li>\n<li style="float: right">\n<a id="bwm-return" role="button" style="cursor: pointer;display: block;color: white;text-align: center;padding: 14px 16px;text-decoration: none;" >返回</a>\n</li>\n</ul>\n</div>\n</div>`;t("#sidebarroot").hide(),t(".content-wrapper").hide(),t("#mainContainer").prepend(i);const r="cursor: pointer; display: block; color: black; background-color: #4CAF50; text-align: center; padding: 14px 16px; text-decoration: none;",l="cursor: pointer; display: block; color: white; text-align: center; padding: 14px 16px; text-decoration: none;";function d(e){t("#bwm-nav [id^=bwm-]").attr("style",l),t(e).attr("style",r)}function c(){const t=getVersion();return`\n<div id="version_container" style="width: inherit">\n<div style="text-align:center; margin-bottom: 10px;">\n<a role="button" style="cursor: pointer; font-size: large; color: #777;">冰蛙当前版本为 ${t[0]}</a>\n</div>\n<div style="text-align:center;">\n<textarea  style="height:800px;width:100%;background-color: lightgray; font-family:'Lucida Console', Monaco, monospace; font-size: 0.8rem;line-height: 1.3;" readonly="readonly">${t[1]}</textarea>\n</div>\n</div>`}function p(){let t="";for(let e in Ln)t+='<a role="button" style="cursor: pointer; font-size: large; color: #777;" class="a_click_api_type">'+e+"</a>&nbsp;&nbsp;";t+='<br /><br /><input type="text" id="api_input_id" name="api_input_id" placeholder="ID (当前用户不用填)" size="25" style="font-size: larger; padding: 3px;" />&nbsp;&nbsp;<input type="text" id="api_input_from_time" name="api_input_from_time" placeholder="From (Eg: 2019/10/25 23:00:00)" size="29" style="font-size: larger; padding: 3px;" />&nbsp;&nbsp;<input type="text" id="api_input_to_time" name="api_input_to_time" placeholder="To (Eg: 2019/10/26 08:00:00)" size="28" style="font-size: larger; padding: 3px;" />';let e='<div id="api_container"><div id="api_types_container" style="text-align:center; margin-bottom: 10px;">'+t+'</div><div id="api_fields_container" style="text-align:center; margin-bottom: 10px;"></div><div id="api_result_header" style="text-align:center; margin-bottom: 3px; font-size: large;"></div><div style="text-align:center;"><textarea id="api_result_container" rows="40" style="width:100%; background-color: lightgray; font-family:\'Lucida Console\', Monaco, monospace; font-size: 0.8rem;line-height: 1.3;" readonly="readonly" /><br /><a id="api_result_download_csv" role="button" style="cursor: pointer; font-size: large; color: #777;">导出为CSV文件</a>';return foo?e+='&nbsp;&nbsp;&nbsp;&nbsp;<a id="a_faction_parade" role="button" style="cursor: pointer; font-size: large; color: #777;">帮派大阅兵</a><a id="a_faction_parade_download" role="button" style="display:none">帮派大阅兵下载</a>&nbsp;&nbsp;&nbsp;&nbsp;<a id="a_faction_attacks" role="button" style="cursor: pointer; font-size: large; color: #777;">帮战统计</a><a id="a_faction_attacks_download" role="button" style="display:none">帮战统计下载</a></div></div>':e+="</div></div>",e}function u(){let t="";a.forEach(e=>{t+=`\n<tr style="height: 32px;">\n<td style="border:3px solid darkgray;padding:10px;color:#333;background-color:#ccc">${e.title}</td>\n<td style="border:3px solid darkgray;padding:10px;color:#333;background-color:#ccc">${e.desc}</td>\n<td style="border:3px solid darkgray;padding:10px;color:#333;background-color:#ccc">\n<select id="bwm_settings_${e.name}">\n<option value="false">关闭</option>\n<option value="true">打开</option>\n</select>\n</td>\n</tr>\n`});return`\n<div id="bwm_settings_container" style="width: inherit">\n<div id="bwm_settings_header" style="text-align:center; margin-bottom: 10px;">\n<table style="margin: auto">\n<tr>\n<td style="padding: 10px;">\n<span class="border-round" style="font-size: large; color: #333; background-color:#ccc; padding:5px;border:3px solid #333;">设置</span>\n</td>\n</tr>\n</table>\n</div>\n<div id="bwm_settings_table" style="text-align:center; margin-bottom: 10px;">\n<table style="border:1px solid darkgray; padding: 5px; margin: auto">\n<tr style="height: 32px;">\n<th style="border:3px solid darkgray;padding:10px;color:#ccc;background-color:#111;">功能名称</th>\n<th style="border:3px solid darkgray;padding:10px;color:#ccc;background-color:#111;">功能描述</th>\n<th style="border:3px solid darkgray;padding:10px;color:#ccc;background-color:#111;">功能状态</th>\n</tr>\n${t}\n</table>\n</div>\n</div>\n`}function g(){const e=t('\n<div style="width: inherit">\n<div style="margin:10px 0px; border:1px solid darkgray; text-align:center;">\n<button id="addiction-fast-btn" class="torn-btn addiction-analyze-btn" style="margin:5px;">快速分析</button>\n<button id="addiction-full-btn" class="torn-btn addiction-analyze-btn" style="margin:5px;">完整分析</button>\n<button id="addiction-faq-btn" class="torn-btn" style="margin:5px;">显示 FAQ</button>\n</div>\n<div id="addiction-faq" style="display: none; margin:10px 0px; padding: 10px; font-size: 100%; line-height: 1.6; color: #333; border:1px solid darkgray; overflow:hidden; overflow-x: auto;">\n<p style="font-size: larger"><b>"自动衰减" 是什么？</b></p>\n<p>毒瘾在每天 3:32 TCT 左右会自动减少 20 点。在临近这个时间点戒毒，或者长时间不能吃药时，最好留出一定量的毒瘾，避免浪费每天的自动衰减效果。</p>\n<br />\n<p style="font-size: larger"><b>"误差修正" 是什么？</b></p>\n<p>由于各种原因，冰蛙可能在计算毒瘾的过程中出现误差。戒毒日志中的百分比可以帮助修正这些误差，从而保证后续毒瘾数据的正确性。如果你看到连续多次戒毒日志都伴随着误差修正，那么说明误差一直没有被完全修正。下边是一些可能导致误差的原因：</p>\n<ul style="list-style: decimal inside">\n<li>你在没有帮派加成的情况下吃了药（比如换帮或者 RW 切技能时）。</li>\n<li>你某次戒毒时间与当日自然衰减比较接近。</li>\n<li><s>冰蛙代码有 bug。</s></li>\n</ul>\n<br />\n<p style="font-size: larger"><b>"找不到整数解" 和 "找不到计算起点" 是什么错误？</b></p>\n<p>冰蛙会根据历史上的一些戒毒日志推算毒瘾，但这个过程有可能会失败。下边是一些可能的原因：</p>\n<ul style="list-style: decimal inside">\n<li>你戒毒经常拉满到 100%。请每次至少少戒 1 格，多次这样的戒毒才能修复这个错误。</li>\n<li>你很久没有戒毒了。如果是这样，"快速分析" 有可能会失败，请尝试 "完整分析"。</li>\n<li>你还小。冰蛙需要多次戒毒记录才能计算出毒瘾。</li>\n<li><s>冰蛙代码有 bug。</s></li>\n</ul>\n<br />\n<p style="font-size: larger"><b>如何帮助冰蛙改进毒瘾算法？</b></p>\n<ul style="list-style: decimal inside">\n<li><a href="/page.php?sid=log&log=2200,2210,2220,2230,2240,2250,2260,2270,2280,2290,2295,2201,2211,2221,2231,2241,2251,2261,2271,2281,2291,6005,6504,6253,6720,6722,6723">点这里跳转至日志页面</a></li>\n<li>点击日志页面的 "<b>导出所选日志</b>" 按钮，并耐心等待，完成后再次点击该按钮，将数据保存至文件</li>\n<li>将导出的文件通过 QQ 发送给 tobytorn [1617955]</li>\n</ul>\n<br />\n<p style="font-size: larger"><b>这份日志里包含了哪些数据？</b></p>\n<ul style="list-style: decimal inside">\n<li title="日志类型: 2200, 2210, 2220, 2230, 2240, 2250, 2260, 2270, 2280, 2290, 2295, 2201, 2211, 2221, 2231, 2241, 2251, 2261, 2271, 2281, 2291">吃药记录</li>\n<li title="日志类型: 6005">戒毒记录</li>\n<li title="日志类型: 6504">使用 jp 减毒瘾的记录</li>\n<li title="日志类型: 6253, 6720, 6722, 6723">帮派进出记录</li>\n</ul>\n</div>\n<div style="margin:10px 0px; border:1px solid darkgray; text-align:center;">\n<table style="margin: 5px auto; max-width: 380px; background-color: white; font-size: 12px; line-height: 1.6; text-align: right;">\n<tr><th>当前毒瘾</th><td id="addiction-curr-ap" style="text-align: left"></td></tr>\n<tr><th style="white-space:nowrap">近期戒毒效率</th><td id="addiction-efficiency" style="text-align: left"></td></tr>\n<tr><th>戒毒建议</th><td style="text-align: left"><ul id="addiction-suggestion" style="list-style: decimal inside"></ul></td></tr>\n</table>\n<div id="addiction-status" style="text-align: center; margin: 5px;"></div>\n</div>\n<div style="min-height:700px;margin:10px 0px; border:1px solid darkgray; text-align:center; overflow:hidden; overflow-x: auto;">\n<table id="addiction-ap-records" style="margin: 5px auto; background-color: white; font-size:12px;">\n<tr class="head">\n<th>时间</th>\n<th>操作</th>\n<th>变化</th>\n<th>操作后毒瘾</th>\n<th>戒毒效率</th>\n</tr>\n</table>\n</div>\n</div>');return e.find("th").css({border:"1px solid darkgray",padding:"2px 5px","font-weight":"bold"}),e.find("td").css({border:"1px solid darkgray",padding:"2px 5px","min-width":"6em"}),e[0]}t("#bwm").append(c()),t("#bwm-version").click(function(){t("#bwm").children(":last").remove(),t("#bwm").append(c()),d("#bwm-version")}),t("#bwm-api").click(function(){t("#bwm").children(":last").remove(),t("#bwm").append(p()),d("#bwm-api"),t(".a_click_api_type").click(function(){t("#api_fields_container").empty(),Wn=t(this).text(),console.log("click: "+Wn);let e=Ln[Wn].sort();for(let n in e){let a=e[n];t("#api_fields_container").append('<a role="button" style="cursor: pointer; font-size: large; color: #777; margin-right: 4px" class="a_click_api_field">'+a+"</a> ")}t(".a_click_api_field").click(function(){t("#api_result_container").val("");let e=t(this).text(),n=t("#api_input_id").val(),a=t("#api_input_from_time").val(),i=new Date(a).getTime()/1e3,r=t("#api_input_to_time").val(),s=new Date(r).getTime()/1e3,l=`https://api.torn.com/${Wn}/${n}?selections=${e}&key=${o}&from=${i}&to=${s}`;(isNaN(i)||isNaN(s))&&(l=`https://api.torn.com/${Wn}/${n}?selections=${e}&key=${o}`),console.log(`Request: ${l}`),Hn=Wn+" - "+n+" - "+e+" - "+a+" - "+r,t("#api_result_header").text(`探测中: ${Hn}`),t("#api_result_download_csv").removeAttr("href"),t("#api_result_download_csv").removeAttr("download"),Gn="",fetch(l).then(e=>{if(e.ok)return e.json();t("#api_result_header").text(`探测失败: ${Hn}`)},e=>{t("#api_result_header").text(`网络异常: ${Hn}`)}).then(e=>{console.log(`Response: ${l}`),console.log(e),void 0!==e&&(t("#api_result_header").text(`探测完成: ${Hn}`),Gn=e,t("#api_result_container").val(JSON.stringify(e,null,4)))})})}),t("#api_result_download_csv").click(function(){if(null==Gn||""==Gn||null==Hn||""==Hn||"object"!=typeof Gn||Gn.length<1)return void alert("没有可导出的数据");let e=k(Gn);if(null==e)return void alert("没找到有效的数据集");let n=S(e);t(this).attr("href","data:text/csv;charset=utf-8,\ufeff"+n),t(this).attr("download",Hn+".csv")}),t("#a_faction_parade").click(function(){t("#api_result_container").val("");const e=t("#api_input_id").val();z("开始帮派大阅兵，将拉取帮派成员列表，然后逐个查询该成员的详细信息，再使用蛙蛙探测器增加分析结果，最后导出为csv文件。"),z("请注意："),z("1、此功能会调用很多次API接口，所以不要太频繁使用。"),z("2、为了避免太频繁被封接口，每次查询做了延时，所以运行时间较久，请耐心等待。"),z("3、如果想中途放弃，请直接关掉本网页窗口。");let n=`https://api.torn.com/faction/${e}?selections=basic&key=${o}`;t("#api_result_header").text(`帮派大阅兵 ${e}`),console.log(`Request: ${n}`),z("\n开始获取帮派成员列表"),fetch(n).then(t=>{if(t.ok)return t.json();z("阅兵失败")},t=>{z("阅兵失败，网络异常")}).then(a=>{console.log(`Response: ${n}`),console.log(a);const o=Object.keys(a.members),i=o.length;z(`获取帮派成员列表完成，共有 ${i} 个成员`);let r=new Array,s=0;function l(){const t=o[s];let e=a.members[t];e.userId=t,r.push(e),N(t,function(n){z(`蛙蛙探测 userId: ${t} 成功`),Object.assign(e,n),d()},function(e){z(`蛙蛙探测 userId: ${t} 失败`),d()})}function d(){if(s<i-1)++s,setTimeout(l,1e3);else{z("蛙蛙探测完成"),z("\n开始转换为csv格式...");let n=S(r);const a=t("#a_faction_parade_download");a.attr("href","data:text/csv;charset=utf-8,\ufeff"+n);let o=new Date;a.attr("download",`FactionParade_${e}_${o.format("yyyyMMdd_hhmm")}.csv`),z("转换为csv格式完成"),z("\n开始下载");let i=document.createEvent("MouseEvents");i.initEvent("click",!0,!0),document.getElementById("a_faction_parade_download").dispatchEvent(i)}}z("\n开始启动蛙蛙探测..."),l()})}),t("#a_faction_attacks").click(function(){const e=t("#api_input_from_time").val(),n=new Date(e);let a=n.getTime()/1e3;const i=t("#api_input_to_time").val(),r=new Date(i),s=r.getTime()/1e3;if(isNaN(a)||isNaN(a))return void alert("此功能必须输入起止时间（你的电脑本地时间，不要转为TCT）");t("#api_result_container").val(""),z("开始帮战统计，将自动切分时间段，拉取帮派attacks记录（每次最多100条），然后拼接，最后导出为csv文件。"),z("请注意："),z("1、此功能需要帮派API权限。"),z("2、此功能会调用很多次API接口，所以不要太频繁使用。"),z("3、每30秒才访问一次（因为测试发现数据有缓存），所以运行时间较久，请耐心等待。"),z("4、如果想中途放弃，请直接关掉本网页窗口。"),z(`\n开始时间：${e} 时间戳 ${a} ，结束时间：${i} 时间戳 ${s} \n`);let l=new Object;!function e(){const i=`https://api.torn.com/faction/?selections=attacks&key=${o}&from=${a}&to=${s}`;console.log(`Request: ${i}`),t("#api_result_header").text("帮战统计"),fetch(i).then(t=>{if(t.ok)return t.json();z("抓取失败，将1秒后重试"),setTimeout(e,1e3)},t=>{z("抓取失败，将1秒后重试"),setTimeout(e,1e3)}).then(o=>{function d(){z("\n攻击记录抓取完成，开始转换为csv格式...");let e=S(_(l));const a=t("#a_faction_attacks_download");a.attr("href","data:text/csv;charset=utf-8,\ufeff"+e),a.attr("download",`FactionAttacks_${n.format("yyyyMMddhhmmss")}_${r.format("yyyyMMddhhmmss")}.csv`),z("转换为csv格式完成"),z("\n开始下载");let o=document.createEvent("MouseEvents");o.initEvent("click",!0,!0),document.getElementById("a_faction_attacks_download").dispatchEvent(o)}console.log(`Response: ${i}`),console.log(o),Object.assign(l,o.attacks);const c=_(o.attacks);if(c.length>0){const t=c[0].timestamp_started,n=new Date(1e3*t),o=c[c.length-1].timestamp_started,i=new Date(1e3*o);z(`抓取 ${a} - ${s} 有 ${c.length} 条，第一条 ${t} ${n.format("yyyy/MM/dd hh:mm:ss")}，最后一条 ${o} ${i.format("yyyy/MM/dd hh:mm:ss")}，累计 ${Object.keys(l).length} 条`),o<a||o>s?c.length>1?(z("抓取的数据没有更新，准备重试"),setTimeout(e,1e4)):(z("系统会莫名其妙的卡在最后一条，直接完成"),d()):(a=o+2,setTimeout(e,30500))}else d()})}()})}),t("#bwm-company").click(function(){t("#bwm").children(":last").remove(),t("#bwm").append('\n<div id="mycompany_container" style="width: inherit">\n<div id="mycompany-head" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">\n<span id="companyname" role="button" style="font-size: large; color:#777;" >我的公司</span>\n</div>\n<div id="tips-view-company" style="text-align:center; margin-bottom: 3px; font-size: 4px;"></div>\n<div id="mycompany-content" style="min-height:400px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;"></div>\n</div>'),d("#bwm-company");const e=W();console.log("userId "+e),jn(e).then(function(e){console.log(e);const n=e[3];"Employee"===n?vn(t("#mycompany-content")):"Director"===n&&wn(t("#mycompany-content"))}).catch(t=>console.log("userId2otherIds "+t))}),t("#bwm-faction").click(function(){function e(){const e=window.localStorage.getItem("faction_compare_history");if(null!=e){const n=JSON.parse(e);for(let e in n)t("#bwm_faction_history").append(`\n<div class="wrapper-history" style="width:135px;float:left;border:1px solid darkgray;margin:5px 10px;">\n<div class="head-history" style="background-color:black;color:white;padding:5px;overflow:hidden;">\n<div class="id-history" style="width:30%;float:left;margin-left:50%;position:relative;left:-15%;overflow-x:clip;">${e}</div>\n<div style="float:right;cursor:pointer;background-color:white;color:black;padding:0px 2px;">\n<a class="delete-history" role="button" >X</a>\n</div>\n</div>\n<div class="content-history" style="background-color:var(--default-bg-panel-color);padding:5px;">\n<a style="width:100%;overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" class="user faction" href="/factions.php?step=profile&amp;ID=${e}" target="_blank">${n[e]}</a>\n</div>\n</div>`);t(".delete-history").click(function(){const e=t(this).parent().parent().children(".id-history").text();T("faction_compare_history",e),t(this).parent().parent().parent().remove(),console.log("删除成功: "+e)}),t(".head-history").click(function(){const e=t(this).siblings(".content-history");if("selected"==e.attr("selected"))e.css("background-color","white"),e.removeAttr("selected"),t("#faction-input-id").val("");else{t(".content-history").css("background-color","white"),t(".content-history").removeAttr("selected"),e.css("background-color","var(--default-bg-red-hover-color)"),e.attr("selected","selected");const n=t(this).children(".id-history").text();t("#faction-input-id").val(n)}})}}t("#bwm").children(":last").remove(),t("#bwm").append('\n<div id="bwm_faction_container" style="width: inherit">\n<div id="bwm_faction_header" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">\n<input type="text" id="faction-input-id" name="faction-input-id" placeholder="帮派 ID" size="10" style="font-size: larger; padding: 5px; margin: 5px;" />\n<button id="faction-load-btn" class="torn-btn" style="margin:5px;">读取帮派</button>\n<button id="faction-parade-start-btn" class="torn-btn" style="margin:5px;">开始阅兵</button>\n<button id="faction-parade-stop-btn" class="torn-btn" style="margin:5px;" disabled>停止阅兵</button>\n</div>\n<div id="bmw_faction_tips" style="text-align:center; margin-bottom: 3px; font-size: 4px;"></div>\n<div id="bwm_faction_history" style="margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden;"></div>\n<div id="bmw_faction_wrapper" style="min-height:700px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;"></div>\n</div>'),d("#bwm-faction"),e();let n=window.localStorage.getItem("MY_FACTION_ID");null==n&&(n="20465"),t("#faction-load-btn").click(function(){let a=t("#faction-input-id").val();a&&/^\d+$/.test(a)||(a=n,t("#faction-input-id").val(n));const i=t("#bmw_faction_wrapper").find("table.table-faction-table th[sort]"),r=i.index(),s=i.attr("sort");(function(n,a){a.empty(),a.append('\n<div id="name-faction" style="font-size: 20px; margin: 4px;"><img id="tag-faction" style="margin-right: 4px;"><span></span></div>\n<div id="rank-faction" style="margin: 2px;"></div>\n<div id="detail-faction" style="margin: 2px;"></div>\n<div id="table-faction">\n<table class="table-faction-table" style="margin:auto;background-color:var(--default-bg-panel-color);font-size:12px;">\n<tr class="head">\n<th class="table-online"></th>\n<th class="table-level">Lv</th>\n<th>Name</th>\n<th class="table-last">Last</th>\n<th class="table-status">Status</th>\n<th class="table-bs">BS</th>\n<th class="table-revivable">Revivable</th>\n<th>ID</th>\n<th class="table-position">Position</th>\n<th class="table-days">Days</th>\n<th>Description</th>\n</tr>\n</table>\n</div>'),t("#table-faction").find(".table-faction-table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;");const i=`https://api.torn.com/faction/${n}?selections=basic&key=${o}`,r=t("#bmw_faction_tips");return r.text("---探测中 "+n+"---"),fetch(i).then(t=>{if(t.ok)return t.json();r.text("---探测失败 "+n+"---")},t=>{r.text("---网络异常 "+n+"---")}).then(a=>{console.log("API fetched: "+n),null!=a&&r.text("---探测完成 "+n+"---"),t("#name-faction").children("span").text(`${a.name} - ${n}`),t("#tag-faction").attr("src",`https://factiontags.torn.com/${a.tag_image}`),t("#rank-faction").text(`Rank: ${a.rank.name} - ${a.rank.division}`),M("faction_compare_history",n,a.name),t("#bwm_faction_history").empty(),e(),t(".id-history").each(function(){t(this).text()==n&&t(this).parent().parent().children(".content-history").css("background-color","var(--default-bg-red-hover-color)")});const o=Object.keys(a.members).length,i=a.respect.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","});t("#detail-faction").text(`Members: ${o} | Resp: ${i} | Best Chain: ${a.best_chain}`),t.each(a.members,function(e,n){const a=e,o=fn(a),i=gn(n.last_action.timestamp),r=n.status.state,s=n.status.description,l=n.status.until,d=n.status.color,c=bn(s,r,l),p=c[0].startsWith("海")?nn[c[2]].name+c[0].slice(1):c[0],h=un(a);let f="var(--default-color)";"Leader"!=n.position&&"Co-leader"!=n.position||(f="var(--default-red-color)");let u="grey",g=1;"Online"==n.last_action.status?(u="DarkSeaGreen",g=3):"Idle"==n.last_action.status&&(u="Orange",g=2);const b=`\n<tr class="content">\n<td class="table-online" code="${g}" style="border: 1px solid darkgray; min-width: 20px; background-color:${u}"></td>\n<td class="table-level" style="border: 1px solid darkgray;padding:5px;color:var(--default-color);">${n.level}</td>\n<td style="border: 1px solid darkgray;padding:5px;"><a class="user name" href="/profiles.php?XID=${a}" target="_blank">${n.name}</a></td>\n<td class="table-last" style="border: 1px solid darkgray;padding:5px;color:var(--default-color);" last-action-minutes="${i[0]}">${i[1]}</td>\n<td class="table-status t-${d}" style="border: 1px solid darkgray;padding:5px;" hospital-seconds="${c[1]}" hospital-location="${c[2]}">${p}</td>\n<td class="table-bs t-blue" style="border: 1px solid darkgray;padding:5px" estimate-bs="${o[0]}">\n<a style="text-decoration:none;" href="/loader.php?sid=attack&user2ID=${a}" target="_blank">${o[2]||"Attack"}</a>\n</td>\n<td class="table-revivable" style="border: 1px solid darkgray;padding:5px;color:var(--default-color);">${h}</td>\n<td style="border: 1px solid darkgray;padding:5px;text-align:right;color:var(--default-color);">${a}</td>\n<td class="table-position" style="border:1px solid darkgray;padding:5px;color:${f};">${n.position}</td>\n<td class="table-days" style="border: 1px solid darkgray;padding:5px;color:var(--default-color);">${n.days_in_faction}</td>\n<td style="border: 1px solid darkgray;padding:5px;color:var(--default-color);">${n.status.details}</td>\n</tr>`;t("#table-faction").children(".table-faction-table").children().append(b)})}).catch(t=>console.log("fetch error",t))})(a,t("#bmw_faction_wrapper")).then(function(){if(F(t("th.table-bs"),hn),F(t("th.table-last"),cn),F(t("th.table-status"),pn),F(t("th.table-online"),rn),F(t("th.table-level"),on),F(t("th.table-position"),ln),F(t("th.table-days"),dn),F(t("th.table-revivable"),sn),r>=0){const e=t("#bmw_faction_wrapper").find(`table.table-faction-table th:nth-child(${r+1})`);e.attr("sort","ascend"===s?"descend":"ascend"),e.click()}})});let a=!0;t("#faction-parade-start-btn").click(function(){a=!0,t("#faction-load-btn").prop("disabled",!0),t("#faction-parade-start-btn").prop("disabled",!0),t("#faction-parade-stop-btn").removeAttr("disabled"),t("tr.head").attr("style","pointer-events: none;");const e=t(".table-faction-table").children().children("tr.content").first();if(e.length<=0)return t("#bmw_faction_tips").text("未找到用户列表"),t("#faction-load-btn").removeAttr("disabled"),t("#faction-parade-start-btn").removeAttr("disabled"),t("#faction-parade-stop-btn").prop("disabled",!0),void t("tr.head").removeAttr("style");function n(e){if("1"==e.attr("detected"))t("#bmw_faction_tips").text("用户已完成"),setTimeout(()=>{n(e.next())},0);else{if(e.length<=0||0==a)return t("#bmw_faction_tips").text("阅兵已结束"),t("#faction-load-btn").removeAttr("disabled"),t("#faction-parade-start-btn").removeAttr("disabled"),t("#faction-parade-stop-btn").prop("disabled",!0),void t("tr.head").removeAttr("style");{e.attr("detected","1");const a=e.find("a.user.name").attr("href").replace(/[^0-9|-]/gi,"");t("#bmw_faction_tips").text("正在阅兵: "+a),N(a,function(t){e.children("td.table-bs").text(v(t.estimate_bs)),e.children("td.table-bs").attr("estimate-bs",t.estimate_bs),M("battlestats",a,t.estimate_bs),e.children("td.table-revivable").text(t.revivable),M("revivable",a,t.revivable),setTimeout(()=>{n(e.next())},1e3)},function(o){t("#bmw_faction_tips").text("蛙蛙探测 "+a+" 失败 "+o),setTimeout(()=>{n(e.next())},1e3)})}}}t("#bmw_faction_tips").text("阅兵开始"),setTimeout(()=>{n(e)},1e3)}),t("#faction-parade-stop-btn").click(function(){a=!1})}),t("#bwm-target").click(function(){t("#bwm").children(":last").remove(),t("#bwm").append('\n<div id="bwm_target_container" style="width: inherit">\n<div id="bwm_target_header" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">\n<button id="target-load-excel" class="torn-btn" style="margin:5px;">加载本地excel文件</button>\n<button id="target-clear-cache" class="torn-btn" style="margin:5px;" disabled>清除缓存</button>\n</div>\n<input type="file" id="file" style="display: none;" accept=".csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"/>\n<div id="bmw_target_tips" style="text-align:center; margin-bottom: 3px; font-size: 4px;">请按以下模板来导入表格 仅限xlsx或csv格式</div>\n<div id="bmw_target_wrapper" style="min-height:700px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;">\n<table style="margin: auto;">\n<tr>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: white;"></th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">A</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">B</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">C</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">D</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">E</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">F</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">G</th>\n</tr>\n<tr>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">1</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">Name</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">ID</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">STR</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">DEF</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">SPD</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">DEX</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">TOTAL</td>\n</tr>\n<tr>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: gray; color: green; font-weight: bold; text-align: center;">2</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">GoodLuck</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">2356929</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">200,000,000</td>\n<td style="border: 1px solid darkgray; padding: 5px; background-color: white; color: black; text-align: center;">800,000,000</td>\n</tr>\n</table>\n</div>\n\n</div>'),d("#bwm-target");let e=0;window.localStorage.setItem("BINGWA_TARGET_FLAG","");const n=window.localStorage.getItem("BINGWA_TARGET");let a=n?JSON.parse(n):{};function i(e,n){function a(t,e){"off"==e?t.parent().addClass("hide"):"on"==e&&t.parent().removeClass("hide")}t("."+{Online:"target-online",Idle:"target-online",Offline:"target-online","在城内":"target-status","在城外":"target-status","住院时间<=5m":"target-status","住院时间>5m":"target-status","FF>=2.0":"target-fairfight","FF<2.0":"target-fairfight"}[e]).each(function(){t(this).text()==e?a(t(this),n):"在城内"==e?"town"==t(this).attr("hospital-location")&&a(t(this),n):"在城外"==e?"town"!==t(this).attr("hospital-location")&&a(t(this),n):"住院时间<=5m"==e?t(this).attr("hospital-seconds")<=300&&a(t(this),n):"住院时间>5m"==e?t(this).attr("hospital-seconds")>300&&a(t(this),n):"FF>=2.0"==e?t(this).text()>=2&&a(t(this),n):"FF<2.0"==e&&t(this).text()<2&&a(t(this),n)})}function r(n){if(0==n.length)return;const i=Object.values(n)[0];if("ID"in i){const n=i.ID;console.log(n),jn(n).then(function(n){console.log("arr "+n),e=setInterval(()=>{!function(n){if(a.length<=0||t(".target-id").length<=0)return window.localStorage.setItem("BINGWA_TARGET_FLAG",""),clearInterval(e),void console.log("faction api refreshing ended");window.localStorage.setItem("BINGWA_TARGET_FLAG","refreshing");const i=`https://api.torn.com/faction/${n}?selections=basic&key=${o}`,r=t("#bmw_target_tips");r.text("---刷新中---"),fetch(i).then(t=>{if(t.ok)return t.json();r.text("---探测失败 "+n+"---")},t=>{r.text("---网络异常 "+n+"---")}).then(e=>{console.log("faction api refreshed"),t.each(e.members,function(e,n){t(".target-id").each(function(){if(e==t(this).text()){const e=n.last_action.status;let a=h;"Online"==e?a=f:"Offline"==e&&(a=s),t(this).siblings(".target-online").css({"background-color":a,color:"white"}).text(e);const o=gn(n.last_action.timestamp);t(this).siblings(".target-last").attr("last-action-seconds",o[0]).attr("timestamp",n.last_action.timestamp).text(o[1]);const i=bn(n.status.description,n.status.state,n.status.until);let r="var(--default-bg-green-hover-color)";"red"==n.status.color?r="var(--default-bg-red-hover-color)":"blue"==n.status.color&&(r="var(--default-bg-blue-hover-color)"),t(this).siblings(".target-status").attr("hospital-seconds",i[1]).attr("hospital-location",i[2]).attr("description",n.status.description).attr("state",n.status.state).attr("until",n.status.until).css({"background-color":r,color:"var(--default-color)"}).text(i[0]),t(this).siblings(".target-level").text(n.level);const l=t(this).siblings(".target-fairfight").text();if(l!=isNaN){const e=.25*l*(Math.log(n.level)+1);t(this).siblings(".target-flatrespect").text(e.toFixed(2))}let d=[];t("#filters").find("[status='on']").each(function(){d.push(t(this).text())});const c=function(t,e,n,a,o){let i=1,r=1,s=1,l=1;i=t.includes(e)?1:0;r=t.includes("在城内")&&"town"==n||t.includes("在城外")&&"town"!==n?1:0;s=t.includes("住院时间<=5m")&&a<=300||t.includes("住院时间>5m")&&a>300?1:0;l=t.includes("FF>=2.0")&&o>=2||t.includes("FF<2.0")&&o<2?1:0;return i*r*s*l}(d,e,i[2],i[1],l);0==c?t(this).parent().addClass("hide"):1==c&&t(this).parent().removeClass("hide")}})})}).then(function(){return new Promise(function(t,e){setTimeout(function(){t()},1e3)})}).then(function(){t(".target-last").length>0&&(console.log("fake refresh 1"),t(".target-last").each(function(){const e=t(this).attr("timestamp");if(null==e)return!0;const n=gn(e);t(this).attr("last-action-seconds",n[0]).text(n[1]);const a=bn(t(this).siblings(".target-status").attr("description"),t(this).siblings(".target-status").attr("state"),t(this).siblings(".target-status").attr("until"));t(this).siblings(".target-status").attr("hospital-seconds",a[1]).text(a[0])}))}).then(function(){return new Promise(function(t,e){setTimeout(function(){t()},1e3)})}).then(function(){t(".target-last").length>0&&(console.log("fake refresh 2"),t(".target-last").each(function(){const e=t(this).attr("timestamp");if(null==e)return!0;const n=gn(e);t(this).attr("last-action-seconds",n[0]).text(n[1]);const a=bn(t(this).siblings(".target-status").attr("description"),t(this).siblings(".target-status").attr("state"),t(this).siblings(".target-status").attr("until"));t(this).siblings(".target-status").attr("hospital-seconds",a[1]).text(a[0])}))}).catch(t=>console.log("fetch error",t))}(n[0])},3e3)}).catch(t=>console.log("startRefreshing "+t))}}function l(){const e=`https://api.torn.com/user/?selections=battlestats&key=${o}`,n=t("#bmw_target_tips");n.text("---BS探测中---"),fetch(e).then(t=>{if(t.ok)return t.json();n.text("---BS探测失败---")},t=>{n.text("---BS网络异常---")}).then(e=>{if(null!=e)if("error"in e)n.text(e.error);else{const n=Math.sqrt(e.strength)+Math.sqrt(e.defense)+Math.sqrt(e.speed)+Math.sqrt(e.dexterity);console.log("My score:"+n),t(".target-fairfight").each(function(){const a=y(t(this).siblings(".target-str").text()),o=y(t(this).siblings(".target-def").text()),i=y(t(this).siblings(".target-spd").text()),r=y(t(this).siblings(".target-dex").text()),s=y(t(this).siblings(".target-total").text());let l=((Math.sqrt(a)+Math.sqrt(o)+Math.sqrt(i)+Math.sqrt(r))/n*8/3+1).toFixed(2);l>=3&&(l=3..toFixed(2)),t(this).text(l);const d=s/e.total,c=d.toFixed(2),p=t(this).siblings(".target-total");d>=1.3?p.css("color","var(--default-base-important-color)").attr("title","是你属性的"+c+"倍"):d>=1.1?p.css("color","var(--default-red-color)").attr("title","是你属性的"+c+"倍"):d>=.9?p.css("color","var(--default-base-brown-color)").attr("title","是你属性的"+c+"倍"):d>=.7?p.css("color","var(--default-base-gold-color)").attr("title","是你属性的"+c+"倍"):d>=.5?p.css("color","var(--default-base-green-color)").attr("title","是你属性的"+c+"倍"):d>=.3?p.css("color","var(--default-green-color)").attr("title","是你属性的"+c+"倍"):p.css("color","var(--default-base-grey1-color)").attr("title","是你属性的"+c+"倍")})}else n.text("error")}).catch(t=>console.log("fetch error",t))}function c(t,e,n){const a=["var(--default-bg-panel-color)","var(--default-color)"],o=["#008196","#eee"];let i="",r=[a,a,a,a];return e+n<.33*t?(i="脆",r[0]=o,r[2]=o):e-n>.15*t?(i="防",r[1]=o):n-e>.15*t?(i="闪",r[3]=o):e+n>.67*t&&(i="龟",r[1]=o,r[3]=o),[i].concat(r)}function p(t){let e='\n<div id="filters" style="overflow:hidden;">\n<div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #83a000; color: white; font-weight: bold;">Online</div>\n<div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #F39826; color: white; font-weight: bold;">Idle</div>\n<div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #ADADAD; color: white; font-weight: bold;">Offline</div>\n<div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #8FBC8F; color: white; font-weight: bold;">在城内</div>\n<div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #65A5D1; color: white; font-weight: bold;">在城外</div>\n<div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #8FBC8F; color: white; font-weight: bold;">住院时间<=5m</div>\n<div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #FF7373; color: white; font-weight: bold;">住院时间>5m</div>\n<div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #8FBC8F; color: white; font-weight: bold;">FF>=2.0</div>\n<div status="on" class="filter-button" style="cursor:pointer; margin:5px 0px 5px 20px; padding:6px; border:6px double #CFCFCF; float:left; background-color: #FF7373; color: white; font-weight: bold;">FF<2.0</div>\n</div>\n<table style="margin: auto; background-color: var(--default-bg-panel-color)">\n<tr>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">Online</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">Name</th>\n<th class="head-last" style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">Last</th>\n<th class="head-status" style="border: 1px solid darkgray; padding: 5px; background-color: #725334; color: white; font-weight: bold; text-align: center;">Status</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #033649; color: white; font-weight: bold; text-align: center;">Attack</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #033649; color: white; font-weight: bold; text-align: center;" title="Fair fight 系数">FF</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #033649; color: white; font-weight: bold; text-align: center;">TOTAL</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #033649; color: white; font-weight: bold; text-align: center;">ID</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #033649; color: white; font-weight: bold; text-align: center;">Lvl</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #033649; color: white; font-weight: bold; text-align: center;" title="基础面子系数">FR</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #033649; color: white; font-weight: bold; text-align: center;">Hint</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;">STR</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;">DEF</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;">SPD</th>\n<th style="border: 1px solid darkgray; padding: 5px; background-color: #757947; color: white; font-weight: bold; text-align: center;">DEX</th>\n</tr>\n';for(let n in t){const a=c(t[n].TOTAL,t[n].DEF,t[n].DEX);e+=`\n<tr>\n<td class="target-online" style="border: 1px solid darkgray; padding: 5px; text-align: center;"></td>\n<td class="target-name" style="border: 1px solid darkgray; padding: 5px; text-align: center;">\n<a class="user name" href="/profiles.php?XID=${t[n].ID}" target="_blank">${t[n].Name}</a>\n</td>\n<td class="target-last" style="border: 1px solid darkgray; padding: 5px; color: var(--default-color); text-align: center;"></td>\n<td class="target-status" style="border: 1px solid darkgray; padding: 5px; color: black; text-align: center;"></td>\n<td class="target-attack t-blue" style="border: 1px solid darkgray; padding: 5px; color: black; text-align: center;">\n<a href="/loader.php?sid=attack&user2ID=${t[n].ID}" style="text-decoration: none;" target="_blank">Attack</a>\n</td>\n<td class="target-fairfight" style="border: 1px solid darkgray; padding: 5px; color: var(--default-color); text-align: center;"></td>\n<td class="target-total" style="border: 1px solid darkgray; padding: 5px; color: var(--default-color); text-align: center;">${y(t[n].TOTAL)||0}</td>\n<td class="target-id" style="border: 1px solid darkgray; padding: 5px; color: var(--default-color); text-align: right;">${t[n].ID||""}</td>\n<td class="target-level" style="border: 1px solid darkgray; padding: 5px; color: var(--default-color); text-align: center;"></td>\n<td class="target-flatrespect" style="border: 1px solid darkgray; padding: 5px; color: var(--default-color); text-align: center;"></td>\n<td class="target-hint" style="border: 1px solid darkgray; padding: 5px; color: var(--default-color); text-align: center;">${a[0]}</td>\n<td class="target-str" style="border: 1px solid darkgray; padding: 5px; background-color: ${a[1][0]}; color: ${a[1][1]}; text-align: center;">${y(t[n].STR)||0}</td>\n<td class="target-def" style="border: 1px solid darkgray; padding: 5px; background-color: ${a[2][0]}; color: ${a[2][1]}; text-align: center;">${y(t[n].DEF)||0}</td>\n<td class="target-spd" style="border: 1px solid darkgray; padding: 5px; background-color: ${a[3][0]}; color: ${a[3][1]}; text-align: center;">${y(t[n].SPD)||0}</td>\n<td class="target-dex" style="border: 1px solid darkgray; padding: 5px; background-color: ${a[4][0]}; color: ${a[4][1]}; text-align: center;">${y(t[n].DEX)||0}</td>\n</tr>\n`}return e+="</table>",e}a.length>0?(console.log("target cache detected"),t("#target-load-excel").prop("disabled",!0),t("#file").prop("disabled",!0),t("#target-clear-cache").removeAttr("disabled"),t("#bmw_target_tips").text("加载成功"),t("#bmw_target_wrapper").html(p(a)),new Promise(function(t,e){setTimeout(function(){console.log("3 Seconds"),t()},3100)}).then(function(){l(),"refreshing"!=window.localStorage.getItem("BINGWA_TARGET_FLAG")?r(a):alert("已存在另外的冰蛙目标页面正在刷新中")}).catch(t=>console.log("First Refresh "+t))):console.log("target cache not available"),t(".filter-button").click(function(){"on"==t(this).attr("status")?(t(this).css({border:"6px solid #CFCFCF","font-weight":"normal"}).attr("status","off"),i(t(this).text(),"off")):(t(this).css({border:"6px double #CFCFCF","font-weight":"bold"}).attr("status","on"),i(t(this).text(),"on"))}),t("#target-load-excel").click(function(){if("undefined"==typeof XLSX){1==confirm("未检测到xlsx支持组件，只支持导入csv格式，是否继续？")?document.getElementById("file").click():console.log("load cancelled")}else document.getElementById("file").click()}),t("#file").change(function(e){const n=e.target.files;if(0==n.length)return;const a=n[0],o=/\.(xlsx|csv)$/g.exec(a.name);if(!o)return void alert("仅支持读取xlsx或csv格式！");!function(t,e,n){const a=new FileReader;a.onload=function(t){const a=t.target.result;let o;if("xlsx"===e){if("undefined"==typeof XLSX)return void alert("不支持导入xlsx格式文件");o=function(t){const e=XLSX.read(t,{type:"binary"}),n=e.SheetNames,a=e.Sheets[n[0]];return XLSX.utils.sheet_to_json(a)}(a)}else if("csv"===e){function i(t){return"string"==typeof t?y(t):t}o=function(t,e){function n(t){let e=0,n="";for(const a of t)'"'===a&&0===e?e=1:'"'===a&&1==e&&(e=0),","===a&&0===e?n+="|":'"'!==a&&(n+=a);return n.split("|")}const a=t.split(/\r?\n/),o=n(a[0]),i=[];for(let t=1;t<a.length-1;t++){const r=n(a[t]),s={};for(const t in o){const n=o[t];e[n]?s[n]=e[n].call(null,r[t]):s[n]=r[t]}i.push(s)}return i}(a,{STR:i,DEF:i,SPD:i,DEX:i,TOTAL:i})}n&&n(o)},a.readAsBinaryString(t)}(a,o[1],function(n){if(n.length>0)if(n[0].hasOwnProperty("Name"))if(n[0].hasOwnProperty("ID"))if(n[0].hasOwnProperty("STR"))if(n[0].hasOwnProperty("SPD"))if(n[0].hasOwnProperty("DEF"))if(n[0].hasOwnProperty("DEX"))if(n[0].hasOwnProperty("TOTAL")){for(let t in n)n[t].Name&&"string"!=typeof n[t].Name&&(n[t].Name=n[t].Name.toString());t("#target-load-excel").prop("disabled",!0),t("#file").prop("disabled",!0),t("#target-clear-cache").removeAttr("disabled"),console.log(n),e.target.value="",t("#bmw_target_tips").text("加载成功"),t("#bmw_target_wrapper").html(p(n)),window.localStorage.setItem("BINGWA_TARGET",JSON.stringify(n)),new Promise(function(t,e){setTimeout(function(){console.log("3 Seconds"),t()},3100)}).then(function(){l(),"refreshing"!=window.localStorage.getItem("BINGWA_TARGET_FLAG")?r(n):alert("已存在另外的冰蛙目标页面正在刷新中")}).catch(t=>console.log("First Refresh "+t))}else alert("表格中没有TOTAL，修改表格并刷新网页后再试");else alert("表格中没有DEX，修改表格并刷新网页后再试");else alert("表格中没有DEF，修改表格并刷新网页后再试");else alert("表格中没有SPD，修改表格并刷新网页后再试");else alert("表格中没有STR，修改表格并刷新网页后再试");else alert("表格中没有ID，修改表格并刷新网页后再试");else alert("表格中没有Name，修改表格并刷新网页后再试");else alert("表格中没有数据，修改表格并刷新网页后再试")})}),t("#target-clear-cache").click(function(){1==confirm("确定清除缓存吗？")?(t("#target-load-excel").removeAttr("disabled"),t("#file").removeAttr("disabled"),t("#target-clear-cache").prop("disabled",!0),t("#bmw_target_wrapper").empty(),t("#bmw_target_tips").text("无数据"),window.localStorage.removeItem("BINGWA_TARGET"),a={},window.localStorage.setItem("BINGWA_TARGET_FLAG",""),clearInterval(e),console.log("faction api refreshing ended")):console.log("clear cancelled")})}),t("#bwm-settings").click(function(){t("#bwm").children(":last").remove(),t("#bwm").append(u()),d("#bwm-settings"),a.forEach(e=>{t(`#bwm_settings_${e.name}`).val(C("BWM_SETTINGS",e.name)),t(`#bwm_settings_${e.name}`).change(function(){M("BWM_SETTINGS",e.name,t(this).val())}),window[e.name]="true"==C("BWM_SETTINGS",e.name)})}),t("#bwm-chatlog").click(function(){t("#bwm").children(":last").remove(),t("#bwm").append('\n<div id="chatlog_container" style="width: inherit">\n<div id="chatlog_header" style="margin: 10px 0px; border: 1px solid darkgray; text-align: center;">\n<span style="font-size: large;">聊天记录</span>\n</div>\n<div id="chatlog" style="min-height:400px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;"></div>\n</div>'),d("#bwm-chatlog");const e=function(){const t=window.localStorage.getItem("CHAT_LAST_MESSAGE");if(null!=t){const e=JSON.parse(t);let n=[];for(const t in e){const a=e[t];let o="",i="";a.indexOf("|||")>=0?(o=a.split("|||")[0],i=a.split("|||")[1]):o=a;const r=B(o),s=new Date(1e3*r).toLocaleString(),l=parseInt((new Date).getTime()/1e3)-r;let d="",c="";l<3600?(d=parseInt(l/60)+"m",c="#5d9525"):l>=3600&&l<86400?(d=parseInt(l/3600)+"h",c="#DAA520"):l>=86400&&l<3024e3?(d=parseInt(l/86400)+"d",c="#c0542f"):l>=2592e3&&(d=parseInt(l/86400/30)+"month",c="#777"),n.push({chat_ts:r,chat_beijing:s,username:t,diff_ts_format:d,diff_ts_color:c,last_message:i})}return n}return}();if(void 0!==e){const n=e.sort(function(t,e){return e.chat_ts-t.chat_ts}),a=t('\n<table id="chatlog-table" style=" background-color: white; font-size:12px; margin: auto;">\n<tr class=chatlog-table-head">\n<th class="chatlog-time">最后聊天时间</th>\n<th class="chatlog-name">玩家</th>\n<th class="chatlog-last">距今</th>\n<th class="chatlog-message">最后5条消息</th>\n</tr>\n</table>');t.each(n,function(e,n){const o=t(`\n<tr class=chatlog-table-content">\n<td class="chatlog-time">${n.chat_beijing}</td>\n<td class="chatlog-name">${n.username}</td>\n<td class="chatlog-last" style="color:white;background-color:${n.diff_ts_color}">${n.diff_ts_format}</td>\n<td class="chatlog-message"></td>\n</tr>`);o.children(".chatlog-message").text(n.last_message),a.append(o)}),t("#chatlog").append(a),t("#chatlog-table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;"),t("#chatlog-table").find("td").css({border:"1px solid darkgray",padding:"5px","text-align":"center"})}}),t("#bwm-mug").click(function(){t("#bwm").children(":last").remove(),t("#bwm").append('\n<div id="mug_container" style="width: inherit">\n<div id="mug-head" style="margin:10px 0px; border:1px solid darkgray; text-align:center;">\n<input type="text" id="mug-watchlist-id-input" placeholder="肥羊 ID" size="10" style="font-size: larger; padding: 5px; margin: 5px;" />\n<button id="mug-watchlist-add-input" class="torn-btn" style="margin: 5px;">加入监视</button>\n</div>\n<div id="mug-watchlist" style="margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden;"></div>\n<div id="mug-loglist" style="min-height:400px;margin:10px 0px; border:1px solid darkgray;  text-align:center;overflow:hidden; overflow-x: auto;"></div>\n</div>'),d("#bwm-mug");let e={};function n(){const n=window.localStorage.getItem("muglog-watchlist");if(null!=n){const a=JSON.parse(n);let o='\n<table id="mug-watchlist-table" style=" background-color: white; font-size:12px; margin:auto;"><tr class="mug-watchlist-table-head"><th>Victim ID</th><th>Victim Name</th><th>Total Mugged</th><th>删除</th></tr>';for(let t in a){let n="$0";t in e&&(n=x(e[t].amount)),o+=`\n<tr class="mug-watchlist-table-content">\n<td class="mug-watchlsit-victimid">${t}</td>\n<td><a class="user name" href="/profiles.php?XID=${t}" target="_blank">${a[t].name}</a></td>\n<td>${n}</td>\n<td><a class="mug-watchlist-delete" role="button" style="cursor: pointer; color: darkblue;">删除</a></td>\n</tr>`}o+="</table>",t("#mug-watchlist").append(o),t("#mug-watchlist-table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;"),t("#mug-watchlist-table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;")}t(".mug-watchlist-delete").click(function(){const e=t(this).parent().parent().children(".mug-watchlsit-victimid").text();T("muglog-watchlist",e),t(this).parent().parent().remove(),console.log("删除成功 "+e)})}!function(){const n=window.localStorage.getItem("muglog");if(null!=n){const a=JSON.parse(n);let o="</table>";for(let t in a){const n=a[t].victim_id;n in e?e[n].amount+=x(a[t].money_mugged):e[n]={name:a[t].victim_name,amount:x(a[t].money_mugged)},o=`\n<tr class="mug-loglist-table-content">\n<td class="mug-loglist-ts">${t}</td>\n<td class="mug-loglist-time">${a[t].timestring}</td>\n<td class="mug-loglist-victimid">${a[t].victim_id}</td>\n<td class="mug-loglist-victimname"><a class="user name" href="/profiles.php?XID=${a[t].victim_id}" target="_blank">${a[t].victim_name}</a></td>\n<td class="mug-loglist-amount" title="${a[t].timestring}">${a[t].money_mugged}</td>\n<td><a class="mug-loglist-watch" role="button" style="cursor: pointer; color: darkblue;">监视</a></td>\n<td><a class="mug-loglist-delete" role="button" style="cursor: pointer; color: darkblue;">删除</a></td>\n</tr>`+o}o='\n<table id="mug-loglist-table" style=" background-color: white; font-size:12px; margin: auto;">\n<tr class="mug-loglist-table-head">\n<th class="mug-loglist-ts">Timestamp</th>\n<th class="mug-loglist-time">Time</th>\n<th class="mug-loglist-victimid">Victim ID</th>\n<th class="mug-loglist-victimname">Victim Name</th>\n<th class="mug-loglist-amount">Money Mugged</th>\n<th>监视</th><th>删除</th>\n</tr>'+o,t("#mug-loglist").append(o)}t("#mug-loglist-table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;"),t("#mug-loglist-table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),t("#mug_container")[0].clientWidth<400&&(t(".mug-loglist-ts").hide(),t(".mug-loglist-victimid").hide(),t(".mug-loglist-time").hide())}(),n(),t(".mug-loglist-delete").click(function(){const e=t(this).parent().parent().children(".mug-loglist-ts").text();T("muglog",e),t(this).parent().parent().remove(),console.log("删除成功 "+e)}),t(".mug-loglist-watch").click(function(){const e=t(this).parent().parent().children(".mug-loglist-victimid").text();M("muglog-watchlist",e,{name:t(this).parent().parent().children(".mug-loglist-victimname").text()}),t("#mug-watchlist-table").remove(),n(),console.log("监视成功 "+e)}),t("#mug-watchlist-add-input").click(function(){const e=t("#mug-watchlist-id-input").val();if(isNaN(e)||0==e||""==e)alert("无效ID");else{fetch(`https://api.torn.com/user/${e}?selections=profile&key=${o}`).then(t=>t.json()).then(a=>{if(console.log("API fetched"),null!=a.error&&6==a.error.code)throw alert("无效ID "+e),new Error("Incorrect ID");M("muglog-watchlist",e,{name:a.name}),t("#mug-watchlist-table").remove(),n(),alert("监视成功 "+a.name+"["+e+"]"),console.log("监视成功 "+a.name+"["+e+"]")}).catch(t=>console.log("fetch error: ",t.message))}})}),t("#bwm-return").click(function(){t("#bwm").remove(),t("#sidebarroot").show(),t(".content-wrapper").show()}),t("#bwm-addiction").click(function(){t("#bwm").children(":last").remove(),t("#bwm").append(g()),d("#bwm-addiction");const e=6005,n="误差修正",a="自动衰减";function i(e,n){t("#addiction-status").text(e),t("#addiction-status").css("color",n?"red":"")}function r(t){return 86400*Math.ceil((t-12720)/86400)+12720}function s(t,e,n){let o=r(e);const i=[];for(;o<n&&t>0;){const e=o<1618963200?21:20,n=Math.max(t-e,0);i.push({timestamp:o,title:a,ap_before:t,ap_after:n}),t=n,o+=86400}return i}function l(t,e){const n={2200:1,2210:10,2220:4,2230:10,2240:5,2250:13,2260:3,2270:7,2280:7,2290:18,2295:25,2201:2,2211:10,2221:25,2231:25,2241:14,2251:25,2261:25,2271:25,2281:25,2291:50},a=[];return 6504===t.log?a.push({timestamp:t.timestamp,title:"公司特技",ap_before:e,ap_after:e-t.data.job_points_used}):t.log in n?a.push({timestamp:t.timestamp,title:t.title,ap_before:e,ap_after:e+n[t.log]}):console.warn("未知毒瘾日志",t),a}function c(t,e){const a=[],o=[e];for(let t=1;t<100;t++)o.push(e+t);let i;e>20&&o.push(e-20);for(const e of o){const n=Math.round(e*t.data.addiction/100);if(Math.abs(Math.round(1e4*n/e)-Math.round(100*t.data.addiction))<=1){i=e;break}}if(!i)throw new Error("找不到整数解");i!==e&&(a.push({timestamp:t.timestamp,title:n,ap_before:e,ap_after:i}),e=i);const r=e-Math.round(e*t.data.addiction/100);return a.push({timestamp:t.timestamp,title:"Rehab",ap_before:e,ap_after:r,times:t.data.rehab_times,cost:t.data.cost}),a}function p(t,n,a,o){let i=n,r=a;const d=[];for(const n of t.slice().reverse()){const t=s(i,r,n.timestamp);t.length>0&&(d.push(...t),i=d[d.length-1].ap_after),r=n.timestamp;let a=[];a=n.log===e?c(n,i):l(n,i),a.length>0&&(d.push(...a),i=d[d.length-1].ap_after)}return d.push(...s(i,r,o)),d.reverse()}function h(t){if(t[0].log!==e||t[t.length-1].log!=e)return null;if(100===t[0].data.addiction||100===t[t.length-1].data.addiction)return null;const n=p(t.slice(1,-1),1e4,t[t.length-1].timestamp,t[0].timestamp),a=0===n.length?0:n[0].ap_after-1e4;if(a<=0)return null;const o=t[t.length-1].data.rehab_times,i=t[t.length-1].data.addiction/100;return a/(t[0].data.rehab_times/(t[0].data.addiction/100)-o/i+o)}function f(t,e){const n={ap:"",efficiency:"",suggestions:[]};if(0===t.length)return n;const a=t[0].ap_after;n.ap=a.toString();const o=t.find(t=>"Rehab"===t.title),i=t.slice(t.indexOf(o)+1).find(t=>"Rehab"===t.title);let s=(o.ap_before-o.ap_after)/o.times,l=s;Math.abs(i.ap_before-i.ap_after-s*i.times)<1?n.efficiency=s.toPrecision(3):(l=(i.ap_before-i.ap_after)/i.times,l<s&&([s,l]=[l,s]),n.efficiency=`${s.toPrecision(3)} ~ ${l.toPrecision(3)}`);let d=a;const c=Math.floor((new Date).getTime()/1e3),p=r(c);if(p<e||p<c+21600?(d-=20,n.suggestions.push("<li>下次自动衰减之前大概率没有机会继续吃药，建议戒毒后至少留 20 点毒瘾，若有计划在戒毒之前继续吃药，请吃完再重新计算毒瘾</li>")):p<Math.max(e,c)+28800&&(d-=2,n.suggestions.push("<li>下次自动衰减之前只能再吃一颗 xan 了，建议戒毒后至少留 2 点毒瘾</li>")),d<=s)n.suggestions.push("<li>毒瘾不足一格戒毒量，不建议戒毒</li>");else if(s===l){const t=Math.floor(d/s),e=o.cost/o.times*t/1e6,i=Math.floor(s*t);n.suggestions.push(`<li>建议戒毒 ${t} 格，花费 $${e}m，预计戒掉 ${(i/a*100).toFixed(2)}%，剩余 ${a-i} 点毒瘾</li>`)}else n.suggestions.push("<li>最近两次戒毒效率差异较大，无法估计下次戒毒次数</li>");n.suggestions.push("<li>目前关于毒瘾的计算并不准确，上述建议可能存在误差</li>");const h=t.find(t=>t.title.startsWith("Item use"));return(!h||h.title.indexOf("xanax")<0||h.timestamp<c-86400)&&n.suggestions.push("<li>你似乎近期没有在坚持吃 xan，上述建议可能并不准确</li>"),n}function u(e,o){t("#addiction-curr-ap").text(o.ap),t("#addiction-efficiency").text(o.efficiency);const i=t("#addiction-suggestion");i.find("li").remove(),i.append(o.suggestions);const r=t("#addiction-ap-records");if(r.find("tr").slice(1).remove(),0!==e.length){for(const o of e){let e=o.title,i="";"Rehab"===e?e=`戒毒 ${o.times} 格`:e===a?o.ap_before-o.ap_after<20&&(i="t-red"):e===n?i="t-red":e.startsWith("Item use")&&(e=e.slice(9),e=e[0].toUpperCase()+e.slice(1));const s=o.ap_after-o.ap_before,l=s>=0?"t-red":"t-green",d=t(`<tr>\n<td>${new Date(1e3*o.timestamp).format("yyyy-MM-dd hh:mm")}</td>\n<td class="${i}">${e}</td>\n<td class="${l}">${s>=0?"+":""}${s}</td>\n<td>${o.ap_after}</td>\n<td>${"Rehab"===o.title?(-s/o.times).toPrecision(3):""}</td>\n</tr>`);r.append(d)}r.find("td").attr("style","border: 1px solid darkgray; padding: 5px")}}async function b(n){t(".addiction-analyze-btn").prop("disabled",!0);try{u([],f([],0));const[t,a]=await async function(t){const n=[];let a=null,o=null,r=null,s=null,l=0;const d=t=>i(`正在分析日志 (${new Date(1e3*t).format("yyyy-MM-dd")})`);for await(const i of j([126],[],null,null,d)){if(n.push(i),i.log===e){l++;const e=h(n.slice(o));if(a&&e&&Math.abs(e-a)/e<.001){if(r=Math.round(e*i.data.rehab_times*100/i.data.addiction),s=n.length,t)break}else if(100===i.data.addiction&&l>2&&(r=i.data.rehab_times,s=n.length,t))break;a=e,o=n.length-1}if(t&&n.length>=450)break;if(i.timestamp<1577836800)break}if(!s)throw new Error("找不到计算起点");n.length=s;const c=Math.floor((new Date).getTime()/1e3);return[n,p(n,r,n[n.length-1].timestamp,c)]}(n),r=await async function(){const t=Math.floor((new Date).getTime()/1e3),e=await(await fetch(`https://api.torn.com/user/?selections=cooldowns&key=${o}`)).json();if("error"in e)throw new Error(e.error.error);return t+e.cooldowns.drug}();u(a,f(a,r)),i("完成！")}catch(e){console.trace(e),"Access level of this key is not high enough"===e.message?(i("权限不足！",!0),t("#addiction-status").append('<a href="/preferences.php#tab=api">请使用 Full Access 类型的 API Key</a>')):i(`出错啦！${e}`,!0)}t(".addiction-analyze-btn").prop("disabled",!1)}t("#addiction-fast-btn").click(()=>b(!0)),t("#addiction-full-btn").click(()=>b(!1)),t("#addiction-faq-btn").click(function(){t(this).prop("disabled",!0),t("#addiction-faq").show()})})}})}if(window.location.href.indexOf("profiles.php")>=0){const Xn=setInterval(Jn,500);function Jn(){const e=t("div.profile-buttons div.profile-container");if(e.length>0){clearInterval(Xn);const n=t("<div></div>");n.addClass("profile-container-description"),e.append(n),n.css({height:"75","padding-top":"5px","overflow-x":"auto"}),n.siblings(".buttons-wrap").css("padding","0px"),n.html("蛙蛙探测器工作中...");const a=t(".basic-information").find(".info-table").children(":first").children(".user-info-value").children().text();console.log(`user: ${a}`);const o=a?a.split("[")[0].trim():"",i=a?a.split("[")[1].replace("]","").trim():"",r=`/loader.php?sid=attack&user2ID=${i}`;t(".profile-status").children().children(".title-black").empty().append(`\n<span class="border-round" style="color:white;background-color:#DAA520;padding:3px;text-shadow:none;">\n<a href="${r}" style="color: white; text-decoration: none;">攻击</a></span>`);const s=L(o);s?t(".profile-status").children().children(".title-black").append(`\n<span class="border-round" style="color:white;background-color:${s[0]};padding:3px;margin-left:5px;">上次唠嗑: ${s[1]}</span>`):console.log("没唠过");const d=function(t){const e=window.localStorage.getItem("muglog");if(e){const n=JSON.parse(e),a=Object.entries(n);for(let e=a.length-1;e>=0;e--)if(a[e][1].victim_id==t){const t=a[e][0],n="$"+v(x(a[e][1].money_mugged)),o=parseInt((new Date).getTime()/1e3)-t;let i="",r="";return o<3600?(i=parseInt(o/60)+"m ago",r="#5d9525"):o>=3600&&o<86400?(i=parseInt(o/3600)+"h ago",r="#DAA520"):o>=86400&&(i=parseInt(o/86400)+"d ago",r="#c0542f"),r+","+i+","+n}return}}(i);if(console.log("mug_display_arr "+d),d){const e=d.split(",")[0],n=d.split(",")[1],a=d.split(",")[2];t(".profile-status").children().children(".title-black").append(`\n<span class="border-round" style="color:white;background-color:${e};padding:3px;margin-left:5px;">上次mug: ${a} - ${n}</span>`)}else console.log("没mug过");N(i,function(e){let a=parseInt(100*e.life.current/e.life.maximum);const o=e.life.current+"/"+e.life.maximum+" ("+a+"%)";let i="";a<=66?i=`\n<div style="height:20px; overflow:hidden;">\n${O(20,a,"#c0542f","#FFF5F7",o)}\n</div>`:(a>100&&(a=100),i=`\n<div style="height:20px; overflow:hidden;">\n${O(20,a,"#5d9525","#FFF5F7",o)}\n</div>`),n.html(`\n<table style="width:100%; background-color: #FFF5F7;">\n<tr>\n<td class="bw-bs">战力</td>\n<td>${e.estimate_bs_display}</td>\n<td class="bw-stat">XAN</td>\n<td>${e.personalstats.xantaken||0}</td>\n<td class="bw-other">活跃天数</td>\n<td>${parseInt(e.estimate_active_days)||0}</td>\n</tr>\n<tr>\n<td class="bw-bs">血量</td>\n<td class="bw-hp">${i}</td>\n<td class="bw-stat">LSD</td>\n<td>${e.personalstats.lsdtaken||0}</td>\n<td class="bw-other">估算WS</td>\n<td>${v(e.estimate_ws)||0}</td>\n</tr>\n<tr>\n<td class="bw-nw">资产</td>\n<td>${v(e.personalstats.networth)}</td>\n<td class="bw-stat">SE</td>\n<td>${e.personalstats.statenhancersused||0}</td>\n<td colspan="2"><a class="t-blue" role="button" id="a_click_start_wawa" style="cursor: pointer">更多&gt;&gt;</a></td>\n</tr>\n</table>\n`),n.find("td").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;"),n.find(".bw-bs").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #033649;color: white;font-weight: bold;"),n.find(".bw-nw").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #757947;color: white;font-weight: bold;"),n.find(".bw-other").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #725334;color: white;font-weight: bold;"),n.find(".bw-stat").attr("style","border: 2px solid darkgray; padding:2px; text-align:center;background-color: #458994;color: white;font-weight: bold;"),n.find(".bw-hp").attr("style","border: 2px solid darkgray; text-align:center;"),t("div.user-information-section:contains('Last action')").next().children("span").text(e.last_action_details);const r=t("div.profile-buttons.profile-action").html(),s=`\n<div>\n<div class="title-black top-round">蛙蛙探测器&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n<a class="t-white" role="button" id="a_click_start_wawa_back" style="cursor: pointer">返回</a>\n</div>\n<div class="cont bottom-round ">\n<div class="profile-container basic-info bottom-round" style="background-color: #FFF;">\n<table style="width:100%; min-height: 320px;">\n<tr>\n<td style="vertical-align:middle"><span class="bold">估算战力</span></td>\n<td style="vertical-align:middle"><span class="bold">${e.estimate_bs_display}</span></td>\n<td style="vertical-align:middle"><span class="bold">Xanax数量</span></td>\n<td style="vertical-align:middle"><span class="bold">${e.personalstats.xantaken||0}</span></td>\n<td style="vertical-align:middle"><span class="bold">SE数量</span></td>\n<td style="vertical-align:middle"><span class="bold">${e.personalstats.statenhancersused||0}</span></td>\n</tr>\n<tr>\n<td style="vertical-align:middle"><span class="bold">攻击胜率</span></td>\n<td style="vertical-align:middle"><span class="bold">${v(e.attackWinRatio)||0}</span></td>\n<td style="vertical-align:middle"><span class="bold">防守胜率</td>\n<td style="vertical-align:middle"><span class="bold">${v(e.defendWinRatio)||0}</span></td>\n<td style="vertical-align:middle"><span class="bold">防守胜场</span></td>\n<td style="vertical-align:middle"><span class="bold">${e.personalstats.defendswon||0}</span></td>\n</tr>\n<tr>\n<td style="vertical-align:middle"><span class="bold">能量续满</span></td>\n<td style="vertical-align:middle"><span class="bold">${e.personalstats.refills||0}</span></td>\n<td style="vertical-align:middle"><span class="bold">LSD数量</span></td>\n<td style="vertical-align:middle"><span class="bold">${e.personalstats.lsdtaken||0}</span></td>\n<td style="vertical-align:middle"><span class="bold">DP占比</span></td>\n<td style="vertical-align:middle"><span class="bold">${v(e.donator_percent)}</span></td>\n</tr>\n<tr>\n<td style="vertical-align:middle"><span class="bold">活跃天数</span></td>\n<td style="vertical-align:middle"><span class="bold">${e.estimate_active_days}</span></td>\n<td style="vertical-align:middle"><span class="bold">日均吃Xan</span></td>\n<td style="vertical-align:middle"><span class="bold">${e.average_drugs}</span></td>\n<td style="vertical-align:middle"><span class="bold">Booster</span></td>\n<td style="vertical-align:middle"><span class="bold">${v(e.personalstats.boostersused)}</span></td>\n</tr>\n<tr>\n<td style="vertical-align:middle"><span class="bold">饮料使用</span></td>\n<td style="vertical-align:middle"><span class="bold">${e.energydrinkused}</span></td>\n<td style="vertical-align:middle"><span class="bold">书使用</span></td>\n<td style="vertical-align:middle"><span class="bold">${e.booksread}</span></td>\n<td style="vertical-align:middle"><span class="bold">总资产</span></td>\n<td style="vertical-align:middle"><span class="bold">${v(e.personalstats.networth)}</span></td>\n</tr>\n</table>\n</div>\n</div>`,d=function(){t("div.profile-buttons.profile-action").html(s),t("div.profile-status").hide(),t("#a_click_start_wawa_back").click(function(){t("div.profile-buttons.profile-action").html(r),t("div.profile-status").show(),t("#a_click_start_wawa").click(d)})};t("#a_click_start_wawa").click(d);let p=0;p+=e.enemies/10,p-=e.friends/20,p+=e.personalstats.moneymugged/2e8,p+=e.personalstats.bountiesreceived/50,p=parseInt(p);let u="",g="";p<=0?(u="大善人",g=f):p<=10?(u="好人",g=c):p<=100?(u="坏人",g=h):(u="大恶人",g=l),t("div.basic-information").find("ul.info-table").children("li:eq(9)").children("div.user-info-value").append(`\n&nbsp;<span class="border-round" style="padding:2px;background-color:${g};color:white;" title="0分及以下：大善人<br>1-10分：好人<br>11-100分：坏人<br>100分以上：大恶人">${u}</span>\n&nbsp;<span title="每有10个敌人加1分<br>每有20个朋友减1分<br>每mug200m加1分<br>每收到50次悬赏加1分"><b>坏比指数: ${p}</b></span>\n`)},function(t){n.html(t)})}}}function en(e,n){let a=!0;if(t("#parade_filter").length<=0){t(e).before('<div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">阅兵</div><div id="parade_filter" class="cont-gray bottom-rounded content" style="overflow:hidden"><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Level" checked="checked">Level</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="BS" checked="checked">BS</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Mugged" checked="checked">Mugged</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Rehab" checked="checked">Rehab</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Rank" checked="checked">Rank</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Job" checked="checked">Job</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Networth" checked="checked">Networth</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Bazaar">Bazaar</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Defendslost">Defendslost</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Property">Property</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Elimination">Elimination</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Signup">Signup</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Last" checked="checked">Last</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Status" checked="checked">Status</div><div class="checkbox-wrap" style="margin:5px 10px;"><input type="checkbox" style="margin:1px 5px;" value="Life">Life</div></div><div class="checkboxset-wrap" style="margin:5px 10px; float:left"><div class="input-wrap" style="margin:5px 10px;"><label for="nw">Bazaar价值 大于 </label><input id="parade_bazaar_value" type="text" style="margin:1px 5px; width:50px" value="10">M</div><div class="btn-wrap" style="margin:5px 10px;"><span class="btn"><button id="parade_start" class="torn-btn" style="margin:1px 5px;">开始阅兵</button></span><span class="btn"><button id="parade_stop" class="torn-btn" style="margin:1px 5px;">暂停阅兵</button></span></div></div></div>'),t("#parade_stop").prop("disabled",!0);const n=C("parade_option","checkbox_vals"),a=C("parade_option","text_vals");null!=n&&null!=n&&(t("#parade_bazaar_value").val(a),t("#parade_filter input:checkbox").removeAttr("checked"),t("#parade_filter input:checkbox").each(function(e,a){n.indexOf(t(this).val())>=0&&t(this).attr("checked","checked")}))}t("#parade_start").click(function(){a=!0;let o=t(n).children("li").first();if(o.length<=0)return void alert("未找到用户列表");const i=t("#parade_bazaar_value").val().replace(/[^\d]/g,"");let r=[];t("#parade_filter input:checkbox:checked").each(function(e,n){r.push(t(this).val())}),console.log(r),t("#parade_filter input[type='checkbox']").prop("disabled",!0),t("#parade_filter input[type='text']").prop("disabled",!0),t(this).prop("disabled",!0),t("#parade_stop").removeAttr("disabled"),t("#parade_filter").css("background-color",c);let s={};if(s.checkbox_vals=r,s.text_vals=i,window.localStorage.setItem("parade_option",JSON.stringify(s)),t("#search_parade_table").length<1){let n='<p id="search_parade_progress">阅兵进度</p><table id="search_parade_table" style="width:100%;background-color: white;font-size:12px;"><tr><th>Name</th>';for(let t=0;t<r.length;t++)n+=`<th>${r[t]}</th>`;n+="<th>Attack</th></tr></table>",t(e).before(n),t("#search_parade_table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;")}function l(){if("1"==o.attr("detected"))console.log("user detected"),d(0);else{o.attr("detected","1");const e=o.find("a[href^='/profiles.php?XID=']").attr("href").replace(/[^0-9|-]/gi,"");t("#search_parade_progress").text(`正在阅兵：${e}`),N(e,function(n){let a="Closed",o=0,s=0;if(n.basicicons.icon35){a="Opened";const t=n.bazaar;null!=t&&t.map(function(t,e,n){o+=t.quantity*t.market_price,s+=t.quantity*t.price})}if("Federal"==n.status.state||"Fallen"==n.status.state)console.log("被封/去世，跳过"),t("#search_parade_progress").text(`阅兵：${e} 被封/去世，跳过`),d(1e3);else if(i&&o<1e6*i)console.log("太穷，跳过"),t("#search_parade_progress").text(`阅兵：${e} 太穷，跳过`),M("battlestats",e,n.estimate_bs),d(1e3);else{let i={};i.Level=n.level,i.BS=v(n.estimate_bs),i.Mugged=v(n.personalstats.moneymugged),i.Rehab=v(n.personalstats.rehabcost||0),i.Rank=n.rank_title,i.Networth=v(n.personalstats.networth),i.Defendslost=n.personalstats.defendslost,i.Property=n.property,i.Signup=n.signup,i.Last=n.last_action_brief,i.Status=n.status.state,i.Elimination=null==n.competition?"":n.competition.team;const l=n.job.company_type,c=n.job.job;if(0==l)i.Job=c;else{const t=C("APICache_companies","companies");null!=t&&null!=t?(i.Job=t[l.toString()].name,i.Job+="Director"==c?"(D)":"(E)"):i.Job=l}i.Life=parseInt(n.life.current/n.life.maximum*100)+"%",i.Bazaar='<span class="t-red">Closed</span>',"Opened"==a&&(i.Bazaar=`<a href="/bazaar.php?userId=${e}"><span class="t-green">${v(o)}</span><span class="t-red">/${v(s)}</span></a>`);let p=`<tr><td><a class="user name" href="/profiles.php?XID=${e}" target="_blank">${n.name}</a></td>`;for(let t=0;t<r.length;t++)p+=`<td>${i[r[t]]}</td>`;p+=`<td><a class="t-blue c-pointer h attack-act" href="/loader2.php?sid=getInAttack&user2ID=${e}" target="_blank">Attack</a></td></tr>`,console.log(`蛙蛙探测 userId ${e} 成功: ${p}`),t("#search_parade_table").append(p),t("#search_parade_table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),M("battlestats",e,n.estimate_bs),d(1e3)}},function(t){console.log(`蛙蛙探测 userId: ${e} 失败`),d(1e3)})}}function d(e){o=t(o.nextAll(o[0].tagName)[0]),o.length>0&&1==a?(console.log(a),setTimeout(l,e)):(console.log("阅兵完成"),t("#search_parade_progress").text("阅兵完成"),t("#parade_filter input[type='checkbox']").removeAttr("disabled"),t("#parade_filter input[type='text']").removeAttr("disabled"),t("#parade_start").removeAttr("disabled"),t("#parade_stop").prop("disabled",!0),t("#parade_start").text("继续阅兵"),t("#parade_filter").css("background-color","#f2f2f2"))}console.log("阅兵开始"),l()}),t("#parade_stop").click(function(){a=!1,console.log("阅兵暂停"),t("#search_parade_progress").text("阅兵暂停"),t("#parade_filter input[type='checkbox']").removeAttr("disabled"),t("#parade_filter input[type='text']").removeAttr("disabled"),t("#parade_start").removeAttr("disabled"),t("#parade_filter").css("background-color","#f2f2f2")})}if(window.location.href.indexOf("page.php?sid=UserList")>=0){en("div.userlist-wrapper","ul.user-info-list-wrap");setInterval(Kn,1e3);function Kn(){const e=t(".user-info-list-wrap").find(".expander");e.length>0&&e.each(function(){if("1"!=t(this).attr("hasdone")){t(this).attr("hasdone","1");const e=L(t(this).children(".user.name").attr("title").split("[")[0].trim());e&&(console.log(e),t(this).children(".user.name").append(`\n<div class= "border-round" title="<strong>上次唠嗑: </strong>${e[1]}"\nstyle="position: absolute; z-index: 1; top: 0px; right: 30px; width: 44px; height: 20px; margin: 3px; border: 3px solid #000; background-color: ${e[0]}; color: #eee; text-align: center;line-height: 20px;">${e[1]}\n</div>`))}})}}if(foo&&window.location.href.indexOf("index.php?page=people")>=0){en("div.travel-people","ul.users-list");let Yn={};const Vn=window.localStorage.getItem("muglog-watchlist");function Qn(t){const e=t.find("a.faction").attr("href");return e?e.substring(30):0}null!=Vn&&(Yn=JSON.parse(Vn));setInterval(Zn,1e3);function Zn(){const e=t("ul.users-list").children("li");e.length>0&&e.each(function(e,n){if("1"!=t(this).attr("oversea")){const e=Qn(t(this)),n=t(this).find("a.name").attr("href").substring(18).trim();e in r&&t(this).css("background-color","NavajoWhite"),e in i&&t(this).css("background-color","DarkSeaGreen"),n in Yn&&t(this).css("background-color",p),t(this).attr("oversea","1")}})}}const nn={Mexico:{name:"墨西",time:18},Cayman:{name:"开曼",time:25},Canada:{name:"加拿",time:29},Hawaii:{name:"夏威",time:94},Argentina:{name:"阿根",time:117},United:{name:"英国",time:111},Switzerland:{name:"瑞士",time:123},Japan:{name:"日本",time:158},China:{name:"中国",time:169},UAE:{name:"迪拜",time:190},South:{name:"南非",time:208},Unknown:{name:"剧院",time:1}},an={Mexican:"Mexico",Caymanian:"Cayman",Canadian:"Canada",Hawaiian:"Hawaii",Argentinian:"Argentina",British:"United",Swiss:"Switzerland",Japanese:"Japan",Chinese:"China",Emirati:"UAE",South:"South"};function on(e){return t(e).find("td.table-level").text()}function rn(e){return t(e).find("td.table-online").attr("code")}function sn(e){return t(e).find("td.table-revivable").text()}function ln(e){return t(e).find("td.table-position").text()}function dn(e){return t(e).find("td.table-days").text()}function cn(e){return t(e).find("td.table-last").attr("last-action-minutes")}function pn(e){const n=t(e).find("td.table-status").attr("hospital-seconds"),a=t(e).find("td.table-status").attr("hospital-location"),o=nn[a];return o?-1e6*o.time+Math.max(n,0):n}function hn(e){return t(e).find("td.table-bs").attr("estimate-bs")}function fn(t){let e=C("battlestats",t),n="",a="";return null!=e&&null!=e?(n=y(e),a=v(e)):e=0,[e,n,a]}function un(t){let e=C("revivable",t),n="unknown";return null!=e&&null!=e&&(n=e),n}function gn(t){const e=new Date,n=parseInt(parseInt(e.getTime()/1e3)-t);let a="";return a=n>=60&&n<3600?parseInt(n/60)+"m":n>=3600&&n<86400?parseInt(n/3600)+"h":n>=86400?parseInt(n/86400)+"d":n+"s",[n,a]}function bn(t,e,n){let a=0,o="town";const i=new Date,r=t.split(" ");if("Abroad"==e)e="="+nn[r[1]].name,a=0-nn[r[1]].time,o=r[1];else if("Traveling"==e)r.length>1?"Traveling"==r[0]?(e=">"+nn[r[2]].name,a=0-nn[r[2]].time,o=r[2]):"Returning"==r[0]&&(e="<"+nn[r[4]].name,a=0-nn[r[4]].time,o=r[4]):(e="剧院",a=-1,o="Unknown");else if("Hospital"==e){let t=parseInt(n-parseInt(i.getTime()/1e3));t<0&&(t=0);let s=parseInt(t/3600);s=s<10?"0"+s:s;let l=parseInt(t%3600/60);l=l<10?"0"+l:l;let d=t%60;d=d<10?"0"+d:d,"hospital"==r[1]?(e=s+":"+l+":"+d,o="town"):(e="海"+s+":"+l+":"+d,o=an[r[2]]||"Unknown"),a=t}return[e,a,o]}function mn(e){t("li.days").text("Last"),t("li.position").text("BattleStats");let n=200;t("li.position").length>0&&(n=window.getComputedStyle(t("li.position")[0]).width.replace(/px$/g,""),console.log(n));fetch(`https://api.torn.com/faction/${e}?selections=basic&key=${o}`).then(t=>t.json()).then(a=>{console.log("facPageEnhanced "+e),t("li.table-row").each(function(){const e=t(t(this).find("[class^=userWrap]")).children().attr("href").substring(18),o=fn(e);Number(n)>100?t(t(this).find("div.position")).attr("estimate-bs",o[0]).children(":first").text(o[1]):t(t(this).find("div.position")).attr("estimate-bs",o[0]).children(":first").text(o[2]);const i=gn(a.members[e].last_action.timestamp);t(t(this).find("div.days")).attr("last-action-minutes",i[0]).text(i[1]);const r=a.members[e].status.state,s=a.members[e].status.description,l=a.members[e].status.until,d=a.members[e].status.color,c=bn(s,r,l);t(t(this).find("div.status")).attr("sort_score",c[1]).html(`<span class="t-${d}">${c[0]}</span>`)})}).catch(t=>console.log("fetch error",t))}function yn(t,e,n){let a=[0,0,0];const o=C("APICache_companies","companies");if(null!=o){const n=o[t].positions[e];if(n){const{man_required:t,int_required:e,end_required:o}=n;a=[t,e,o]}}function i(t){return t[0]+t[1]<t[2]?2:t[0]>t[1]?0:1}function r(t){return(t[0]-t[1])*(t[1]-t[2])>0?1:(t[0]-t[2])*(t[2]-t[1])>0?2:0}function s(t,e){return e/t<=1?e/t:1+(e-t)/t*.5}function l(t,e){if(0==t)return"";{const n=1.2*e/t;return n<1?"eff-red":n<2?"eff-yellow":"eff-green"}}const d=a[i(a)],c=n[i(a)],p=a[r(a)],h=n[r(a)],f=.67*s(d,c)+.33*s(p,h),u=function(t){return t<1?"eff-red":t<1.5?"eff-yellow":"eff-green"}(f),g=l(a[0],n[0]),b=l(a[1],n[1]),m=l(a[2],n[2]),y=Math.floor(Math.min(45,c/d*45*1.2)+Math.floor(Math.min(45,h/p*45*1.2)+Math.floor(Math.max(0,5*Math.log2(1.2*c/d)))+Math.floor(Math.max(0,5*Math.log2(1.2*h/p)))));return[f,u,g,b,m].concat(a).concat(y)}function xn(t){let e=0;const n=C("EMPLOYEE_RANK",t);return null!=n&&null!=n&&(e=n),e}function vn(e){const n=`https://api.torn.com/company/?selections=profile,employees&key=${o}`,a=t("#tips-view-company");a.text("---探测中---"),fetch(n).then(t=>{if(t.ok)return t.json();a.text("---探测失败---")},t=>{a.text("---网络异常---")}).then(n=>{if(a.text("---探测完成---"),"error"in n)a.text(`---错误代码：${n.error.code} 错误：${n.error.error}---`);else if("company_employees"in n){t("#companyname").text(n.company.name),e.prepend('\n<table class="company-effectiveness" style="background-color: #FFF5F7;font-size:12px;margin:auto;">\n<tr class="head">\n<th class="employee-basic table-position">岗位</th>\n<th class="employee-basic table-days">天</th>\n<th class="employee-ws table-man">MAN</th>\n<th class="employee-ws table-int">INT</th>\n<th class="employee-ws table-end">END</th>\n<th class="employee-effectiveness table-ws" title="Working Stats">属</th>\n<th class="employee-effectiveness table-ep" title="Effectiveness Prediction">估</th>\n<th class="employee-basic table-last">登</th>\n<th class="employee-basic table-username">名字</th>\n<th class="employee-effectiveness table-settled" title="Settled In">天</th>\n<th class="employee-effectiveness table-merits" title="Merits">点</th>\n<th class="employee-effectiveness table-education" title="Director Education">课</th>\n<th class="employee-effectiveness table-management" title="Management">理</th>\n<th class="employee-effectiveness table-addiction" title="Addiction">药</th>\n<th class="employee-effectiveness table-total" title="Total">总</th>\n<th class="employee-status table-tornstats">参</th>\n</tr>\n</table>');const a=e.children(".company-effectiveness");a.find("th.employee-basic").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),a.find("th.employee-ws").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #458994;color: white;font-weight: bold;text-align:center;"),a.find("th.employee-effectiveness").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #757947;color: white;font-weight: bold;text-align:center;"),a.find("th.employee-status").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #725334;color: white;font-weight: bold;text-align:center;");let o=[];t.each(n.company_employees,function(t,e){e.userid=t,e.position_rank=xn(t),o.push(e)}),o.sort(function(t,e){return t.position_rank-e.position_rank});const i={0:"",1:"eff-yellow",3:"eff-red"};t.each(o,function(t,e){const o=gn(e.last_action.timestamp),r=o[0]>=172800?3:o[0]>=86400?1:0,s=e.effectiveness.addiction||0,l=s<=-10?3:s<=-5?1:0,d=e.effectiveness.merits||0,c=d<=2?3:d<=4?1:0,p=r+l+c,h=p>=3?3:p>=1?1:0,f=yn(n.company.company_type,e.position,[e.manual_labor,e.intelligence,e.endurance]);a.children().append(`\n<tr class="content">\n<td class="table-position tleft" position-value="${e.position_rank}">${e.position}</td>\n<td class="table-days">${e.days_in_company}</td>\n<td class="table-man tright ${f[2]}" man="${e.manual_labor}" title="MAN Required: ${y(f[5])}">${Rn(e.manual_labor)}</td>\n<td class="table-int tright ${f[3]}" int="${e.intelligence}" title="INT Required: ${y(f[6])}">${Rn(e.intelligence)}</td>\n<td class="table-end tright ${f[4]}" end="${e.endurance}" title="END Required: ${y(f[7])}">${Rn(e.endurance)}</td>\n<td class="table-ws">${e.effectiveness.working_stats||0}</td>\n<td class="table-ep">${f[8]}</td>\n<td class="table-last ${i[r]}" last-action-minutes="${o[0]}">${o[1]}</td>\n<td class="table-username ${i[h]}"><a class="user name" href="/profiles.php?XID=${e.userid}" target="_blank">${e.name}</a></td>\n<td class="table-settled">${e.effectiveness.settled_in||0}</td>\n<td class="table-merits ${i[c]}">${d}</td>\n<td class="table-education">${e.effectiveness.director_education||0}</td>\n<td class="table-management">${e.effectiveness.management||0}</td>\n<td class="table-addiction ${i[l]}">${s}</td>\n<td class="table-total"><b>${e.effectiveness.total||0}</b></td>\n<td class="table-tornstats tright ${f[1]}" effectiveness="${f[0]}"><span>${(100*f[0]).toFixed(0)}%</span></td>\n</tr>`)}),a.find("th").css("cursor","pointer"),a.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),a.find("td.tright").css("text-align","right"),a.find("td.tleft").css("text-align","left"),a.find("td.eff-green").css("background-color","#D0E9C6"),a.find("td.eff-yellow").css("background-color","#FAF2CC"),a.find("td.eff-red").css("background-color","#EBCCCC"),F(a.find("th.table-position"),_n),F(a.find("th.table-days"),kn),F(a.find("th.table-man"),$n),F(a.find("th.table-int"),In),F(a.find("th.table-end"),Sn),F(a.find("th.table-ws"),Dn),F(a.find("th.table-settled"),Cn),F(a.find("th.table-merits"),An),F(a.find("th.table-education"),Mn),F(a.find("th.table-management"),Tn),F(a.find("th.table-addiction"),Fn),F(a.find("th.table-total"),En),F(a.find("th.table-last"),cn),F(a.find("th.table-tornstats"),Pn)}}).catch(t=>console.log("fetch error",t))}function wn(e){let n=D("company-history-items"),a=0;n&&(a=Object.keys(n).length);const i=new Date,r=new Date(new Date(i.setDate(i.getDate()-1)).setHours(i.getHours()-2)).format("yyyy-MM-dd"),s=C("company-history-items",r),l=C("company-history-items",new Date(i.setDate(i.getDate()-1)).format("yyyy-MM-dd"));if(null===e){if(a<=0)return void console.log("没有历史数据，跳过自动获取公司产量数据");if(s)return void console.log("本次产量数据已存过，跳过自动获取公司产量数据");console.log("本次产量数据还没存过，将自动获取公司产量数据")}const d=`https://api.torn.com/company/?selections=profile,employees,stock,detailed,news&key=${o}`,c=t("#tips-view-company");c.text("---探测中---"),fetch(d).then(t=>{if(t.ok)return t.json();c.text("---探测失败---")},t=>{c.text("---网络异常---")}).then(o=>{console.log(o);const i=o.company_detailed.trains_available,{rating:d,company_type:p}=o.company;let h=0;const f=C("APICache_companies","companies");if(f&&f[p]&&f[p].positions)for(const t in o.company_employees){const e=o.company_employees[t];"Trainer"===f[p].positions[e.position].special_ability&&h++}let u=`${i}(当前)+${d}(星级)`;if(h>0&&(u+=`+0~${3*h}(Trainer)`),i+d+3*h>20&&t("#bingwa-top-warn").append(`\n<div class="info-msg border-round">\n<i class="info-icon"></i>\n<div class="delimiter">\n<div class="msg right-round" tabindex="0" role="alert">\ntrains即将溢出。\n${u}\n</div>\n</div>\n</div>`),e){if(null!=o.error&&7==o.error.code)throw c.text("---员工无权限查看---"),new Error("not a director");null!=o&&c.text("---探测完成---"),t("#companyname").text(o.company.name),e.append('\n<table class="company-effectiveness" style="width:100%;background-color: #FFF5F7;font-size:12px;">\n<tr class="head">\n<th class="employee-basic table-position">岗位</th>\n<th class="employee-basic table-days">天</th>\n<th class="employee-ws table-man">MAN</th>\n<th class="employee-ws table-int">INT</th>\n<th class="employee-ws table-end">END</th>\n<th class="employee-effectiveness table-ws" title="Working Stats">属</th>\n<th class="employee-effectiveness table-ep" title="Effectiveness Prediction">估</th>\n<th class="employee-basic table-last">登</th>\n<th class="employee-basic table-username">名字</th>\n<th class="employee-effectiveness table-settled" title="Settled In">天</th>\n<th class="employee-effectiveness table-merits" title="Merits">点</th>\n<th class="employee-effectiveness table-education" title="Director Education">课</th>\n<th class="employee-effectiveness table-management" title="Management">理</th>\n<th class="employee-effectiveness table-addiction" title="Addiction">药</th>\n<th class="employee-effectiveness table-inactivity" title="Inactivity">离</th>\n<th class="employee-effectiveness table-total" title="Total">总</th>\n<th class="employee-effectiveness table-wage" title="Wage">薪</th>\n<th class="employee-status table-tornstats">参</th>\n</tr>\n</table><br /><br />\n<table class="company-history" style="width:100%;background-color: #FFF5F7;font-size:12px;">\n<tr class="head">\n<th>日期</th>\n<th>收入</th>\n<th>工资</th>\n<th>广告费</th>\n<th>利润</th>\n<th>总效率</th>\n<th>产量</th>\n<th>销量</th>\n<th>库存</th>\n<th>单价</th>\n<th>成本</th>\n<th>记录</th>\n</tr>\n</table>');const n=e.find(".company-effectiveness");n.find("th.employee-basic").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),n.find("th.employee-ws").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #458994;color: white;font-weight: bold;text-align:center;"),n.find("th.employee-effectiveness").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #757947;color: white;font-weight: bold;text-align:center;"),n.find("th.employee-status").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #725334;color: white;font-weight: bold;text-align:center;")}let g='<br /><table class="company-stock" style="width:100%;background-color: #FFF5F7;font-size:12px;"><tr class="head"><th>库存种类</th>';t.each(o.company_stock,function(t,e){g+=`<th>${t}</th>`}),g+='</tr><tr class="content"><td class="stock-title">单价</td>',t.each(o.company_stock,function(t,e){g+=`<td class="stock-content">${y(e.price)}</td>`}),g+='</tr><tr class="content"><td class="stock-title">SOLD WORTH</td>',t.each(o.company_stock,function(t,e){g+=`<td class="stock-content">${y(e.sold_worth)}</td>`}),g+='</tr><tr class="content"><td class="stock-title">SOLD AMOUNT</td>',t.each(o.company_stock,function(t,e){g+=`<td class="stock-content">${y(e.sold_amount)}</td>`}),g+="</tr></table>",t(".company-effectiveness").after(g),t(".company-stock").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),t(".company-stock").find("td.stock-content").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),t(".company-stock").find("td.stock-title").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #458994;color: white;font-weight: bold;text-align:center;");let b=[];t.each(o.company_employees,function(t,e){e.userid=t,e.position_rank=xn(t),b.push(e)}),b.sort(function(t,e){return t.position_rank-e.position_rank});const m={0:"",1:"eff-yellow",3:"eff-red"};let x=0,v=0;t.each(b,function(t,n){if(x+=n.wage||0,v+=n.effectiveness.total||0,null===e)return!0;const a=gn(n.last_action.timestamp),i=a[0]>=172800?3:a[0]>=86400?1:0,r=n.effectiveness.addiction||0,s=r<=-10?3:r<=-5?1:0,l=n.effectiveness.inactivity||0,d=l<0?3:0,c=n.effectiveness.merits||0,p=c<=2?3:c<=4?1:0,h=i+s+p,f=h>=3?3:h>=1?1:0,u=yn(o.company.company_type,n.position,[n.manual_labor,n.intelligence,n.endurance]),g=`\n<tr class="content">\n<td class="table-position tleft" position-value="${n.position_rank}">${n.position}</td>\n<td class="table-days">${n.days_in_company}</td>\n<td class="table-man tright ${u[2]}" man="${n.manual_labor}" title="MAN Required: ${y(u[5])}">${Rn(n.manual_labor)}</td>\n<td class="table-int tright ${u[3]}" int="${n.intelligence}" title="INT Required: ${y(u[6])}">${Rn(n.intelligence)}</td>\n<td class="table-end tright ${u[4]}" end="${n.endurance}" title="END Required: ${y(u[7])}">${Rn(n.endurance)}</td>\n<td class="table-ws">${n.effectiveness.working_stats||0}</td>\n<td class="table-ep">${u[8]}</td>\n<td class="table-last ${m[i]}" last-action-minutes="${a[0]}">${a[1]}</td>\n<td class="table-username ${m[f]}"><a class="user name" href="/profiles.php?XID=${n.userid}" target="_blank">${n.name}</a></td>\n<td class="table-settled">${n.effectiveness.settled_in||0}</td>\n<td class="table-merits ${m[p]}">${c}</td>\n<td class="table-education">${n.effectiveness.director_education||0}</td>\n<td class="table-management">${n.effectiveness.management||0}</td>\n<td class="table-addiction ${m[s]}">${r}</td>\n<td class="table-inactivity ${m[d]}">${l}</td>\n<td class="table-total"><b>${n.effectiveness.total||0}</b></td>\n<td class="table-wage" wage="${n.wage}"><b>$${y(n.wage||0)}</b></td>\n<td class="table-tornstats tright ${u[1]}" effectiveness="${u[0]}"><span>${(100*u[0]).toFixed(0)}%</span></td>\n</tr>`;e.find(".company-effectiveness").children().append(g)});const w=parseInt(o.company.daily_income||0),_=parseInt(o.company_detailed.advertising_budget||0);let k=0,$=0,I=0,S=0,A=0;t.each(o.company_stock,function(t,e){k+=e.sold_amount*e.cost,$+=e.sold_amount,I+=e.in_stock,S+=e.sold_worth}),$>0&&(A=parseInt(S/$));let O=I;l?(console.log("有上一次的产量数据"),console.log(l),O=l.Stock||I):console.log("没有上一次的产量数据，本次的产量将设置为与销量相等");let E={Date:r,Income:w,Wages:x,Ad:_,Profit:w-x-_-k,Effectiveness:v,Produced:I+$-O,Sold:$,Stock:I,Price:A,Cost:k,RecordTime:(new Date).format("hh:mm:ss")};console.log(E);let N=!1;const P=o.news;for(let t in P){const e=P[t];if(e.news.indexOf("report")>=0){if(new Date(1e3*(e.timestamp-86400)).format("yyyy-MM-dd")==r){N=!0;break}}}if(s||!N?console.log("本次产量数据已存过，不再覆盖"):(console.log("本次产量数据未保存，现在保存"),M("company-history-items",r,E),n=D("company-history-items")),console.log(n),null===e)return!0;const R=e.find(".company-effectiveness");R.find("th").css("cursor","pointer"),R.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),R.find("td.tright").css("text-align","right"),R.find("td.tleft").css("text-align","left"),R.find("td.eff-green").css("background-color","#D0E9C6"),R.find("td.eff-yellow").css("background-color","#FAF2CC"),R.find("td.eff-red").css("background-color","#EBCCCC"),F(R.find("th.table-position"),_n),F(R.find("th.table-days"),kn),F(R.find("th.table-man"),$n),F(R.find("th.table-int"),In),F(R.find("th.table-end"),Sn),F(R.find("th.table-ws"),Dn),F(R.find("th.table-si"),Cn),F(R.find("th.table-me"),An),F(R.find("th.table-de"),Mn),F(R.find("th.table-ma"),Tn),F(R.find("th.table-ad"),Fn),F(R.find("th.table-ia"),On),F(R.find("th.table-to"),En),F(R.find("th.table-wg"),Nn),F(R.find("th.table-last"),cn),F(R.find("th.table-tornstats"),Pn),R.after(`<br /><b>实时人数：${Object.keys(o.company_employees).length}，总工资：$${y(E.Wages)}，广告费：$${y(E.Ad)}，周销售：$${y(o.company.weekly_income)}</b><br />`);let j={Income:0,Wages:0,Ad:0,Profit:0,Effectiveness:0,Produced:0,Sold:0,Stock:0,Price:0,Cost:0};const z=e.find(".company-history");let B=0,L=0;t.each(n,function(t,e){const a=parseInt(((new Date).getTime()-new Date(t).getTime())/864e5);if(a>31)return console.log(`删除过期数据：${t}`),T("company-history-items",t),delete n[t],!0;0;const o=new Date(t).format("dd");let i=e.RecordTime;i.indexOf(" ")>=0&&(i=i.substr(i.indexOf(" ")+1));const r=`\n<tr class="content">\n<td>${o}</td>\n<td>$${y(e.Income)}</td>\n<td>$${y(e.Wages)}</td>\n<td>$${y(e.Ad)}</td>\n<td>$${y(e.Profit)}</td>\n<td>${y(e.Effectiveness)}</td>\n<td>${y(e.Produced)}</td>\n<td>${y(e.Sold)}</td>\n<td>${y(e.Stock)}</td>\n<td>$${y(e.Price)}</td>\n<td>$${y(e.Cost)}</td>\n<td>${i||"-"}</td>\n</tr>`;z.children().append(r),j.Income+=parseInt(e.Income),j.Wages+=parseInt(e.Wages),j.Ad+=parseInt(e.Ad),j.Profit+=parseInt(e.Profit),j.Effectiveness+=parseInt(e.Effectiveness),j.Produced+=parseInt(e.Produced),j.Sold+=parseInt(e.Sold),j.Stock+=parseInt(e.Stock),j.Price+=parseInt(e.Price),j.Cost+=parseInt(e.Cost||0),a<=7&&(B+=parseInt(e.Profit),L++)}),a=Object.keys(n).length;const W=`\n<tr class="content">\n<td><b>平均</b></td>\n<td>$${y((j.Income/a).toFixed(0))}</td>\n<td>$${y((j.Wages/a).toFixed(0))}</td>\n<td>$${y((j.Ad/a).toFixed(0))}</td>\n<td>$${y((j.Profit/a).toFixed(0))}</td>\n<td>${y((j.Effectiveness/a).toFixed(0))}</td>\n<td>${y((j.Produced/a).toFixed(0))}</td>\n<td>${y((j.Sold/a).toFixed(0))}</td>\n<td>${y((j.Stock/a).toFixed(0))}</td>\n<td>$${y((j.Price/a).toFixed(0))}</td>\n<td>$${y((j.Cost/a).toFixed(0))}</td>\n<td>${(new Date).format("hh:mm:ss")}</td>\n</tr>`;z.children().append(W),z.find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),z.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),z.after(`<br /><b>共 ${a} 天数据，总利润：$${y(j.Profit)}，近一周(${L}天)利润：$${y(B)}</b>`)}).catch(t=>console.log("fetch error: ",t.message))}function _n(e){return t(e).find("td.table-position").attr("position-value")}function kn(e){return t(e).find("td.table-days").text()}function $n(e){return t(e).find("td.table-man").attr("man")}function In(e){return t(e).find("td.table-int").attr("int")}function Sn(e){return t(e).find("td.table-end").attr("end")}function Dn(e){return t(e).find("td.table-ws").text()}function Cn(e){return t(e).find("td.table-settled").text()}function An(e){return t(e).find("td.table-merits").text()}function Mn(e){return t(e).find("td.table-education").text()}function Tn(e){return t(e).find("td.table-management").text()}function Fn(e){return t(e).find("td.table-addiction").text()}function On(e){return t(e).find("td.table-inactivity").text()}function En(e){return t(e).find("td.table-total").text()}function Nn(e){return t(e).find("td.table-wage").attr("wage")}function Pn(e){return t(e).find("td.table-tornstats").attr("effectiveness")}function Rn(t){return t<1e4?t.toString().replace(/\d{1,3}(?=(\d{3})+$)/g,function(t){return t+","}):parseInt(t/1e3)+"k"}function jn(t){return new Promise((e,n)=>{fetch(`https://api.torn.com/user/${t}?selections=profile&key=${o}`).then(e=>{if(e.ok)return e.json();console.log("---探测失败 "+t+"---")},e=>{console.log("---网络异常 "+t+"---")}).then(a=>{null!=a?"error"in a?n(a.error):(console.log(`userId2otherIds: ${t} => (${a.faction.faction_id} - ${a.faction.position}) (${a.job.company_id} - ${a.job.job})`),e([a.faction.faction_id,a.faction.position,a.job.company_id,a.job.job])):n()}).catch(t=>n(t))})}function zn(e){return new Promise((n,a)=>{const i=t("#mainContainer").find("div:contains('unavailable')").last();i.text("蛙蛙探测器工作中...");fetch(`https://api.torn.com/faction/${e}?selections=basic,chain&key=${o}`).then(t=>{if(t.ok)return t.json();i.text("---探测失败 "+e+"---")},t=>{i.text("---网络异常 "+e+"---")}).then(o=>{if(null!=o)if("error"in o)a(o.error);else{t("#skip-to-content").text(`帮派: ${o.name}`),i.html(`<b>声望:</b> ${y(o.respect)}&nbsp;&nbsp;&nbsp;&nbsp;<b>天数:</b> ${y(o.age)}&nbsp;&nbsp;&nbsp;&nbsp;<b>最大连击:</b> ${y(o.best_chain)}&nbsp;&nbsp;&nbsp;&nbsp;<b>成员数:</b> ${Object.keys(o.members).length}`),o.chain.current>0&&i.append(`</br /></br /><b>正在连击:</b> ${y(o.chain.current)}/${y(o.chain.max)}&nbsp;&nbsp;&nbsp;&nbsp;<b>开始时间:</b> ${new Date(1e3*o.chain.start).format("yyyy-MM-dd hh:mm:ss")}&nbsp;&nbsp;&nbsp;&nbsp;<b>连击超时:</b> ${o.chain.timeout}(秒)&nbsp;&nbsp;&nbsp;&nbsp;<b>声望系数:</b> ${o.chain.modifier}&nbsp;&nbsp;&nbsp;&nbsp;<b>冷却时间:</b> ${o.chain.cooldown}`),o.territory_wars&&Object.keys(o.territory_wars).length>0&&(i.append("</br />"),t.each(o.territory_wars,function(t,n){n.assaulting_faction==e?i.append(`</br /><b>正在进攻地盘:</b> ${n.territory}&nbsp;&nbsp;&nbsp;&nbsp;<b>防守方:</b> <a href='/factions.php?step=profile&ID=${n.defending_faction}' target='_blank'>${n.defending_faction}</a>`):i.append(`</br /><b>正在防守地盘:</b> ${n.territory}&nbsp;&nbsp;&nbsp;&nbsp;<b>进攻方:</b> <a href='/factions.php?step=profile&ID=${n.assaulting_faction}' target='_blank'>${n.assaulting_faction}</a>`),i.append(`&nbsp;&nbsp;&nbsp;&nbsp;<b>推墙进度:</b> ${y(n.score)}/${y(n.required_score)}&nbsp;&nbsp;&nbsp;&nbsp;<b>最迟结束时间:</b> ${new Date(1e3*n.end_time).format("yyyy-MM-dd hh:mm:ss")}`)})),o.peace&&Object.keys(o.peace).length>0&&(i.append("</br />"),t.each(o.peace,function(t,e){i.append(`</br /><b>和平条约:</b> <a href='/factions.php?step=profile&ID=${t}' target='_blank'>${t}</a>&nbsp;&nbsp;&nbsp;&nbsp;<b>到期时间:</b> ${new Date(1e3*e).format("yyyy-MM-dd hh:mm:ss")}`)})),o.raid_wars&&Object.keys(o.raid_wars).length>0&&(i.append("</br />"),t.each(o.raid_wars,function(t,n){n.raiding_faction==e?i.append(`</br /><b>正在突击:</b> <a href='/factions.php?step=profile&ID=${n.defending_faction}' target='_blank'>${n.defending_faction}</a>`):i.append(`</br /><b>正在被</b> <a href='/factions.php?step=profile&ID=${n.raiding_faction}' target='_blank'>${n.raiding_faction}</a> 突击`),i.append(`&nbsp;&nbsp;&nbsp;&nbsp;<b>突击进度(攻/守):</b> ${n.raider_score}/${n.defender_score}&nbsp;&nbsp;&nbsp;&nbsp;<b>开始时间:</b> ${new Date(1e3*n.start_time).format("yyyy-MM-dd hh:mm:ss")}`)})),t(".content-wrapper").last().append('\n<table id="faction-members" style="width:100%;background-color: #FFF5F7;font-size:12px;">\n<tr class="head">\n<th>名字</th>\n<th>天数</th>\n<th>上次活动</th>\n<th>状态</th>\n<th>角色</th>\n</tr>\n</table>');const a=t("#faction-members");t.each(o.members,function(t,e){const n=`\n<tr class="content">\n<td><a href='/profiles.php?XID=${t}' target='_blank'>${e.name}</a></td>\n<td>${e.days_in_faction}</td>\n<td>${e.last_action.relative}</td>\n<td>${e.status.description}</td>\n<td>${e.position}</td>\n</tr>`;a.children().append(n)}),a.find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),a.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),n()}else a()}).catch(t=>i.text(t))})}function Bn(e){return new Promise((n,a)=>{if(t("div.company-details").children("div.title-black").text().indexOf("Oil Rig")>=0){const e=t("div.company-details").find("li:contains('Daily income')").text().replace(/[^\d]/g,"");for(let n=250;n>=120;--n)if(e%n==0){const a=parseInt(e/n);t("div.company-details").children("div.title-black").append(`<span class="m-hide"> - 估算销售: ${n} x ${y(a)} </span>`)}}const i=t("#mainContainer").find("div:contains('unavailable')").last();i.text("蛙蛙探测器工作中...");fetch(`https://api.torn.com/company/${e}?selections=profile&key=${o}`).then(t=>{if(t.ok)return t.json();i.text("---探测失败 "+e+"---")},t=>{i.text("---网络异常 "+e+"---")}).then(e=>{if(null!=e)if("error"in e)a(e.error);else{const n={1:"Hair Salon",2:"Law Firm",3:"Flower Shop",4:"Car Dealership",5:"Clothing Store",6:"Gun Shop",7:"Game Shop",8:"Candle Shop",9:"Toy Shop",10:"Adult Novelties",11:"Cyber Cafe",12:"Grocery Store",13:"Theater",14:"Sweet Shop",15:"Cruise Line",16:"Television Network",18:"Zoo",19:"Firework Stand",20:"Property Broker",21:"Furniture Store",22:"Gas Station",23:"Music Store",24:"Nightclub",25:"Pub",26:"Gents Strip Club",27:"Restaurant",28:"Oil Rig",29:"Fitness Center",30:"Mechanic Shop",31:"Amusement Park",32:"Lingerie Store",33:"Meat Warehouse",34:"Farm",35:"Software Corporation",36:"Ladies Strip Club",37:"Private Security Firm",38:"Mining Corporation",39:"Detective Agency",40:"Logistics Management"};if(t("#skip-to-content").html(`公司: ${e.company.name}`),i.html(`<b>类型:</b> ${n[e.company.company_type]}&nbsp;&nbsp;&nbsp;&nbsp;<b>星级:</b> ${e.company.rating}&nbsp;&nbsp;&nbsp;&nbsp;<b>员工数:</b> ${e.company.employees_hired}/${e.company.employees_capacity}&nbsp;&nbsp;&nbsp;&nbsp;<b>日销售:</b> $${y(e.company.daily_income)}&nbsp;&nbsp;&nbsp;&nbsp;<b>周销售:</b> $${y(e.company.weekly_income)}&nbsp;&nbsp;&nbsp;&nbsp;<b>天数:</b> ${y(e.company.days_old)}`),28==e.company.company_type){i.append("&nbsp;&nbsp;&nbsp;&nbsp;<b>估算单价x销量:</b>");for(let t=200;t>=120;--t)if(e.company.daily_income%t==0){const n=parseInt(e.company.daily_income/t);i.append(` ${t}x${y(n)}`)}}else if(16==e.company.company_type){const t=parseInt(e.company.daily_income/e.company.daily_customers);i.append(`&nbsp;&nbsp;&nbsp;&nbsp;<b>单价x销量:</b> ${y(t)}x${y(e.company.daily_customers)}`)}t(".content-wrapper").last().append('\n<table id="company-members" style="width:100%;background-color: #FFF5F7;font-size:12px;">\n<tr class="head">\n<th>名字</th>\n<th>天数</th>\n<th>上次活动</th>\n<th>状态</th>\n<th>职位</th>\n</tr>\n</table>');const a=t("#company-members");t.each(e.company.employees,function(t,e){const n=`\n<tr class="content">\n<td><a href='/profiles.php?XID=${t}' target='_blank'>${e.name}</a></td>\n<td>${e.days_in_company}</td>\n<td>${e.last_action.relative}</td>\n<td>${e.status.description}</td>\n<td>${e.position}</td>\n</tr>`;a.children().append(n)}),a.find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),a.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;")}else a()}).catch(t=>i.text(t))})}if(window.location.href.indexOf("factions.php?step=your")>=0){const ta=t("[href^='/forums.php#!p=forums&f=999&b=1&a=']").attr("href");let ea=0;if(null!=ta&&(ea=ta.substring(34),window.localStorage.setItem("MY_FACTION_ID",ea)),foo){let na=setInterval(oa,1e3),aa=0;function oa(){if(window.location.href.indexOf("factions.php?step=your#/tab=info")>=0&&t("li.position").length>0){clearInterval(na),aa=setInterval(ia,1e3),console.log("li position"),en("div.f-war-list","ul.table-body");mn(t("div[data-faction]").attr("data-faction"))}}function ia(){console.log("faction info"),window.location.href.indexOf("factions.php?step=your#/tab=info")<0&&(clearInterval(aa),na=setInterval(oa,1e3))}}}if(window.location.href.indexOf("factions.php?step=profile&")>=0){if(t("#mainContainer").find("div:contains('unavailable')").last().length>0){if(window.location.href.indexOf("profile&ID=")>=0){const ra=/profile&ID=(\d+)/.exec(window.location.href)[1];console.log("fID "+ra),zn(ra).catch(t=>console.log("factionPageRedraw "+t))}else if(window.location.href.indexOf("profile&userID=")>=0){const sa=/userID=(\d+)/.exec(window.location.href)[1];console.log("userId "+sa),jn(sa).then(function(t){console.log(t);zn(t[0]).catch(t=>console.log("factionPageRedraw "+t))}).catch(t=>console.log("userId2otherIds "+t))}}else if(foo){const la=setInterval(da,1e3);function da(){if(t("li.position").length>0){clearInterval(la),console.log("li position"),en("div.f-war-list","ul.table-body");mn(t("div[data-faction]").attr("data-faction"))}}}}if(window.location.href.indexOf("p=corpinfo&")>=0)if(window.location.href.indexOf("corpinfo&ID=")>=0){const ca=/corpinfo&ID=(\d+)/.exec(window.location.href)[1];console.log("companyID "+ca),new Promise(function(t,e){setTimeout(function(){console.log("2 Seconds"),t()},2e3)}).then(function(){Bn(ca).catch(t=>console.log("companyPageRedraw "+t))}).catch(t=>console.log("companyPageRedraw "+t))}else if(window.location.href.indexOf("corpinfo&userID=")>=0){const pa=/userID=(\d+)/.exec(window.location.href)[1];console.log("userId "+pa),jn(pa).then(function(t){return new Promise(function(e,n){setTimeout(function(){console.log("2 Seconds"),e(t)},2e3)})}).then(function(t){console.log(t);Bn(t[2]).catch(t=>console.log("companyPageRedraw "+t))}).catch(t=>console.log("userId2otherIds "+t))}if("https://www.torn.com/competition.php"==window.location.href||"https://www.torn.com/competition.php#/p=main"==window.location.href){const ha=t("#mainContainer").find("div:contains('access')").last();if(ha.length>0){ha.text("蛙蛙探测器工作中...");fetch(`https://api.torn.com/torn/?selections=competition&key=${o}`).then(t=>{if(t.ok)return t.json();ha.text("---探测失败 ---")},t=>{ha.text("---网络异常 ---")}).then(e=>{t(".content-wrapper").last().append('\n<table id="elim-teams" style="margin-top:10px;width:100%;background-color: #FFF5F7;font-size:12px;">\n<tr class="head">\n<th>排名</th>\n<th>队伍</th>\n<th>状态</th>\n<th>分数</th>\n<th>生命</th>\n<th>参与人数</th>\n<th>攻击胜利</th>\n<th>被攻击</th>\n</tr>\n</table>');const n=t("#elim-teams");e.competition.teams.forEach(function(t){const e=`\n<tr class="content">\n<td>${t.position}</td>\n<td>${t.name}</td>\n<td>${t.status}</td>\n<td>${t.score}</td>\n<td>${t.lives}</td>\n<td>${t.participants}</td>\n<td>${t.wins}</td>\n<td>${t.losses}</td>\n</tr>`;n.children().append(e)}),n.find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: #033649;color: white;font-weight: bold;text-align:center;"),n.find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;")}).catch(t=>ha.text(t))}}if(window.location.href.indexOf("competition.php")>=0){setInterval(fa,500);function fa(){t(".description").next().remove(),t(".description").remove();const e=t("#e-showAvailable-targets").parent();if(e.length>0&&"1"!=e.attr("hasdone")){e.after('\n<div id="elim-parade">\n<div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">Elimination Parade\n</div>\n<div class="cont-gray bottom-rounded content" style="overflow:hidden; margin-bottom:10px;">\n<div class="button-wrap" style="margin:5px; float:left">\n<button id="elim-parade-start-btn" class="torn-btn" style="margin:5px;">开始阅兵</button>\n<button id="elim-parade-stop-btn"class="torn-btn" style="margin:5px;">暂停阅兵</button>\n<p id="elim-parade-status" style="height:12px; padding:6px 1px;"></p>\n</div>\n</div>\n</div>'),e.attr("hasdone","1");const n=t("#competition-wrap").children(".team-list-wrap").children(".competition-list").children("li");n.each(function(){const e=fn(t(this).find("a.user.name").attr("href").replace(/[^0-9|-]/gi,""));0!=e[0]&&t(this).children("ul.list-cols").children("li.attack").children("a").text(e[2])});let a=!0;t("#elim-parade-start-btn").click(function(){a=!0,t("#elim-parade-start-btn").prop("disabled",!0),t("#elim-parade-stop-btn").removeAttr("disabled");const e=n.first();if(e.length<=0)return t("#elim-parade-status").text("未找到用户列表"),void t("#elim-parade-start-btn").removeAttr("disabled");function o(e){if("1"==e.attr("detected"))t("#elim-parade-status").text("用户已完成"),setTimeout(()=>{o(e.next())},0);else{if(e.length<=0||0==a)return t("#elim-parade-status").text("阅兵已结束"),t("#elim-parade-start-btn").removeAttr("disabled"),void t("#elim-parade-stop-btn").prop("disabled",!0);{e.attr("detected","1");const n=e.find("a.user.name").attr("href").replace(/[^0-9|-]/gi,"");t("#elim-parade-status").text("正在阅兵: "+n),N(n,function(t){e.children("ul.list-cols").children("li.attack").children("a").text(v(t.estimate_bs)),M("battlestats",n,t.estimate_bs),M("networths",n,t.personalstats.networth),setTimeout(()=>{o(e.next())},1e3)},function(a){t("#elim-parade-status").text("蛙蛙探测 "+n+" 失败 "+a),setTimeout(()=>{o(e.next())},1e3)})}}}t("#elim-parade-status").text("阅兵开始"),setTimeout(()=>{o(e)},1e3)}),t("#elim-parade-stop-btn").click(function(){a=!1})}}}if(bounty_parade&&window.location.href.indexOf("bounties.php#!p=main")){setInterval(ua,2e3);function ua(){const e=t("ul.bounties-list").children().first();function n(e){e.attr("detected","1");const a=e.find("div.status");if(a.children(".user-red-status").length>0||a.children(".user-blue-status").length>0)t("div.bounties-total").text("本条已阅兵完毕"),setTimeout(()=>{n(e.next())},0);else{if(null==e.attr("data-id"))return void t("div.bounties-total").text("本页阅兵结束");{const o=e.find("div.target").children("a"),i=o.attr("href").replace(/[^0-9]/gi,""),r=o.text();t("div.bounties-total").text("正在阅兵: "+i+" "+r),N(i,function(t){a.children(".user-green-status").text(v(t.estimate_bs)),M("battlestats",i,t.estimate_bs),setTimeout(()=>{n(e.next())},0)},function(a){t("div.bounties-total").text("蛙蛙探测 "+i+" 失败 "+a),setTimeout(()=>{n(e.next())},0)})}}}e.length<=0?t("div.bounties-total").text("未找到用户列表"):"1"!=e.attr("detected")&&(t("div.bounties-total").text("阅兵开始"),setTimeout(()=>{n(e)},0))}}if(mugoo&&window.location.href.includes("/page.php?sid=ItemMarket")){const ga=C("bazaar_bookmark","favorite")??[],ba={popular:{title:"重要",color:f,items:[{id:283,name:"Donator"},{id:206,name:"Xanax"},{id:366,name:"Erotic"},{id:370,name:"Drug"},{id:367,name:"FHC"},{id:240,name:"Anti Tank"},{id:421,name:"Large Suitcase"},{id:818,name:"Six-Pack Energy"},{id:511,name:"Colina"}]},flower:{title:"花花",color:u,items:[{id:385,name:"Tribulus"},{id:276,name:"Peony"},{id:282,name:"African"},{id:277,name:"Cherry"},{id:267,name:"Heather"},{id:271,name:"Ceibo"},{id:272,name:"Edelweiss"}]},plushie:{title:"玩偶",color:c,items:[{id:384,name:"Camel"},{id:281,name:"Lion"},{id:274,name:"Panda"},{id:269,name:"Monkey"},{id:273,name:"Chamois"},{id:268,name:"Red Fox"},{id:266,name:"Nessie"}]},can:{title:"能饮",color:h,items:[{id:555,name:"X-MASS"},{id:533,name:"Taurine Elite"},{id:554,name:"Rockstar Rudolph"},{id:532,name:"Red Cow"},{id:530,name:"Munster"},{id:553,name:"Santa Shooters"}]},favorite:{title:"其它",color:f,items:ga}},ma=setInterval(wa,500);let ya="";function xa(t,e){ga.find(e=>e.id===t)||(ga.push({id:t,name:e}),M("bazaar_bookmark","favorite",ga))}function va(t){const e=ga.findIndex(e=>e.id===t);e>=0&&(ga.splice(e,1),M("bazaar_bookmark","favorite",ga))}function wa(){const e=t(".marketWrapper___S5pRm");if(0===e.length||t("#bw-market-bookmarks").length>0)return;clearInterval(ma);const n=t('<div id="bw-market-bookmarks" style="background: var(--default-bg-panel-color); padding: 8px; border-radius: 4px; margin-bottom: 8px; display: flex; flex-direction: column; gap: 8px; color: white;"></div>');e.before(n);for(const e of Object.values(ba)){if(0===e.items.length)continue;const a=t(`<div style="display: flex; gap: 8px;">\n<div style="padding:4px; flex-shrink: 0; height: fit-content; background-color:${s};">${e.title}</div>\n<div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;"></div>\n</div>`);for(const t of e.items){const n=`/page.php?sid=ItemMarket#/market/view=search&itemID=${t.id}&itemName=${t.name}&itemType=Drug`;a.children().last().append(`<a class="border-round" href="${n}" style="padding:4px; background-color:${e.color}; color: inherit; text-decoration: none;">${t.name}</a>`)}n.append(a)}_a();new MutationObserver(_a).observe(e[0],{childList:!0,subtree:!0})}function _a(){const e=t(".marketWrapper___S5pRm .title___ruNCT").first();if(0===e.length||e.text()===ya)return;ya=e.text(),e.siblings(".bw-favor").remove();let n=null,a=null;try{const t=new URL(location.href),e=new URLSearchParams(t.hash);n=parseInt(e.get("itemID")),a=e.get("itemName")}catch(t){}if(!n||!a)return;const o=Object.values(ba).map(t=>t.items).flat().map(t=>t.id).includes(n),i=ba.favorite.items.map(t=>t.id).includes(n),r=t('<span class="bw-favor border-round" style="margin: 0 10px; padding:4px; color: white; cursor: pointer; font-weight: normal;"></span>');e.after(r),i?(r.css("background",l),r.text("取消收藏"),r.on("click",function(){va(n),location.reload()})):o||(r.css("background",d),r.text("收藏"),r.on("click",function(){xa(n,a),location.reload()}))}}if(mugoo&&window.location.href.indexOf("pmarket.php")>=0){const ka=setInterval($a,500);function $a(){const e=t(".users-point-sell").children("li");if(e&&e.length>0){clearInterval(ka);let n=[];t("li.total-price").attr("id","total-price");const a=document.getElementById("total-price"),o=window.getComputedStyle(a).width.replace(/px$/g,"");e.each(function(e,a){const r=t(this).find(".total-price"),h=t(this).find(".user.name").attr("href"),f=h?h.replace(/[^\d]/g,""):0,u=t(this).find(".user.faction").attr("href");(u?u.replace(/[^\d]/g,""):0)in i&&t(this).css("background-color",d),-1==n.indexOf(f)&&(n.push(f),Number(o)<200&&r.text(""),N(f,function(t){const e=gn(t.last_action.timestamp),n=t.status.color,a=bn(t.status.description,t.status.state,t.status.until),o=t.job.company_type,i=t.basicicons.icon72;let h="打",f=p;5==o&&(h="衣",f=s),null!=i&&(h="新",f=s);let u="";"blue"==n&&(u=c),"green"==n&&(u=d),"red"==n&&(u=l);let g="<span class='left'>";g+=`<span style="padding:1px;margin:1px;background-color:${f};color:white;">${h}</span>`,g+=`<span style="padding:1px;margin:1px;background-color:${u};color:white;" title="Status: ${t.status.description}">${a[0]}</span>`,g+=`<span style="padding:1px;margin:1px;background-color:${s};color:white;" title="Last Action: ${t.last_action.relative}">${e[1]}</span>`,g+=`<span style="padding:1px;margin:1px;background-color:${c};color:white;" title="BattleStats: ${v(t.estimate_bs)}">${v(t.estimate_bs)}</span></span>`,r.prepend(g)}))})}}}if(mugoo&&window.location.href.indexOf("bazaar.php")>=0){let Ia={};const Sa=t("#mainContainer").find("div:contains('unavailable')").last();if(Sa.length>0){const Ma=window.location.href.replace(/[^\d]/g,"");Sa.text("蛙蛙探测器工作中...");fetch(`https://api.torn.com/user/${Ma}?selections=basic,bazaar&key=${o}`).then(t=>{if(t.ok)return t.json();Sa.text("---探测失败 "+fID+"---")},t=>{Sa.text("---网络异常 "+fID+"---")}).then(e=>{if(Sa.html(`蛙蛙探测成功^_^ [ <a class="t-blue" href="/profiles.php?XID=${e.player_id}">${e.name}</a>的小店 ]`),null==e.bazaar)Sa.html(`货物卖光了:( [ <a class="t-blue" href="/profiles.php?XID=${e.player_id}">${e.name}</a>的小店 ]`),console.log("no item in bazaar");else{t(".content-wrapper").last().append('<div class="bazaar-wrapper" style="margin-top:10px;"><div class="bazaar-content" style="width:inherit; overflow:hidden; background-color:white;"></div></div>');for(let n=0;n<e.bazaar.length;n++){const a=((e.bazaar[n].price-e.bazaar[n].market_price)/e.bazaar[n].market_price*100).toFixed(2);let o="";o=a>0?`&nbsp;&nbsp;<span class="change up"><i class="arrow-change-icon" role="img" aria-label="stock price is up"></i><span class="t-green">${a}%</span></span>`:`&nbsp;&nbsp;<span class="change down"><i class="arrow-change-icon" role="img" aria-label="stock price is down"></i><span class="t-red">${a}%</span></span>`,t(".bazaar-content").append(`\n<div class="item-wrapper" style="width:288px; float:left; overflow:hidden;">\n<div style="width:100px; height:50px; margin:7px; padding:3px; float:left; border:1px solid darkgray;">\n<img src="/images/items/${e.bazaar[n].ID}/large.png">\n</div>\n<div class="item-description" style="width:150px; margin:7px; float:left; border:1px solid darkgray;overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">\n<p class="item-name" style="margin:5px">${e.bazaar[n].name}</p>\n<p class="item-price" style="margin:5px">${x(e.bazaar[n].price)}${o}</p>\n<p class="item-quantity" style="margin:5px">(${e.bazaar[n].quantity} in stock)\n<span class="t-blue">&nbsp;&nbsp;${v(e.bazaar[n].price*e.bazaar[n].quantity)}</span>\n</p>\n</div>\n</div>`)}}}).catch(t=>Sa.text(t))}else{Da();setInterval(Aa,500)}function Da(){const t=C("ITEMS","last-updated");if(null!=t&&null!=t){const e=new Date;let n=new Date(t);n.setDate(n.getDate()+1),n<e&&Ca()}else Ca()}function Ca(){fetch(`https://api.torn.com/torn/?selections=items&key=${o}`).then(t=>t.json()).then(t=>{console.log("API fetched");let e={};const n=new Date;e["last-updated"]=n.toString();for(let n in t.items)e[n]=t.items[n].market_value;window.localStorage.setItem("ITEMS",JSON.stringify(e))}).catch(t=>console.log("fetch error",t))}function Aa(){const e=t("[class*='messageContent___']");if("1"!=e.attr("hasdone")){e.attr("hasdone","1"),t("#sum").remove();let n='<div id="sum">',a=0;for(let t in Ia)n+=" (<span class='t-green'> "+Ia[t].name+" "+Ia[t].total_formal+" </span>) ",a+=Ia[t].total;n+="<span class='t-red'><b> Total Selected: "+v(a)+" </b></span></div>",e.append(n)}const n=C("ITEMS","last-updated"),a=t("[class^='rowItems___']").children();n&&a&&a.length>0&&a.each(function(n,a){const o=t(this).find("[class^='name___']").text(),i=t(this).find("[class^='price___']"),r=t(this).find("[class^='price___'] .rates___YCU9W"),s=i.text().slice(0,-r.text().length);let l=0;""!==s&&(l=parseInt(s.replace(/[^\d]/g,"")));const d=t(this).find("img").attr("src");let c=0,p=0;null!=d&&(p=d.split("/")[3],p>0&&(c=C("ITEMS",p)));const h=t(this).find("[class^='amount___']");let f=0;if(""!=h.text()&&(f=h.text().replace(/[^\d]/g,"")),c>0&&l>0&&f>0&&"1"!=t(this).attr("hasdone")){t(this).attr("hasdone","1");const n=v(l*f);h.append(`&nbsp;&nbsp;<span><span class="t-blue">${n}</span></span>`);const a=t(this).find("[class^='description___']");null!=Ia[p]&&a.css("background-color","NavajoWhite"),a.click(function(){t(this).attr("selected")?(delete Ia[p],t(this).removeAttr("selected"),e.removeAttr("hasdone"),t(this).css("background-color","")):(Ia[p]={name:o,price:l,amount:f,total:l*f,total_formal:v(l*f)},t(this).attr("selected","selected"),e.removeAttr("hasdone"),t(this).css("background-color","NavajoWhite"))})}})}}if(mugoo&&window.location.href.indexOf("imarket.php")>=0){setInterval(Ta,500);function Ta(){const e=t(".buy-item-info").find(".private-bazaar");e.length>0&&e.each(function(e,n){if("1"!=t(this).attr("hasdone")){t(this).attr("hasdone","1");const e=t(this).find('[href^="bazaar"]').attr("href").replace(/[^\d]/g,""),n=t(this);N(e,function(t){n.attr("user_id",e),n.attr("user_name",t.name),n.attr("user_level",t.level),n.attr("user_bs",v(t.estimate_bs)),n.attr("user_last",t.last_action.relative),n.attr("user_stat",t.status.description),n.attr("user_job_type",t.job.company_type),n.attr("newbie",t.basicicons.icon72)})}});const n=t(".buy-item-info-wrap").find(".private-bazaar");n.length>0&&n.each(function(n,a){if("1"!=t(this).attr("hasdone")){const n=t(this).find('[href^="bazaar"]').attr("href").replace(/[^\d]/g,""),a=t(this).find(".user.faction").attr("href");(a?a.replace(/[^\d]/g,""):0)in i&&t(this).css("background-color",d);const o=t(this);e.each(function(e,a){if(t(this).attr("user_id")==n){console.log(t(this).attr("user_name"));const e=t(this).attr("user_name"),a=t(this).attr("user_level"),i=t(this).attr("user_bs"),r=t(this).attr("user_last"),s=t(this).attr("user_stat"),l=t(this).attr("user_job_type"),d=t(this).attr("newbie");let c="打";5==l?c="衣":null!=d&&(c="新");const p=`\n<li class="private-bazaar wawa-bazaar" hasdone="1">\n<ul class="item t-blue-cont h">\n<li class="item-name">\n<div class="item-t right t-gray-9">${s}</div>\n<div class="name-t icons left">\n<span class="t-gray-9">Lv:${a}</span>\n<a class="user name" href="/profiles.php?XID=${n} ">\n<span title="${e} [${n}]"><b>BS: ${i}</b><span></span></span>\n</a>\n</div>\n<div class="name-t name-mobile left">\n<span class="t-gray-9 italic">sold by</span>\n<a class="t-blue" href="profiles.php?XID=${n}">BS: ${i}</a>\n</div>\n<div class="clear"></div>\n</li>\n<li class="cost">\n<span class="t-gray-9" title="${s}">${r}</span>\n</li>\n<li class="view">\n<a href="/loader.php?sid=attack&user2ID=${n}"><b>${c}</b></a>\n</li>\n<li class="clear"></li>\n</ul>\n</li>`;return o.after(p),o.attr("hasdone","1"),!1}})}})}}if(window.location.href.indexOf("loader.php?sid=attack&user2ID")>=0){const Fa=window.location.href.match(/loader\.php\?sid=attack\&user2ID=(\d+)/)[1],Oa=setInterval(Ea,300);function Ea(){const e=t("[class^='btn___']");if(e.length>0){const n=e[0];if(t(n).text().includes("CONTINUE")){const e=t(n).parent().parent().children(":first").text().split(" ");clearInterval(Oa),console.log(e);const a=e[2],o=e[1],i=new Date,r=parseInt(i.getTime()/1e3),s=i.format("yyyy-MM-dd hh:mm:ss");if("mugged"==o){let t=e[5];console.log(t),"wallet"==t&&(t="$0");M("muglog",r,{timestring:s,victim_id:Fa,victim_name:a,money_mugged:t})}}}}}if(window.location.href.indexOf("companies.php")>=0){t(".info-msg-cont").after("<div id='effectiveness-wrap' style='margin-top:10px; overflow: auto hidden; padding-bottom: 5px;'></div>"),t(".info-msg-cont").after('<div id="bingwa-top-warn" class="info-msg-cont red border-round m-top10">');const Na=W();console.log("userId "+Na),jn(Na).then(function(e){console.log(e);const n=e[3];"Employee"===n?vn(t("#effectiveness-wrap")):"Director"===n&&wn(t("#effectiveness-wrap"))}).catch(t=>console.log("userId2otherIds "+t));const Pa=setInterval(Ra,1e3);function Ra(){const e=t(".employee-list-wrap").children("ul.employee-list").children("li");if(e.length>0){clearInterval(Pa);let n={},a=0;e.each(function(e,o){const i=t(this).attr("data-user");n[i]=a,a+=1}),window.localStorage.setItem("EMPLOYEE_RANK",JSON.stringify(n))}}}else wn(null);if(window.location.href.indexOf("joblist.php")>=0){setInterval(ja,500);function ja(){const e=t("ul.rank-list");if(e.length>0&&"1"!=e.attr("hasdone")){e.attr("hasdone","1");const n='\n<div id="company_parade">\n<div class="title-black m-top10 title-toggle tablet top-round faction-title active title" data-title="description" role="heading" aria-level="5">公司阅兵</div>\n<div class="cont-gray bottom-rounded content" style="overflow:hidden; margin-bottom:10px;">\n<button id="company_parade_start_btn" class="torn-btn" style="margin:5px;">开始阅兵</button>\n<button id="company_parade_stop_btn" class="torn-btn" style="margin:5px;">暂停阅兵</button>\n<span id="company_parade_tip" style="margin:5px;"></span>\n</div>\n</div>';e.after(n);let a=!0;t("#company_parade_start_btn").click(function(){a=!0,t("#company_parade_start_btn").prop("disabled",!0),t("#company_parade_stop_btn").removeAttr("disabled");const e=t("ul.company-list").children().first();if(e.length<=0)return t("#company_parade_tip").text("未找到公司列表"),t("#company_parade_start_btn").removeAttr("disabled"),void t("#company_parade_stop_btn").prop("disabled",!0);function n(e){if("1"==e.attr("detected"))t("#company_parade_tip").text("公司已完成"),setTimeout(()=>{n(e.next())},0);else{if(e.length<=0||0==a)return t("#company_parade_tip").text("阅兵已结束"),t("#company_parade_start_btn").removeAttr("disabled"),void t("#company_parade_stop_btn").prop("disabled",!0);{e.attr("detected","1");const a=e.children().children("li.view").children().attr("href"),i=a?a.replace(/[^\d]/g,""):0,r=e.children().children("li.company").text(),s=`https://api.torn.com/company/${i}?selections=profile&key=${o}`;t("#company_parade_tip").text(`正在阅兵：${i} ${r}`),fetch(s).then(t=>t.json()).then(a=>{if("company"in a){const o=a.company.director,r=a.company.employees[o].name;let s=0,l=0;const d=parseInt((new Date).getTime()/1e3);for(let t in a.company.employees){d-a.company.employees[t].last_action.timestamp>=86400&&(s+=1);a.company.employees[t].days_in_company<10&&(l+=1)}t("#company_parade_table").children().append(`\n<tr class="content">\n<td>${a.company.rating}</td>\n<td><a href="#!p=corpinfo&ID=${i}" target="_blank">${a.company.name}</a></td>\n<td><a class="user name" href="/profiles.php?XID=${o}" target="_blank">${r}</a></td>\n<td>${a.company.days_old}</td>\n<td>${a.company.employees_hired}/${a.company.employees_capacity}</td>\n<td>${s}</td>\n<td>${l}</td>\n<td>${v(a.company.daily_income)}</td>\n<td>${v(a.company.daily_income/a.company.daily_customers)}</td>\n<td>${v(a.company.weekly_income)}</td>\n<td>${v(a.company.weekly_income/a.company.weekly_customers)}</td>\n</tr>`),t("#company_parade_table").find("td").attr("style","border: 1px solid darkgray;padding:5px;text-align:center;"),setTimeout(()=>{n(e.next())},1e3)}else"error"in a&&t("#company_parade_tip").text(`蛙蛙探测失败：${i} ${r} ${a.error.error}`)}).catch(t=>console.log(t))}}}t("#company_parade_tip").text("阅兵开始"),t("#company_parade_table").length<=0&&(t("#company_parade").after('\n<div id="company_parade_table">\n<table style="margin:auto;background-color:white;font-size:12px;">\n<tr class="head">\n<th>星级</th>\n<th>名称</th>\n<th>老板</th>\n<th>天数</th>\n<th>员工数</th>\n<th title="24h未上线">不活跃</th>\n<th title="入职不到10天">新员工</th>\n<th>日收入</th>\n<th>日单价</th>\n<th>周收入</th>\n<th>周单价</th>\n</tr>\n</table>\n</div>'),t("#company_parade_table").find("th").attr("style","border: 1px solid darkgray;padding: 5px;background-color: black;color: white;font-weight: bold;text-align:center;")),setTimeout(()=>{n(e)},1e3)}),t("#company_parade_stop_btn").click(function(){a=!1})}}}}console.log("冰蛙启动完毕")}function getVersion(){const t={"3.4.12":{date:"2025.06.26",notes:["修复: crime chain 计算错误 by toby","修复: bazaar 物品价格识别错误 by toby","删除: bazaar 物品折溢价百分比 by toby"]},"3.4.11":{date:"2025.06.24",notes:["修改: 微调监狱刷新按钮样式 by toby","修复: 公司页面效率表格去除多余的纵向滚动条 by toby","修复: 更新代码压缩工具以修复贷款额度检查 by toby"]},"3.4.10":{date:"2025.06.22",notes:["新增: 犯罪页面 crime chain 统计 by kaeru","新增: 住宅及公司页面快捷取钱按钮 by toby","新增: 监狱页面刷新按钮 by toby","修改: 取钱助手 (高亮可取钱人员) 改为支持 Chat 3.0, 不再支持 Chat 2.0 by toby","修复: 帮派详情页输入帮派 ID 合法性检查 by toby",'删除: 配置项"犯罪助手"及犯罪 SFC 概率显示 by toby']},"3.4.9":{date:"2025.06.17",notes:["新增: 取钱下拉框默认将自己置顶 by toby","修复: 取钱时贷款额度检查 by toby","修复: 取钱界面帮派存款摘要 by toby","修复: 使取钱按钮在住院时可点击 by toby","删除: 赛车页面不知道是什么但现在肯定已失效的功能 by toby"]},"3.4.8":{date:"2025.06.04",notes:["修复: bust 成功率 by toby","修复: 快捷取钱金额按钮 by toby","修复: 聊天窗口快捷取钱按钮可被选中的问题 by toby","修复: 聊天快捷取钱按钮在取钱页面无效的问题 by toby","删除: 取钱界面玩家搜索下拉框中的余额显示 by toby"]},"3.4.7":{date:"2025.04.26",notes:["修复: 适配 Chat 3.0 by toby","修复: 毒瘾分析中错误处理公司特技的问题 by toby","修复: 飞行无云 by toby","修复: 飞行中隐藏起飞吃药提醒 by toby","删除: 顶部快捷链接中的中文 Wiki by toby"]},"3.4.6":{date:"2025.03.17",notes:["新功能: 攻击界面友军警告 by toby","修复: profile 不显示蛙蛙探测器的问题 by SoftRabbit","修复: 起飞界面 drug 和 OC 提醒 by toby","删除: 调账 event 变化金额 by toby"]},"3.4.5":{date:"2025.01.06",notes:["新功能: 不住院时也启动护士建议 (可在设置中开启，默认关闭) by SoftRabbit","修改: 个人页面显示饮料使用，书使用，日均药改为日均xan，背景颜色的更改 by SoftRabbit","修改: 将 Healing Pulse 加入友帮列表 by SoftRabbit","修复: 护士建议设置关闭在帮派军械库不起效的问题 by SoftRabbit","修复: 健身房助手抓不到当前BS的问题 by SoftRabbit","修复: 更新页面顶部市场链接 by toby","修复: 重写市场快捷链接 by toby"]},"3.4.4":{date:"2024.11.27",notes:["修改: 优化冰蛙战力估算（对50mcap取消日前后分段、按新旧锻炼公式分别计算）by bingri"]},"3.4.3":{date:"2024.09.07",notes:["修复: 公司详情在有员工未指定职位时无法显示的问题 by toby","修复: PDA 上预估战力时的卡顿 by toby","修复: 预估战力数值溢出错误 by toby","修复: 健身房实际系数错误 by toby","修复: 冰蛙版本记录中日期停留在 2023 年的错误 by toby"]},"3.4.2":{date:"2024.08.17",notes:["修复: 优化冰蛙战力估算（取消50m cap的新锻炼公式 + se主要吃一维）by bingri","修改: 监狱界面显示当日 bust 人数 (TCT 零点开始) by kaeru","修复: 修复查看 API 中部分字段在手机上显示不全的问题 by toby","修改: 更新查看 API 中的字段列表 by toby","修改: 删除设置中的聊天快捷取钱选项并总是启用该功能 by toby","修改: 保存所有聊天窗口中的最近聊天记录 (之前版本会忽略 1 天内无新消息的对话) by toby","修改: 帮派武器库中注明外帮公共装备 by toby","修改: 更新市场快捷链接中 Colina Tanprice 的名称 by toby","修改: 将 Hermit Sage 加入友帮列表 by toby"]},"3.4.1":{date:"2024.06.10",notes:["修改: 在市场入口也显示山贼助手 by toby"]},"3.4.0":{date:"2024.06.10",notes:["新功能: 允许编辑市场物品关注列表 by toby","新功能: 默认缓存蛙蛙探测结果30秒，可在设置中禁用 by toby","修复: 山贼助手缓存因 API 变化导致的错误 by toby","修复: 山贼助手在当前物品无人出售时的显示错误 by toby"]},"3.3.8":{date:"2024.05.19",notes:["新功能: 显示帮派仓库中的共享装备 by toby","修复: 删除对 torn.com 脚本的依赖，改为使用 cdnjs by toby","修复: 最近聊天记录时间戳识别错误 by toby"]},"3.3.7":{date:"2024.01.26",notes:["修复: 跨域请求(加载帮派贷款)在新版 PDA 上的错误 by toby"]},"3.3.6":{date:"2023.12.19",notes:["修复: 聊天快捷取钱及时间戳 by toby","修复: 最近聊天记录 by toby","删除: 插件中心 by toby","删除: 复活助手功能 by toby"]},"3.3.5":{date:"2023.11.26",notes:["修复: RW 墙上敌人 bs 显示 by toby","修改: 添加聊天时间戳距离现在的时间差 by toby","修改: 加载贷款额度失败时显示失败原因 by toby","修改: 更新帮派贷款相关的跨域 URL by toby"]},"3.3.4":{date:"2023.11.05",notes:["修复: 聊天取钱玩家名称识别错误 by toby","修复: 最近聊天时间戳 by toby"]},"3.3.3":{date:"2023.10.23",notes:["修复: 聊天快捷取钱适配新聊天 by toby","修复: 取钱助手适配新聊天 by toby","修复: 聊天记录适配新聊天 by toby","修复: 高级搜索界面的上次聊天时间戳 by toby","删除: 聊天时间戳 by toby"]},"3.3.2":{date:"2023.10.20",notes:["修复: 帮派取钱界面 by toby","修改: 提高毒瘾分析的计算精度 by toby"]},"3.3.1":{date:"2023.09.23",notes:["修复: 系统商店买不了啤酒的问题 by toby","修复: 市场快捷搜索中饮料箱的名称 by toby","修复: 快捷取钱全取按钮对贷款额度的处理 by toby","修复: 第一个犯罪百分比的显示问题 by toby","修改: 在脚本结尾添加一行标志结束的注释 by toby"]},"3.3.0":{date:"2023.08.13",notes:["重要改动: 基于安全方面的考虑，删除插件中心的自动安装功能，之前自动安装的插件需重新手工安装 by toby","新功能: 显示调账 event 变化金额 by toby","修复: 市场中武器防具的 bazaar 价格显示错误的问题 by toby","修复: 起飞前提醒 by toby","修复: 将锻炼比例选项挪回健身房列表下方 by toby","修改: 飞花过滤由白名单改为黑名单，以避免过滤新增物品 by toby","修改: 添加手工检查贷款按钮以绕过贷款检查 by toby","删除: 犯罪经验 by toby"]},"3.2.3":{date:"2023.07.16",notes:["新功能: 取钱时检查贷款额度 by toby","修复: Firefox 上的跨域请求 by toby","修改: raid 墙上也显示 bs by toby"]},"3.2.2":{date:"2023.07.13",notes:["修复: 小护士智能提醒出院吃药 by toby","修改: 海外市场不再屏蔽墨西哥酒和中国crime道具 by toby","修改: 快捷取钱无需金额也会显示按钮（例如全取）by toby","修改: 地盘战显示最快攻陷时间 by toby","修改: 适配工作信息相关的 API 更新 by toby"]},"3.2.1":{date:"2023.06.24",notes:["新功能: 犯罪助手 - 显示成功率最高的选项的百分比，需要手动在设置中打开 by toby","修复: 护士建议住院时间取整问题 by toby","修改: 蛙蛙探测勉强支持 crime 2.0 by toby","修改: 估算地盘战的最少进攻人数和最少防守时间 by toby","修改: 计划删除犯罪经验估算功能 by toby","修改: 隐藏并计划删除蛙蛙探测中的估算 NNB by toby"]},"3.2.0":{date:"2023.06.18",notes:["修复: 悬赏阅兵 by toby","修复: 修复自定义取钱快捷方式 by toby","修改: 帮派详情页重排各列顺序 by toby","修改: 帮派详情页重新读取时保留排序方式 by toby","修改: 快捷取钱中避免在住院时调账 by toby","修改: 快捷取钱支持英文关键字 withdraw by toby","修改: 犯罪经验中 nnb < 50 时不再计算预估升级天数 by toby"]},"3.1.11":{date:"2023.05.16",notes:["新功能: 设置中添加侧边栏冰蛙图标的开关 by kaeru","新功能: 新增快速 bail by toby","修复: 同时开启冰蛙和 TT 的快速 bust 时可以正常工作了 by toby","修复: 修复取钱助手(右下角people框)可取钱名单不全的问题 by toby","修改: 将 Bright Summit 加入友帮列表 by toby","修改: 简化攻击界面目标状态相关代码 by toby","修改: 更新冰蛙菜单查看 API 中的选项列表 by toby"]},"3.1.10":{date:"2023.03.19",notes:["修复: 修复起飞时 OC 提醒按钮点击无效的问题 by toby","修改: 犯罪经验中忽略 merit 重置导致的 nnb 变化 by toby"]},"3.1.9":{date:"2023.02.19",notes:["修复: 适配 PDA 2.9.5 (建议 PDA 用户在 START/END 中选择 START) by toby","修改: 毒瘾分析中正确处理拉满的戒毒记录 by toby","修改: 未设置 API Key 时不再自动跳转 by toby","修改: PDA 不再需要手工修改 @match 部分 by toby"]},"3.1.8":{date:"2023.02.15",notes:["新功能: 毒瘾分析 by toby","新功能: 增加起飞前 OC 弹窗提醒 by toby","修复: 在 API 超时或返回临时错误时重试 by toby","修改: 墙上敌人 bs 优先使用冰娃目标缓存数据 by toby","修改: 删除世界局势和近期RW功能 by toby","修改: 使聊天窗口时间戳和快捷取钱按钮不可选中 by toby"]},"3.1.7":{date:"2022.10.28",notes:["新功能: attack页面右侧显示RW武器技能描述 by htys","修复: 修复最近攻击功能的错误，并且设为默认不开启，需要在设置中手动开启 by htys","修复: 修复attack页面玩家名字英文大写被改成小写的错误 by htys","修改: 聊天记录被保存时间从5秒减少到1秒 by htys","修改: 取消最近唠嗑的阅兵需求，并可以在手机上显示了 by htys","修改: 修改了部分页面的颜色显示，使其在dark mode下更加和谐 by htys"]},"3.1.6":{date:"2022.10.23",notes:["新功能: 帮派chain页面额外显示更多5分钟内攻击记录(减少错过的复仇) by htys","新功能: 帮派取钱页面在更加明显的位置显示收款人余额 by htys"]},"3.1.5":{date:"2022.10.22",notes:["修复: 取钱快捷方式和帮派聊天快速取钱 by htys","修复: 冰蛙目标页面可以长按显示mini profile了 by htys","修复: PDA可以使用冰蛙目标了(只能导入csv格式) by htys"]},"3.1.4":{date:"2022.10.20",notes:["修复: 冰蛙主页面宽度现在可以适配手机了 by htys","修复: attack界面血量百分比，手机上出现攻守双方名字相同的bug by htys","修改: 修改冰蛙目标栏目顺序以更加适合手机上输出 by htys"]},"3.1.3":{date:"2022.10.20",notes:["新功能: mini profile界面新增攻击按钮 by htys","新功能: attack界面显示敌我双方血量百分比(斩杀武器技能可能有用) by htys","修复: 冰蛙主界面位置偏左的问题 by htys","修改: 优化手机模式下APIKEY选取界面UI by htys","修改: attack界面取消chain显示，将刷新按钮移动到原来显示chain的位置 by htys"]},"3.1.2":{date:"2022.10.11",notes:["修复: 在脚本头部引用了jQuery插件库以解决bust菜单无法使用的问题 by toby"]},"3.1.1":{date:"2022.10.11",notes:["修复: Update regex of bust perks by toby","修复: 在脚本头部引用了jQuery库以解决油猴更新后冰蛙无法使用的问题 by htys","修复: 更新了perks的正则匹配以解决小护士的显示问题 by htys","修改: 缩小了mini profile界面BS显示的区域以避免在手机模式下遮挡重要信息 by htys"]},"3.1.0":{date:"2022.09.23",notes:["修复: Fix bust filter not hiding targets with zero probability by toby","修改: 优化APIKEY选取界面UI by htys","修改: 优化mini profile界面额外信息UI by htys","修改: 地盘战显示墙上BS - 可以显示友方和第三方BS了 by htys","修改: 地盘战显示预估结束时间 by htys"]},"3.0.9":{date:"2022.09.21",notes:["修复: 修复犯罪经验计算中 NNB 升降时间识别问题 by toby","修复: Match API responses case-insensitively by toby","修复: 友邦列表新增 SMTH - Concord by htys"]},"3.0.8":{date:"2022.08.11",notes:["修复: 无论在城里还是在飞行，看别人的公司页面都输出员工状态表"]},"3.0.7":{date:"2022.08.09",notes:["修复: 修复监狱助手与新版 TornPDA 的冲突 by toby"]},"3.0.6":{date:"2022.07.10",notes:["修改: 冰蛙目标 - 重写部分内容以改善页面卡顿 by htys","修改: 冰蛙目标 - 住院时间更新频率为每秒一次 by htys","修改: 冰蛙目标 - 当有多个冰蛙目标页面打开时，最多只允许一个页面正常刷新 by htys"]},"3.0.5":{date:"2022.07.01",notes:["新功能: 监狱bust - 完全重做并新增估算bust成功率 by toby","新功能: gym页面 - 界面微调并新增检测何时可吃SE by htys"]},"3.0.4":{date:"2022.06.23",notes:["新功能: 冰蛙目标 - 加入过滤功能 by htys","修改: 冰蛙目标 - 当cdn不可用时增加了错误提示 by htys","修改: 从友方帮派中移除LND by htys"]},"3.0.3":{date:"2022.06.10",notes:["新功能: 聊天记录(代替抢劫历史) by htys","新功能: 帮派详情 - 新增显示能否被复活(需要阅兵) by htys","修改: 犯罪经验 - 修正犯罪惩罚公式 by toby","修改: 犯罪经验 - 删除犯罪经验的保存数据按钮 by toby","修改: 插件中心添加对PDA 2.8.0的支持 by mirror","修改: 聊天时间戳外观微调 by htys","修复: 修复最后唠嗑时间不显示的问题 by microdust"]},"3.0.2":{date:"2022.05.13",notes:["新功能: 插件中心 by mirror","新功能: 查询bust惩罚 by toby","修改: 犯罪经验 - 日志页面增加导出按钮 by toby","修改: 犯罪经验 - 增加犯罪经验数据收集说明 by toby","修改: 冰蛙目标支持导入csv格式文件 by microdust","修复: gym页面加成数字不显示的问题 by htys","修复: home页面perks显示错位的问题 by htys","修复: market search页面有时会不显示bazaar的问题 by htys"]},"3.0.1":{date:"2022.04.29",notes:["修改: 公司效率估算公式 by microdust","修改: 聊天框取钱跳转优化 by mirror","修改: 放宽对 NNB 升降级事件的时间要求 by toby","修复: 阅兵 by mirror","修复: 替换空值合并运算符 by toby"]},"3.0.0":{date:"2022.04.07",notes:["新功能: 犯罪经验 by toby"]},"2.9.9":{date:"2022.04.05",notes:["新功能: 灵活配置快捷取钱按钮 by mirror","新功能: 聊天栏添加取钱按钮 by mirror","修改: 公司数据拉取时机 by mirror","修复: 修复在高级搜索界面时，打开honerbar的时候上次唠嗑不显示的问题 by mirror"]},"2.9.8":{date:"2022.03.31",notes:["修改: 冰蛙目标页面 - 添加bs提示","修改: 友好帮派增加pta新帮","修复: 唠嗑时间在转换时区时有多余空格的bug"]},"2.9.7":{date:"2022.02.27",notes:["新功能: attack页面 - 显示chain进度，防止bonus打偏","修改: 公司页面 - 新增效率估算","修改: 冰蛙目标页面 - 若出院时间小于10分钟，则根据出院时间逐渐降低背景色透明度","修改: 搜索页面 - 若与目标超过35天未有聊天行为，则最近唠嗑显示为灰色","修复: 无法阅兵的bug"]},"2.9.6":{date:"2022.02.22",notes:["新功能: profile页面和mini profile页面显示血条"]},"2.9.5":{date:"2022.02.15",notes:["新功能: 冰蛙目标，自动刷新的目标监视利器","新功能: 帮派详情增加level和id显示","修复: 小护士调整小数保留位数"]},"2.9.4":{date:"2022.01.24",notes:["修复: 部分顶部链接","修复: miniBS显示位置","修复: PTA取钱功能","修复: 帮派页面显示阅兵、BS、离线时间和住院时间，取消排序功能"]},"2.9.3":{date:"2022.01.08",notes:["新功能：近期RW显示服务器近期RW的记录"]},"2.9.2":{date:"2022.01.04",notes:["新功能：帮派取钱现在在更加明显的位置提示余额，并且新增加了全取按钮","新功能：侧边栏现在有冰蛙图标了","修复：修复了飞行时读取不到自己id导致的公司页面无法显示问题","修复：帮派详情页面增加了显示内容（帮派图标和rank等级）"]},"2.9.1":{date:"2021.12.30",notes:["修复：修正了某些API的匹配格式，使得小护士可以正常运行","修复：更新了profile页面的攻击链接，现在玩家在医院可以读取完整的战斗页面了","修复：为一部分表格增加横向拖动条，使其在超出手机屏幕宽度时也可以显示完整内容（感谢Woohoo）","修复：微调了profile页面BS显示相关内容"]},"2.9.0":{date:"2021.12.28",notes:["新功能：小护士现在可以分别按照【出院模式】和【满血模式】提供建议","新功能：profile页面新增估算WS","新功能：针对公司老板新增显示公司货物库存","修复：修复了mini profile上估算bs重复显示的问题","修复：修复了小护士有时获取不到住院时间的问题","修复：修复了帮派余额和准备金率显示错误的问题","修复：profile连续活跃天数重新修改为冰蛙活跃天数","修复：修改了某些配色以解决深色模式下看不清的问题","修复：现在飞行无云功能不再显示飞机图片了","修复：针对非东8区用户修改了唠嗑时间显示不正确的问题","修复：更新了key->info和rankedwarreport等API条目"]},"2.8.9":{date:"2021.12.09",notes:["新功能：自己帮派的Ranked War界面会显示敌人bs(需提前对该帮派阅兵)，并且可以按bs排序","修复：小护士读取不到API时的报错","修复：faction和company重绘读取不到API时的报错"]},"2.8.8":{date:"2021.11.24",notes:["修复：使用API重绘faction和company页面时匹配不同url","修复：一个神奇的bug"]},"2.8.7":{date:"2021.11.23",notes:["新功能：在个人profile页面显示上次聊天时间和上次mug时间金额","新功能：在高级搜索页面显示上次聊天时间"]},"2.8.6":{date:"2021.11.19",notes:["新功能：mini profile显示冰蛙估算战力","新功能：帮派仓库增加快捷取钱按钮","修改：使用帮派药品出院时也可以获得小护士建议了"]},"2.8.5":{date:"2021.11.08",notes:["新功能：战斗页面增加显示目标在线状态","修改：冰蛙APIKey读取页面UI","修改：阅兵可以按bazaar金额筛选目标，增加bazaar链接","修改：在飞行入院或入狱时也可以在company.php页面查看效率表格了"]},"2.8.4":{date:"2021.11.01",notes:["新功能：战斗页面增加量化显示stealth隐身概率","新功能：item页面增加小护士智能出院建议","新功能：在自己帮派的战斗中，会显示墙上敌人的bs(需提前对该帮派阅兵)","修复PDA会重复载入冰蛙的bug(感谢Woohoo-)"]},"2.8.3.1":{date:"2021.10.25",notes:["公司管理中增加显示本周销售额（实时数据）和近一周利润（缓存数据）","公司管理表格改为显示到公司页面的下方"]},"2.8.3":{date:"2021.10.23",notes:["起飞页面增加吃药cd和oc提醒功能","bounty页面增加自动阅兵功能，默认关闭需在设置中手动开启","个人页面的冰蛙检测增加显示活跃天数，删除ECS数量","在个人页面enemy数量右侧增加显示坏比指数","points市场目标提示现在可以显示新人和衣服店了"]},"2.8.2":{date:"2021.10.08",notes:["启用更精确的计算监狱分数公式并且显示分数提高到25000","修复阅兵bug"]},"2.8.1":{date:"2021.09.30",notes:["取消大乱斗功能","取消oc提醒功能"]},"2.8.0":{date:"2021.09.11",notes:["新增大乱斗阅兵","优化了大乱斗界面"]},"2.7.9":{date:"2021.09.09",notes:["新增了API条目","更新了顶部快捷链接","阅兵可以显示大乱斗所在队伍","在海外也可以查看大乱斗"]},"2.7.8":{date:"2021.08.18",notes:["阅兵可以显示目标bazaar内全部物品价值总和"]},"2.7.7":{date:"2021.06.20",notes:["公司排行页面可以进行公司阅兵了","增加新的快捷打劫链接","不再显示已售空的额外的bazaar","buymug时加入自己人防误伤提醒","OC即将开始时进入飞行界面将获得更加明显的提示","隐藏laptop边框","飞行时不显示云和飞机"]},"2.7.6":{date:"2021.05.29",notes:["不是老板也能查看我的公司表格了","新增帮派取钱助手"]},"2.7.5.2":{date:"2021.05.29",notes:["聊天框时间戳不显示秒","Jail界面增加显示更多按钮","海外库存界面增加显示更多按钮"]},"2.7.5.1":{date:"2021.05.27",notes:["修复聊天框时间戳"]},"2.7.5":{date:"2021.04.12",notes:["顶部链接、健身房、赛车界面UI微调"]},"2.7.4":{date:"2021.04.01",notes:["飞行时查看的公司页面增加TV和油厂的单价估算"]},"2.7.3":{date:"2021.03.30",notes:["我的公司页面UI微调"]},"2.7.2":{date:"2021.03.23",notes:["添加顶部链接和健身房的开关","在股票交易市场页面显示股票缩写"]},"2.7.1":{date:"2021.03.10",notes:["我的公司页面新增显示各员工工资和当前公司实时数据，修复保存31天显示32天的bug","飞行中的帮派信息页区分显示正在被突击和主动突击别人"]},"2.7.0":{date:"2021.02.14",notes:["修改imarket search页面，增加显示目标bazaar内全部物品价值总和","新增功能复活助手"]},"2.6.9":{date:"2021.02.11",notes:["帮派对比功能重做以显示更多数据","加入更多设置选项","index页面加入一键显示全部perks"]},"2.6.8":{date:"2021.02.02",notes:["新增世界局势功能，显示所有正在进行的地盘战，按战况激烈程度染色"]},"2.6.7":{date:"2021.01.24",notes:["在飞行/医院/监狱中也可以查看自己/他人Bazaar中物品"]},"2.6.6.3":{date:"2021.01.22",notes:["解决gym页面与torntools兼容问题"]},"2.6.6.2":{date:"2021.01.19",notes:["修改一些可能存在的bug","Gym页面提供Hank和Baldr属性比例参考","监视列表可以自由添加玩家ID，被监视的目标在海外被高亮（橙色）显示"]},"2.6.6.1":{date:"2021.01.19",notes:["查看个人profile页面的Last action显示为x天x时x分x秒"]},"2.6.6":{date:"2021.01.14",notes:["我的公司及飞行中看帮派、公司功能汉化。","飞行中看帮派信息增加chain、地盘战、raid战的信息。","产量数据支持多种库存的公司。"]},"2.6.5.1":{date:"2021.01.13",notes:["对使用过【我的公司】功能的，每天进游戏时自动检查抓取昨晚的公司运营数据。"]},"2.6.5":{date:"2021.01.11",notes:["公司效率表格微调：增加inactivy，调整列顺序","新增公司历史数据表格","飞行时也能看帮派和公司页面"]},"2.6.4.1":{date:"2021.01.05",notes:["优化公司效率表格显示，并且海外可查看"]},"2.6.4":{date:"2021.01.04",notes:["公司页面显示效率表格","聊天框显示时间戳"]},"2.6.3":{date:"2020.12.28",notes:["顶部增加简易导航条，从api.torn.com更新了API条目","优化阅兵功能，增加暂停和继续按钮","优化帮派对比功能，增加历史记录和高亮显示leader","增加抢劫历史功能，可以从历史记录中选择目标加入监视列表"]},"2.6.2":{date:"2020.11.11",notes:["修复顶部链接导致页面排版错乱的问题","payday功能只向leader和coleader提供"]},"2.6.1":{date:"2020.10.22",notes:["美化排版：pmarket、imarket(search)、imarket页面在显示bs时不再影响原始布局","市场显示超过3个bazaar：imarket(search)页面显示bazaar数量不再局限于3个","bazaar页面简易计算器：可以通过点击选中物品，页面顶部显示选中物品的总价值"]},"2.6.0":{date:"2020.09.28",notes:["itemmarket/pointmarket/bazaar界面增加3个mug相关脚本（感谢Mirror），使用mugoo=true开启","revivehelper重命名为facPageEnhanced，显示内容优化，使用foo=true开启","阅兵模块优化，增加阅兵内容选项，所有阅兵相关功能都使用foo=true开启","监狱置顶标记友帮成员，无视分数","海外people界面用颜色标记友帮和敌帮成员"]},"2.5.9":{date:"2020.09.16",notes:["修复飞花增强功能失效的bug"]},"2.5.8":{date:"2020.11.11",notes:["回滚上版本第一条，因为networth会变化，持续7天才触发rank","蛙蛙探测显示更多页面里的锻炼总能量换成Booster数量"]},"2.5.7":{date:"2020.08.14",notes:["当rank反推的bs上限低于估算值时，忽略估算值，使用rank反推的上下限区间","修复蛙蛙探测显示更多页面排版问题","帮派页面Revive增强功能默认关闭，需要时请将代码头部 reviveHelper 设为 true 手动开启"]},"2.5.6":{date:"2020.08.01",notes:["飞行中也可以方便的查看帮派成员状态，以及支持包括自己帮在内的最多3个帮派横向对比"]},"2.5.5.1":{date:"2020.07.30",notes:["修复一些取款小bug，给自己取款时，输入.或者?(英文标点)可自动替换为本人名字，减少输入时间"]},"2.5.5":{date:"2020.07.30",notes:["屏蔽全取按钮，选择取款目标时显示目标额度"]},"2.5.4":{date:"2020.07.27",notes:["增加帮派成员界面一系列功能：阅兵，显示bs、上次登录时间、旅行状态和住院时间，高亮标记住院成员，排序等"]},"2.5.3":{date:"2020.07.07",notes:["增加防打重功能，开关noAssisting = true"]},"2.5.2":{date:"2020.06.17",notes:["修复顶部链接导致页面排版错乱的问题"]},"2.5.1":{date:"2020.06.15",notes:["修复阅兵转换为csv有时丢失某些列的问题"]},"2.5.0":{date:"2020.06.05",notes:["搜索及海外用户列表阅兵功能优化：过滤5b以下，显示mugged, rehabcost, rank, job"]},"2.4.9":{date:"2020.06.05",notes:["飞行中也可以方便的查看帮派成员状态，以及支持包括自己帮在内的最多3个帮派横向对比"]},"2.4.8":{date:"2020.06.04",notes:["jailview 按 jailscore 排序，并优化体验","更新看库存的链接","用户搜索页面增加阅兵功能"]},"2.4.7":{date:"2020.04.26",notes:["左上角菜单中新增常用链接：市场","jailview页面增强：显示各目标的 分钟数*级别；过滤大于1万的；bust不需要二次确认（类似DN的quick bust功能）"]},"2.4.6":{date:"2020.04.26",notes:["左上角菜单中新增常用链接：赛车/啤酒/飞行/库存"]}};let e="",n=0,a="",o=0;for(let i in t)if(o<10){a+=t[i].date+" --v"+i+"\n";for(let e=0;e<t[i].notes.length;e++)a+="    "+t[i].notes[e]+"\n";a+="\n";let r=i.split(".");r.splice(1,0,"."),r.join("");const s=parseFloat(r);s>n&&(n=s,e=i),o++}return[e,a]}"loading"===document.readyState?document.addEventListener("readystatechange",()=>{"interactive"===document.readyState&&bingwaMain()}):bingwaMain();
/* 冰蛙宝鉴到此结束 */
